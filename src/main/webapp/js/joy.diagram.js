/*! by joyone.cn 厦门展网信息技术有限公司  joyone 2015-04-30  1.0.20 */
!function(a,b){function c(a){var b=a.originalEvent,c=0;return b.wheelDelta?(c=-b.wheelDelta/40,c=c>0?e.ceil(c):e.floor(c)):b.detail&&(c=b.detail),c}var d=a.extend,e=Math;d(a.fn,{mousewheel:function(a,b){var e=d({ns:""},b||{}),f=this,g="DOMMouseScroll"+e.ns+" mousewheel"+e.ns;return f.on(g,function(b){b.data={delta:c(b)},a(b)}),f}})}(window.joy.jQuery),function(a,b){function c(a,b,c){function d(a){for(var b=1;a*b%1;)b*=10;return b}if("undefined"==typeof a||"undefined"==typeof b)return[];if(c&&j.sign(b-a)!=j.sign(c))throw"The sign of the increment should allow to reach the stop-value.";if(c=c||1,a=a||0,b=b||a,(b-a)/c===1/0)throw"Infinite range defined.";var e,f=[],g=-1,h=d(Math.abs(c));if(a*=h,b*=h,c*=h,a>b&&c>0&&(c=-c),0>c)for(;(e=a+c*++g)>=b;)f.push(e/h);else for(;(e=a+c*++g)<=b;)f.push(e/h);return f}function d(a,b){if(a==b)return 0;var c=b.x-a.x,d=a.y-b.y,e=Math.atan(c/d);return d>=0?0>c?e+2*Math.PI:e:e+Math.PI}var e=window.joy,f=e.dataviz.diagram={},g=(e.Class,e.deepExtend),h=a.isArray,i=1e-6,j={};g(j,{isNearZero:function(a){return Math.abs(a)<i},isDefined:function(a){return"undefined"!=typeof a},isUndefined:function(a){return"undefined"==typeof a||null===a},isObject:function(a){return a===Object(a)},has:function(a,b){return Object.hasOwnProperty.call(a,b)},isString:function(a){return"[object String]"==Object.prototype.toString.call(a)},isBoolean:function(a){return"[object Boolean]"==Object.prototype.toString.call(a)},isType:function(a,b){return Object.prototype.toString.call(a)=="[object "+b+"]"},isNumber:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},isEmpty:function(a){if(null===a)return!0;if(h(a)||j.isString(a))return 0===a.length;for(var b in a)if(j.has(a,b))return!1;return!0},simpleExtend:function(a,b){if(j.isObject(b))for(var c in b)a[c]=b[c]},initArray:function(a,b){for(var c=[],d=0;a>d;++d)c[d]=b;return c},serializePoints:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];b.push(d.x+";"+d.y)}return b.join(";")},deserializePoints:function(a){var b=a.split(";"),c=[];if(b.length%2!==0)throw"Not an array of points.";for(var d=0;d<b.length;d+=2)c.push(new f.Point(parseInt(b[d],10),parseInt(b[d+1],10)));return c},randomInteger:function(a,b){return parseInt(Math.floor(Math.random()*b)+a,10)},DFT:function(a,b){if(b(a),a.childNodes)for(var c=0;c<a.childNodes.length;c++){var d=a.childNodes[c];this.DFT(d,b)}},getMatrixAngle:function(a){return null===a||0===a.d?0:180*Math.atan2(a.b,a.d)/Math.PI},getMatrixScaling:function(a){var b=Math.sqrt(a.a*a.a+a.c*a.c),c=Math.sqrt(a.b*a.b+a.d*a.d);return[b,c]}}),j.sign=function(a){return a?0>a?-1:1:0},j.findAngle=function(a,b){return 180*d(a,b)/Math.PI},j.forEach=function(a,b,c){for(var d=0;d<a.length;d++)b.call(c,a[d],d,a)},j.any=function(a,b){for(var c=0;c<a.length;++c)if(b(a[c]))return a[c];return null},j.remove=function(a,b){for(var c;-1!==(c=j.indexOf(a,b));)a.splice(c,1);return a},j.contains=function(a,b){return-1!==j.indexOf(a,b)},j.indexOf=function(b,c){return a.inArray(c,b)},j.fold=function(a,b,c,d){for(var e=arguments.length>2,f=0;f<a.length;f++){var g=a[f];e?c=b.call(d,c,g,f,a):(c=g,e=!0)}if(!e)throw"Reduce of empty array with no initial value";return c},j.find=function(a,b,c){var d;return j.any(a,function(a,e,f){return b.call(c,a,e,f)?(d=a,!0):!1}),d},j.first=function(a,b,c){return 0===a.length?null:j.isUndefined(b)?a[0]:j.find(a,b,c)},j.insert=function(a,b,c){return a.splice(c,0,b),a},j.all=function(a,b,c){for(var d,e=!0,f=0;f<a.length&&(d=a[f],e=e&&b.call(c,d,f,a),e);f++);return e},j.clear=function(a){a.splice(0,a.length)},j.bisort=function(a,b,c){if(j.isUndefined(a))throw"First array is not specified.";if(j.isUndefined(b))throw"Second array is not specified.";if(a.length!=b.length)throw"The two arrays should have equal length";var d,e=[];for(d=0;d<a.length;d++)e.push({x:a[d],y:b[d]});for(e.sort(j.isUndefined(c)?function(a,b){return a.x-b.x}:function(a,b){return c(a.x,b.x)}),j.clear(a),j.clear(b),d=0;d<e.length;d++)a.push(e[d].x),b.push(e[d].y)},j.addRange=function(a,b){a.push.apply(a,b)};var k={easeInOut:function(a){return-Math.cos(a*Math.PI)/2+.5}},l=e.Class.extend({init:function(){this.adapters=[],this.target=0,this.tick=0,this.interval=20,this.duration=800,this.lastTime=null,this.handlers=[];var a=this;this.transition=k.easeInOut,this.timerDelegate=function(){a.onTimerEvent()}},addAdapter:function(a){this.adapters.push(a)},onComplete:function(a){this.handlers.push(a)},removeHandler:function(b){this.handlers=a.grep(this.handlers,function(a){return a!==b})},trigger:function(){var a=this;this.handlers&&j.forEach(this.handlers,function(b){return b.call(null!==a.caller?a.caller:a)})},onStep:function(){},seekTo:function(a){this.seekFromTo(this.tick,a)},seekFromTo:function(a,b){this.target=Math.max(0,Math.min(1,b)),this.tick=Math.max(0,Math.min(1,a)),this.lastTime=(new Date).getTime(),this.intervalId||(this.intervalId=window.setInterval(this.timerDelegate,this.interval))},stop:function(){this.intervalId&&(window.clearInterval(this.intervalId),this.intervalId=null,this.trigger())},play:function(a){0!==this.adapters.length&&(null!==a&&(this.caller=a),this.initState(),this.seekFromTo(0,1))},reverse:function(){this.seekFromTo(1,0)},initState:function(){if(0!==this.adapters.length)for(var a=0;a<this.adapters.length;a++)this.adapters[a].initState()},propagate:function(){for(var a=this.transition(this.tick),b=0;b<this.adapters.length;b++)this.adapters[b].update(a)},onTimerEvent:function(){var a=(new Date).getTime(),b=a-this.lastTime;this.lastTime=a;var c=b/this.duration*(this.tick<this.target?1:-1);Math.abs(c)>=Math.abs(this.tick-this.target)?this.tick=this.target:this.tick+=c;try{this.propagate()}finally{this.onStep.call(this),this.target==this.tick&&this.stop()}}});e.deepExtend(f,{init:function(a){e.init(a,f.ui)},Utils:j,Range:c,Ticker:l})}(window.joy.jQuery),function(a,b){function c(a){return Math.abs(a)<r}function d(a,b,d,e,f){var g=(b.x-a.x)*(e.y-d.y)-(b.y-a.y)*(e.x-d.x);if(!c(g)){var h=(a.y-d.y)*(e.x-d.x)-(a.x-d.x)*(e.y-d.y),i=(a.y-d.y)*(b.x-a.x)-(a.x-d.x)*(b.y-a.y),j=h/g,k=i/g;if(!f||!(0>j||j>1||0>k||k>1))return new m(a.x+j*(b.x-a.x),a.y+j*(b.y-a.y))}}function e(a,b){var c,d,e;do c=2*Math.random()-1,d=2*Math.random()-1,e=c*c+d*d;while(!e||e>1);return a+b*c*Math.sqrt(-2*Math.log(e)/e)}function f(a){l.isUndefined(a)&&(a=10);for(var b="",c="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",d=a;d>0;--d)b+=c[Math.round(Math.random()*(c.length-1))];return b}var g=window.joy,h=g.dataviz.diagram,i=g.Class,j=g.deepExtend,k=g.dataviz,l=h.Utils,m=k.Point2D,n=g.isFunction,o=l.contains,p=a.map,q=3,r=1e-6;j(m.fn,{plus:function(a){return new m(this.x+a.x,this.y+a.y)},minus:function(a){return new m(this.x-a.x,this.y-a.y)},offset:function(a){return new m(this.x-a,this.y-a)},times:function(a){return new m(this.x*a,this.y*a)},normalize:function(){return 0===this.length()?new m:this.times(1/this.length())},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},toString:function(){return"("+this.x+","+this.y+")"},lengthSquared:function(){return this.x*this.x+this.y*this.y},middleOf:function(a,b){return new m(b.x-a.x,b.y-a.y).times(.5).plus(a)},toPolar:function(a){var b=1;a&&(b=180/Math.PI);var c=Math.atan2(Math.abs(this.y),Math.abs(this.x)),d=Math.PI/2,e=this.length();if(0===this.x){if(0===this.y)return new x(0,0);if(this.y>0)return new x(e,b*d);if(this.y<0)return new x(e,3*b*d)}else if(this.x>0){if(0===this.y)return new x(e,0);if(this.y>0)return new x(e,b*c);if(this.y<0)return new x(e,b*(4*d-c))}else{if(0===this.y)return new x(e,2*d);if(this.y>0)return new x(e,b*(2*d-c));if(this.y<0)return new x(e,b*(2*d+c))}},isOnLine:function(a,b){if(a.x>b.x){var c=b;b=a,a=c}var d,e,f=new t(a.x,a.y).inflate(q,q),g=new t(b.x,b.y).inflate(q,q);return f.union(g).contains(this)?a.x===b.x||a.y===b.y?!0:(a.y<b.y?(d=f.x+(g.x-f.x)*(this.y-(f.y+f.height))/(g.y+g.height-(f.y+f.height)),e=f.x+f.width+(g.x+g.width-(f.x+f.width))*(this.y-f.y)/(g.y-f.y)):(d=f.x+(g.x-f.x)*(this.y-f.y)/(g.y-f.y),e=f.x+f.width+(g.x+g.width-(f.x+f.width))*(this.y-(f.y+f.height))/(g.y+g.height-(f.y+f.height))),this.x>d&&this.x<e):!1}}),j(m,{parse:function(a){var b=a.slice(1,a.length-1),c=b.split(","),d=parseInt(c[0],10),e=parseInt(c[1],10);return isNaN(d)||isNaN(e)?void 0:new m(d,e)}});var s=i.extend({init:function(a,b,c){this.point=a,this.left=b,this.right=c}}),t=i.extend({init:function(a,b,c,d){this.x=a||0,this.y=b||0,this.width=c||0,this.height=d||0},contains:function(a){return a.x>=this.x&&a.x<=this.x+this.width&&a.y>=this.y&&a.y<=this.y+this.height},inflate:function(a,c){return c===b&&(c=a),this.x-=a,this.y-=c,this.width+=2*a+1,this.height+=2*c+1,this},offset:function(a,b){var c=a,d=b;return a instanceof m&&(c=a.x,d=a.y),this.x+=c,this.y+=d,this},union:function(a){var b=Math.min(this.x,a.x),c=Math.min(this.y,a.y),d=Math.max(this.x+this.width,a.x+a.width),e=Math.max(this.y+this.height,a.y+a.height);return new t(b,c,d-b,e-c)},center:function(){return new m(this.x+this.width/2,this.y+this.height/2)},top:function(){return new m(this.x+this.width/2,this.y)},right:function(){return new m(this.x+this.width,this.y+this.height/2)},bottom:function(){return new m(this.x+this.width/2,this.y+this.height)},left:function(){return new m(this.x,this.y+this.height/2)},topLeft:function(){return new m(this.x,this.y)},topRight:function(){return new m(this.x+this.width,this.y)},bottomLeft:function(){return new m(this.x,this.y+this.height)},bottomRight:function(){return new m(this.x+this.width,this.y+this.height)},clone:function(){return new t(this.x,this.y,this.width,this.height)},isEmpty:function(){return!this.width&&!this.height},equals:function(a){return this.x===a.x&&this.y===a.y&&this.width===a.width&&this.height===a.height},rotatedBounds:function(a){var b=this.clone(),c=this.rotatedPoints(a),d=c[0],e=c[1],f=c[2],g=c[3];return b.x=Math.min(f.x,d.x,e.x,g.x),b.y=Math.min(f.y,d.y,e.y,g.y),b.width=Math.max(f.x,d.x,e.x,g.x)-b.x,b.height=Math.max(f.y,d.y,e.y,g.y)-b.y,b},rotatedPoints:function(a){var b=this,c=b.center(),d=b.bottomRight().rotate(c,360-a),e=b.topLeft().rotate(c,360-a),f=b.topRight().rotate(c,360-a),g=b.bottomLeft().rotate(c,360-a);return[e,f,d,g]},toString:function(a){return a=a||" ",this.x+a+this.y+a+this.width+a+this.height},scale:function(a,b,c,d,e){var f=this.topLeft(),g=this.center();f.rotate(g,360-e).rotate(d,e);var h=c.minus(f),i=new m(h.x*a,h.y*b),j=h.minus(i);f=f.plus(j),f.rotate(d,360-e).rotate(g,e),this.x=f.x,this.y=f.y,this.width*=a,this.height*=b}}),u=i.extend({init:function(a,b){this.width=a,this.height=b}});u.prototype.Empty=new u(0,0),t.toRect=function(a){return a instanceof t||(a=new t(a.x,a.y,a.width,a.height)),a},t.empty=function(){return new t(0,0,0,0)},t.fromPoints=function(a,b){if(isNaN(a.x)||isNaN(a.y)||isNaN(b.x)||isNaN(b.y))throw"Some values are NaN.";return new t(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.abs(a.x-b.x),Math.abs(a.y-b.y))};var v={lines:function(a,b,c,e){return d(a,b,c,e)},segments:function(a,b,c,e){return d(a,b,c,e,!0)},rectWithLine:function(a,b,c){return v.segments(b,c,a.topLeft(),a.topRight())||v.segments(b,c,a.topRight(),a.bottomRight())||v.segments(b,c,a.bottomLeft(),a.bottomRight())||v.segments(b,c,a.topLeft(),a.bottomLeft())},rects:function(a,b,c){var d=b.topLeft(),e=b.topRight(),f=b.bottomLeft(),g=b.bottomRight(),h=b.center();c&&(d=d.rotate(h,c),e=e.rotate(h,c),f=f.rotate(h,c),g=g.rotate(h,c));var i=a.contains(d)||a.contains(e)||a.contains(f)||a.contains(g)||v.rectWithLine(a,d,e)||v.rectWithLine(a,d,f)||v.rectWithLine(a,e,g)||v.rectWithLine(a,f,g);if(!i){if(d=a.topLeft(),e=a.topRight(),f=a.bottomLeft(),g=a.bottomRight(),c){var j=360-c;d=d.rotate(h,j),e=e.rotate(h,j),f=f.rotate(h,j),g=g.rotate(h,j)}i=b.contains(d)||b.contains(e)||b.contains(f)||b.contains(g)}return i}},w=i.extend({init:function(a){this.container=t.toRect(a)},align:function(a,b){for(var c=b.toLowerCase().split(" "),d=0;d<c.length;d++)a=this._singleAlign(a,c[d]);return a},_singleAlign:function(a,b){return n(this[b])?this[b](a):a},left:function(a){return this._align(a,this._left)},center:function(a){return this._align(a,this._center)},right:function(a){return this._align(a,this._right)},stretch:function(a){return this._align(a,this._stretch)},top:function(a){return this._align(a,this._top)},middle:function(a){return this._align(a,this._middle)},bottom:function(a){return this._align(a,this._bottom)},_left:function(a,b){b.x=a.x},_center:function(a,b){b.x=(a.width-b.width)/2||0},_right:function(a,b){b.x=a.width-b.width},_top:function(a,b){b.y=a.y},_middle:function(a,b){b.y=(a.height-b.height)/2||0},_bottom:function(a,b){b.y=a.height-b.height},_stretch:function(a,b){b.x=0,b.y=0,b.height=a.height,b.width=a.width},_align:function(a,b){return a=t.toRect(a),b(this.container,a),a}}),x=i.extend({init:function(a,b){this.r=a,this.angle=b}}),y=i.extend({init:function(a,b,c,d,e,f){this.a=a||0,this.b=b||0,this.c=c||0,this.d=d||0,this.e=e||0,this.f=f||0},plus:function(a){this.a+=a.a,this.b+=a.b,this.c+=a.c,this.d+=a.d,this.e+=a.e,this.f+=a.f},minus:function(a){this.a-=a.a,this.b-=a.b,this.c-=a.c,this.d-=a.d,this.e-=a.e,this.f-=a.f},times:function(a){return new y(this.a*a.a+this.c*a.b,this.b*a.a+this.d*a.b,this.a*a.c+this.c*a.d,this.b*a.c+this.d*a.d,this.a*a.e+this.c*a.f+this.e,this.b*a.e+this.d*a.f+this.f)},apply:function(a){return new m(this.a*a.x+this.c*a.y+this.e,this.b*a.x+this.d*a.y+this.f)},applyRect:function(a){return t.fromPoints(this.apply(a.topLeft()),this.apply(a.bottomRight()))},toString:function(){return"matrix("+this.a+" "+this.b+" "+this.c+" "+this.d+" "+this.e+" "+this.f+")"}});j(y,{fromSVGMatrix:function(a){var b=new y;return b.a=a.a,b.b=a.b,b.c=a.c,b.d=a.d,b.e=a.e,b.f=a.f,b},fromMatrixVector:function(a){var b=new y;return b.a=a.a,b.b=a.b,b.c=a.c,b.d=a.d,b.e=a.e,b.f=a.f,b},fromList:function(a){if(6!==a.length)throw"The given list should consist of six elements.";var b=new y;return b.a=a[0],b.b=a[1],b.c=a[2],b.d=a[3],b.e=a[4],b.f=a[5],b},translation:function(a,b){var c=new y;return c.a=1,c.b=0,c.c=0,c.d=1,c.e=a,c.f=b,c},unit:function(){return new y(1,0,0,1,0,0)},rotation:function(a,b,c){var d=new y;return d.a=Math.cos(a*Math.PI/180),d.b=Math.sin(a*Math.PI/180),d.c=-d.b,d.d=d.a,d.e=b-b*d.a+c*d.b||0,d.f=c-c*d.a-b*d.b||0,d},scaling:function(a,b){var c=new y;return c.a=a,c.b=0,c.c=0,c.d=b,c.e=0,c.f=0,c},parse:function(a){var b,c;if(a){if(a=a.trim(),"matrix"===a.slice(0,6).toLowerCase()){if(c=a.slice(7,a.length-1).trim(),b=c.split(","),6===b.length)return y.fromList(p(b,function(a){return parseFloat(a)}));if(b=c.split(" "),6===b.length)return y.fromList(p(b,function(a){return parseFloat(a)}))}if("("===a.slice(0,1)&&")"===a.slice(a.length-1)&&(a=a.substr(1,a.length-1)),a.indexOf(",")>0&&(b=a.split(","),6===b.length))return y.fromList(p(b,function(a){return parseFloat(a)}));if(a.indexOf(" ")>0&&(b=a.split(" "),6===b.length))return y.fromList(p(b,function(a){return parseFloat(a)}))}return b}});var z=i.extend({init:function(a,b,c,d,e,f){this.a=a||0,this.b=b||0,this.c=c||0,this.d=d||0,this.e=e||0,this.f=f||0},fromMatrix:function(a){var b=new z;return b.a=a.a,b.b=a.b,b.c=a.c,b.d=a.d,b.e=a.e,b.f=a.f,b}}),A={_distanceToLineSquared:function(a,b,c){function d(a,b){return(a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y)}if(b===c)return d(a,b);var e=c.x-b.x,f=c.y-b.y,g=(a.x-b.x)*e+(a.y-b.y)*f;return 0>g?d(b,a):(g=(c.x-a.x)*e+(c.y-a.y)*f,0>g?d(c,a):(g=(c.x-a.x)*f-(c.y-a.y)*e,g*g/(e*e+f*f)))},distanceToLine:function(a,b,c){return Math.sqrt(this._distanceToLineSquared(a,b,c))},distanceToPolyline:function(a,b){var c=Number.MAX_VALUE;if(l.isUndefined(b)||0===b.length)return Number.MAX_VALUE;for(var d=0;d<b.length-1;d++){var e=b[d],f=b[d+1],g=this._distanceToLineSquared(a,e,f);c>g&&(c=g)}return Math.sqrt(c)}},B=g.Class.extend({init:function(){this._buckets=[],this.length=0},add:function(a,b){var c=this._createGetBucket(a);return l.isDefined(b)&&(c.value=b),c},get:function(a){return this._bucketExists(a)?this._createGetBucket(a):null},set:function(a,b){this.add(a,b)},containsKey:function(a){return this._bucketExists(a)},remove:function(a){if(this._bucketExists(a)){var b=this._hash(a);return delete this._buckets[b],this.length--,a}},forEach:function(a){for(var b=this._hashes(),c=0,d=b.length;d>c;c++){var e=b[c],f=this._buckets[e];l.isUndefined(f)||a(f)}},clone:function(){for(var a=new B,b=this._hashes(),c=0,d=b.length;d>c;c++){var e=b[c],f=this._buckets[e];l.isUndefined(f)||a.add(f.key,f.value)}return a},_hashes:function(){var a=[];for(var b in this._buckets)this._buckets.hasOwnProperty(b)&&a.push(b);return a},_bucketExists:function(a){var b=this._hash(a);return l.isDefined(this._buckets[b])},_createGetBucket:function(a){var b=this._hash(a),c=this._buckets[b];return l.isUndefined(c)&&(c={key:a},this._buckets[b]=c,this.length++),c},_hash:function(a){if(l.isNumber(a))return a;if(l.isString(a))return this._hashString(a);if(l.isObject(a))return this._objectHashId(a);throw"Unsupported key type."},_hashString:function(a){var b=0;if(0===a.length)return b;for(var c=0;c<a.length;c++){var d=a.charCodeAt(c);b=32*b-b+d}return b},_objectHashId:function(a){var b=a._hashId;return l.isUndefined(b)&&(b=f(),a._hashId=b),b}}),C=g.Observable.extend({init:function(b){var c=this;if(g.Observable.fn.init.call(c),this._hashTable=new B,this.length=0,l.isDefined(b))if(a.isArray(b))for(var d=0;d<b.length;d++)this.add(b[d]);else b.forEach(function(a,b){this.add(a,b)},this)},add:function(a,b){var c=this._hashTable.get(a);c||(c=this._hashTable.add(a),this.length++,this.trigger("changed")),c.value=b},set:function(a,b){this.add(a,b)},get:function(a){var b=this._hashTable.get(a);if(b)return b.value;throw new Error("Cannot find key "+a)},containsKey:function(a){return this._hashTable.containsKey(a)},remove:function(a){return this.containsKey(a)?(this.trigger("changed"),this.length--,this._hashTable.remove(a)):void 0},forEach:function(a,b){this._hashTable.forEach(function(c){a.call(b,c.key,c.value)})},forEachValue:function(a,b){this._hashTable.forEach(function(c){a.call(b,c.value)})},forEachKey:function(a,b){this._hashTable.forEach(function(c){a.call(b,c.key)})},keys:function(){var a=[];return this.forEachKey(function(b){a.push(b)}),a}}),D=g.Class.extend({init:function(){this._tail=null,this._head=null,this.length=0},enqueue:function(a){var b={value:a,next:null};this._head?(this._tail.next=b,this._tail=this._tail.next):(this._head=b,this._tail=this._head),this.length++},dequeue:function(){if(this.length<1)throw new Error("The queue is empty.");var a=this._head.value;return this._head=this._head.next,this.length--,a},contains:function(a){for(var b=this._head;b;){if(b.value===a)return!0;b=b.next}return!1}}),E=g.Observable.extend({init:function(a){var b=this;g.Observable.fn.init.call(b),this._hashTable=new B,this.length=0,l.isDefined(a)&&(a instanceof B?a.forEach(function(a){this.add(a)}):a instanceof C&&a.forEach(function(a,b){this.add({key:a,value:b})},this))},contains:function(a){return this._hashTable.containsKey(a)},add:function(a){var b=this._hashTable.get(a);b||(this._hashTable.add(a,a),this.length++,this.trigger("changed"))},get:function(a){return this.contains(a)?this._hashTable.get(a).value:null},hash:function(a){return this._hashTable._hash(a)},remove:function(a){this.contains(a)&&(this._hashTable.remove(a),this.length--,this.trigger("changed"))},forEach:function(a,b){this._hashTable.forEach(function(b){a(b.value)},b)},toArray:function(){var a=[];return this.forEach(function(b){a.push(b)}),a}}),F=g.Class.extend({init:function(a,b){if(this.links=[],this.outgoing=[],this.incoming=[],this.weight=1,this.id=l.isDefined(a)?a:f(),l.isDefined(b)){this.associatedShape=b;var c=b.bounds();this.width=c.width,this.height=c.height,this.x=c.x,this.y=c.y}else this.associatedShape=null;this.data=null,this.type="Node",this.shortForm="Node '"+this.id+"'",this.isVirtual=!1},isIsolated:function(){return l.isEmpty(this.links)},bounds:function(a){return l.isDefined(a)?(this.x=a.x,this.y=a.y,this.width=a.width,void(this.height=a.height)):new h.Rect(this.x,this.y,this.width,this.height)},isLinkedTo:function(a){var b=this;return l.any(b.links,function(c){return c.getComplement(b)===a})},getChildren:function(){if(0===this.outgoing.length)return[];for(var a=[],b=0,c=this.outgoing.length;c>b;b++){var d=this.outgoing[b];a.push(d.getComplement(this))}return a},getParents:function(){if(0===this.incoming.length)return[];for(var a=[],b=0,c=this.incoming.length;c>b;b++){var d=this.incoming[b];a.push(d.getComplement(this))}return a},clone:function(){var a=new F;return l.isDefined(this.weight)&&(a.weight=this.weight),l.isDefined(this.balance)&&(a.balance=this.balance),l.isDefined(this.owner)&&(a.owner=this.owner),a.associatedShape=this.associatedShape,a.x=this.x,a.y=this.y,a.width=this.width,a.height=this.height,a},adjacentTo:function(a){return null!==this.isLinkedTo(a)},removeLink:function(a){a.source===this&&(l.remove(this.links,a),l.remove(this.outgoing,a),a.source=null),a.target===this&&(l.remove(this.links,a),l.remove(this.incoming,a),a.target=null)},hasLinkTo:function(a){return l.any(this.outgoing,function(b){return b.target===a})},degree:function(){return this.links.length},incidentWith:function(a){return o(this.links,a)},getLinksWith:function(a){return l.all(this.links,function(b){return b.getComplement(this)===a},this)},getNeighbors:function(){var a=[];return l.forEach(this.incoming,function(b){a.push(b.getComplement(this))},this),l.forEach(this.outgoing,function(b){a.push(b.getComplement(this))},this),a}}),G=g.Class.extend({init:function(a,b,c,d){if(l.isUndefined(a))throw"The source of the new link is not set.";if(l.isUndefined(b))throw"The target of the new link is not set.";var e,g;e=l.isString(a)?new F(a):a,g=l.isString(b)?new F(b):b,this.source=e,this.target=g,this.source.links.push(this),this.target.links.push(this),this.source.outgoing.push(this),this.target.incoming.push(this),this.id=l.isDefined(c)?c:f(),this.associatedConnection=l.isDefined(d)?d:null,this.type="Link",this.shortForm="Link '"+this.source.id+"->"+this.target.id+"'"},getComplement:function(a){if(this.source!==a&&this.target!==a)throw"The given node is not incident with this link.";return this.source===a?this.target:this.source},getCommonNode:function(a){return this.source===a.source||this.source===a.target?this.source:this.target===a.source||this.target===a.target?this.target:null},isBridging:function(a,b){return this.source===a&&this.target===b||this.source===b&&this.target===a},getNodes:function(){return[this.source,this.target]},incidentWith:function(a){return this.source===a||this.target===a},adjacentTo:function(a){return o(this.source.links,a)||o(this.target.links,a)},changeSource:function(a){l.remove(this.source.links,this),l.remove(this.source.outgoing,this),a.links.push(this),a.outgoing.push(this),this.source=a},changeTarget:function(a){l.remove(this.target.links,this),l.remove(this.target.incoming,this),a.links.push(this),a.incoming.push(this),this.target=a},changesNodes:function(a,b){this.source===a?this.changeSource(b):this.target===a&&this.changeTarget(b)},reverse:function(){var a=this.source,b=this.target;return this.source=b,l.remove(a.outgoing,this),this.source.outgoing.push(this),this.target=a,l.remove(b.incoming,this),this.target.incoming.push(this),this},directTo:function(a){if(this.source!==a&&this.target!==a)throw"The given node is not incident with this link.";this.target!==a&&this.reverse()},createReverseEdge:function(){var a=this.clone();return a.reverse(),a.reversed=!0,a},clone:function(){var a=new G(this.source,this.target);return a}}),H=g.Class.extend({init:function(a){this.links=[],this.nodes=[],this.diagram=null,this._root=null,l.isDefined(a)?l.isString(a)?this.id=a:(this.diagram=a,this.id=a.id):this.id=f(),this.bounds=new t,this._hasCachedRelationships=!1,this.type="Graph"},cacheRelationships:function(a){if(l.isUndefined(a)&&(a=!1),!this._hasCachedRelationships||a){for(var b=0,c=this.nodes.length;c>b;b++){var d=this.nodes[b];d.children=this.getChildren(d),d.parents=this.getParents(d)}this._hasCachedRelationships=!0}},assignLevels:function(a,b,c){if(!a)throw"Start node not specified.";l.isUndefined(b)&&(b=0),this.cacheRelationships(),l.isUndefined(c)&&(c=new C,l.forEach(this.nodes,function(a){c.add(a,!1)})),c.set(a,!0),a.level=b;for(var d=a.children,e=0,f=d.length;f>e;e++){var g=d[e];g&&!c.get(g)&&this.assignLevels(g,b+1,c)}},root:function(a){if(l.isUndefined(a)){if(this._root)return this._root;var b=l.first(this.nodes,function(a){return 0===a.incoming.length});return b?b:l.first(this.nodes)}this._root=a},getConnectedComponents:function(){this.componentIndex=0,this.setItemIndices();for(var a=l.initArray(this.nodes.length,-1),b=0;b<this.nodes.length;b++)-1===a[b]&&(this._collectConnectedNodes(a,b),this.componentIndex++);var c,d=[];for(c=0;c<this.componentIndex;++c)d[c]=new H;for(c=0;c<a.length;++c){var e=d[a[c]];e.addNodeAndOutgoings(this.nodes[c])}return d.sort(function(a,b){return b.nodes.length-a.nodes.length}),d},_collectConnectedNodes:function(a,b){a[b]=this.componentIndex;var c=this.nodes[b];l.forEach(c.links,function(b){var d=b.getComplement(c),e=d.index;-1===a[e]&&this._collectConnectedNodes(a,e)},this)},calcBounds:function(){if(this.isEmpty())return this.bounds=new t,this.bounds;for(var a=null,b=0,c=this.nodes.length;c>b;b++){var d=this.nodes[b];a=a?a.union(d.bounds()):d.bounds()}return this.bounds=a,this.bounds},getSpanningTree:function(a){var b,c,d=new H,e=new C;d.root=a.clone(),d.root.level=0,d.root.id=a.id,e.add(a,d.root),a.level=0;var f=[],g=[];d.nodes.push(d.root),f.push(a),g.push(a);for(var h=1;g.length>0;)for(var i=g.pop(),j=0;j<i.links.length;j++){var k=i.links[j],m=k.getComplement(i);if(!o(f,m)){m.level=i.level+1,h<m.level+1&&(h=m.level+1),o(g,m)||g.push(m),o(f,m)||f.push(m),e.containsKey(i)?b=e.get(i):(b=i.clone(),b.level=i.level,b.id=i.id,e.add(i,b)),e.containsKey(m)?c=e.get(m):(c=m.clone(),c.level=m.level,c.id=m.id,e.add(m,c));var n=new G(b,c);d.addLink(n)}}for(var p=[],q=0;h>q;q++)p.push([]);return l.forEach(d.nodes,function(a){p[a.level].push(a)}),d.treeLevels=p,d.cacheRelationships(),d},takeRandomNode:function(b,c){if(l.isUndefined(b)&&(b=[]),l.isUndefined(c)&&(c=4),0===this.nodes.length)return null;if(1===this.nodes.length)return o(b,this.nodes[0])?null:this.nodes[0];var d=a.grep(this.nodes,function(a){return!o(b,a)&&a.degree()<=c});return l.isEmpty(d)?null:d[l.randomInteger(0,d.length)]},isEmpty:function(){return l.isEmpty(this.nodes)},isHealthy:function(){return l.all(this.links,function(a){return o(this.nodes,a.source)&&o(this.nodes,a.target)},this)},getParents:function(a){if(!this.hasNode(a))throw"The given node is not part of this graph.";return a.getParents()},getChildren:function(a){if(!this.hasNode(a))throw"The given node is not part of this graph.";return a.getChildren()},addLink:function(a,b,c){if(l.isUndefined(a))throw"The source of the link is not defined.";if(l.isUndefined(b)){if(l.isDefined(a.type)&&"Link"===a.type)return void this.addExistingLink(a);throw"The target of the link is not defined."}var d=this.getNode(a);l.isUndefined(d)&&(d=this.addNode(a));var e=this.getNode(b);l.isUndefined(e)&&(e=this.addNode(b));var f=new G(d,e);return l.isDefined(c)&&(f.owner=c),this.links.push(f),f},removeAllLinks:function(){for(;this.links.length>0;){var a=this.links[0];this.removeLink(a)}},addExistingLink:function(a){if(!this.hasLink(a)){if(this.links.push(a),this.hasNode(a.source.id)){var b=this.getNode(a.source.id);a.changeSource(b)}else this.addNode(a.source);if(this.hasNode(a.target.id)){var c=this.getNode(a.target.id);a.changeTarget(c)}else this.addNode(a.target)}},hasLink:function(a){if(l.isString(a))return l.any(this.links,function(b){return b.id===a});if("Link"===a.type)return o(this.links,a);throw"The given object is neither an identifier nor a Link."},getNode:function(a){if(l.isUndefined(a))throw"No identifier or Node specified.";return l.isString(a)?l.find(this.nodes,function(b){return b.id==a}):this.hasNode(a)?a:null},hasNode:function(a){if(l.isString(a))return l.any(this.nodes,function(b){return b.id===a});if(l.isObject(a))return l.any(this.nodes,function(b){return b===a});throw"The identifier should be a Node or the Id (string) of a node."},removeNode:function(a){var b=a;if(l.isString(a)&&(b=this.getNode(a)),!l.isDefined(b))throw"The identifier should be a Node or the Id (string) of a node.";var c=b.links;b.links=[];for(var d=0,e=c.length;e>d;d++){var f=c[d];this.removeLink(f)}l.remove(this.nodes,b)},areConnected:function(a,b){return l.any(this.links,function(c){return c.source==a&&c.target==b||c.source==b&&c.target==a})},removeLink:function(a){l.remove(this.links,a),l.remove(a.source.outgoing,a),l.remove(a.source.links,a),l.remove(a.target.incoming,a),l.remove(a.target.links,a)},addNode:function(a,b,c){var d=null;if(!l.isDefined(a))throw"No Node or identifier for a new Node is given.";if(l.isString(a)){if(this.hasNode(a))return this.getNode(a);d=new F(a)}else{if(this.hasNode(a))return this.getNode(a);d=a}return l.isDefined(b)&&d.bounds(b),l.isDefined(c)&&(d.owner=c),this.nodes.push(d),d},addNodeAndOutgoings:function(a){o(this.nodes,a)||this.nodes.push(a);var b=a.outgoing;a.outgoing=[],l.forEach(b,function(a){this.addExistingLink(a)},this)},setItemIndices:function(){var a;for(a=0;a<this.nodes.length;++a)this.nodes[a].index=a;for(a=0;a<this.links.length;++a)this.links[a].index=a},clone:function(a){var b=new H,c=l.isDefined(a)&&a===!0;c&&(b.nodeMap=new C,b.linkMap=new C);var d=new C;return l.forEach(this.nodes,function(a){var e=a.clone();d.set(a,e),b.nodes.push(e),c&&b.nodeMap.set(e,a)}),l.forEach(this.links,function(a){if(d.containsKey(a.source)&&d.containsKey(a.target)){var e=b.addLink(d.get(a.source),d.get(a.target));c&&b.linkMap.set(e,a)}}),b},linearize:function(a){return H.Utils.linearize(this,a)},depthFirstTraversal:function(a,b){if(l.isUndefined(a))throw"You need to supply a starting node.";if(l.isUndefined(b))throw"You need to supply an action.";if(!this.hasNode(a))throw"The given start-node is not part of this graph";var c=this.getNode(a),d=[];this._dftIterator(c,b,d)},_dftIterator:function(a,b,c){b(a),c.push(a);for(var d=a.getChildren(),e=0,f=d.length;f>e;e++){var g=d[e];o(c,g)||this._dftIterator(g,b,c)}},breadthFirstTraversal:function(a,b){if(l.isUndefined(a))throw"You need to supply a starting node.";if(l.isUndefined(b))throw"You need to supply an action.";if(!this.hasNode(a))throw"The given start-node is not part of this graph";var c=this.getNode(a),d=new D,e=[];for(d.enqueue(c);d.length>0;){var f=d.dequeue();b(f),e.push(f);for(var g=f.getChildren(),h=0,i=g.length;i>h;h++){var j=g[h];o(e,j)||o(d,j)||d.enqueue(j)}}},_stronglyConnectedComponents:function(a,b,c,d,e,f,g){c.add(b,g),d.add(b,g),g++,f.push(b);for(var h,i=b.getChildren(),j=0,k=i.length;k>j;j++)h=i[j],c.containsKey(h)?o(f,h)&&d.add(b,Math.min(d.get(b),c.get(h))):(this._stronglyConnectedComponents(a,h,c,d,e,f,g),d.add(b,Math.min(d.get(b),d.get(h))));if(d.get(b)===c.get(b)){var l=[];do h=f.pop(),l.push(h);while(h!==b);(!a||l.length>1)&&e.push(l)}},findCycles:function(a){l.isUndefined(a)&&(a=!0);for(var b=new C,c=new C,d=[],e=[],f=0,g=this.nodes.length;g>f;f++){var h=this.nodes[f];b.containsKey(h)||this._stronglyConnectedComponents(a,h,b,c,d,e,0)}return d},isAcyclic:function(){return l.isEmpty(this.findCycles())},isSubGraph:function(a){var b=a.linearize(),c=this.linearize();return l.all(b,function(a){return o(c,a)})},makeAcyclic:function(){if(this.isEmpty()||this.nodes.length<=1||this.links.length<=1)return[];if(2==this.nodes.length){var a=[];if(this.links.length>1)for(var b=this.links[0],c=b.source,d=0,e=this.links.length;e>d;d++){var f=this.links[d];if(f.source!=c){var g=f.reverse();a.push(g)}}return a}var h=this.clone(!0),i=this.nodes.length,j=new C,k=function(a){return 0===a.outgoing.length?2-i:0===a.incoming.length?i-2:a.outgoing.length-a.incoming.length},m=function(a,b){var c=k(a,i);b.containsKey(c)||b.set(c,[]),b.get(c).push(a)};l.forEach(h.nodes,function(a){m(a,j)});for(var n=[],o=[];h.nodes.length>0;){var p,q,r;if(j.containsKey(2-i))for(var s=j.get(2-i);s.length>0;){
q=s.pop();for(var t=0;t<q.links.length;t++){var u=q.links[t];p=u.getComplement(q),r=k(p,i),l.remove(j.get(r),p),p.removeLink(u),m(p,j)}l.remove(h.nodes,q),o.unshift(q)}if(j.containsKey(i-2))for(var v=j.get(i-2);v.length>0;){p=v.pop();for(var w=0;w<p.links.length;w++){var x=p.links[w];q=x.getComplement(p),r=k(q,i),l.remove(j.get(r),q),q.removeLink(x),m(q,j)}n.push(p),l.remove(h.nodes,p)}if(h.nodes.length>0)for(var y=i-3;y>2-i;y--)if(j.containsKey(y)&&j.get(y).length>0){for(var z=j.get(y),A=z.pop(),B=0;B<A.links.length;B++){var D=A.links[B],E=D.getComplement(A);r=k(E,i),l.remove(j.get(r),E),E.removeLink(D),m(E,j)}n.push(A),l.remove(h.nodes,A);break}}n=n.concat(o);for(var F=new C,G=0;G<this.nodes.length;G++)F.set(h.nodeMap.get(n[G]),G);var H=[];return l.forEach(this.links,function(a){F.get(a.source)>F.get(a.target)&&(a.reverse(),H.push(a))}),H}});H.Predefined={EightGraph:function(){return H.Utils.parse(["1->2","2->3","3->4","4->1","3->5","5->6","6->7","7->3"])},Mindmap:function(){return H.Utils.parse(["0->1","0->2","0->3","0->4","0->5","1->6","1->7","7->8","2->9","9->10","9->11","3->12","12->13","13->14","4->15","4->16","15->17","15->18","18->19","18->20","14->21","14->22","5->23","23->24","23->25","6->26"])},ThreeGraph:function(){return H.Utils.parse(["1->2","2->3","3->1"])},BinaryTree:function(a){return l.isUndefined(a)&&(a=5),H.Utils.createBalancedTree(a,2)},Linear:function(a){return l.isUndefined(a)&&(a=10),H.Utils.createBalancedTree(a,1)},Tree:function(a,b){return H.Utils.createBalancedTree(a,b)},Forest:function(a,b,c){return H.Utils.createBalancedForest(a,b,c)},Workflow:function(){return H.Utils.parse(["0->1","1->2","2->3","1->4","4->3","3->5","5->6","6->3","6->7","5->4"])},Grid:function(a,b){var c=new h.Graph;if(0>=a&&0>=b)return c;for(var d=0;a+1>d;d++)for(var e=null,f=0;b+1>f;f++){var g=new F(d.toString()+"."+f.toString());if(c.addNode(g),e&&c.addLink(e,g),d>0){var i=c.getNode((d-1).toString()+"."+f.toString());c.addLink(i,g)}e=g}return c}},H.Utils={parse:function(a){for(var b,c=new h.Graph,d=a.slice(),e=0,f=d.length;f>e;e++){var i=d[e];if(l.isString(i)){if(i.indexOf("->")<0)throw"The link should be specified as 'a->b'.";var j=i.split("->");if(2!=j.length)throw"The link should be specified as 'a->b'.";b=new G(j[0],j[1]),c.addLink(b)}if(l.isObject(i)){if(!b)throw"Specification found before Link definition.";g.deepExtend(b,i)}}return c},linearize:function(a,b){if(l.isUndefined(a))throw"Expected an instance of a Graph object in slot one.";l.isUndefined(b)&&(b=!1);for(var c=[],d=0,e=a.links.length;e>d;d++){var f=a.links[d];c.push(f.source.id+"->"+f.target.id),b&&c.push({id:f.id})}return c},_addShape:function(a,b,c,d){return l.isUndefined(b)&&(b=new h.Point(0,0)),l.isUndefined(c)&&(c=f()),d=g.deepExtend({width:20,height:20,id:c,radius:10,background:"#778899",data:"circle",undoable:!1,x:b.x,y:b.y},d),a.addShape(d)},_addConnection:function(a,b,c,d){return a.connect(b,c,d)},createDiagramFromGraph:function(a,b,c,d){if(l.isUndefined(a))throw"The diagram surface is undefined.";if(l.isUndefined(b))throw"No graph specification defined.";l.isUndefined(c)&&(c=!0),l.isUndefined(d)&&(d=!1);for(var e,f,h=a.element.clientWidth||200,i=a.element.clientHeight||200,j=[],k=0,n=b.nodes.length;n>k;k++){e=b.nodes[k];var o=e.position;l.isUndefined(o)&&(o=l.isDefined(e.x)&&l.isDefined(e.y)?new m(e.x,e.y):new m(l.randomInteger(10,h-20),l.randomInteger(10,i-20)));var p={};"0"===e.id||d&&g.deepExtend(p,{width:150*Math.random()+20,height:80*Math.random()+50,data:"rectangle",background:"#778899"}),f=this._addShape(a,o,e.id,p);var q=f.bounds();l.isDefined(q)&&(e.x=q.x,e.y=q.y,e.width=q.width,e.height=q.height),j[e.id]=f}for(var r=0;r<b.links.length;r++){var s=b.links[r],u=j[s.source.id];if(!l.isUndefined(u)){var v=j[s.target.id];l.isUndefined(v)||this._addConnection(a,u,v,{id:s.id})}}if(c){var w=new a.SpringLayout(a);w.layoutGraph(b,{limitToView:!1});for(var x=0;x<b.nodes.length;x++)e=b.nodes[x],f=j[e.id],f.bounds(new t(e.x,e.y,e.width,e.height))}},createBalancedTree:function(a,b){l.isUndefined(a)&&(a=3),l.isUndefined(b)&&(b=3);var c,d=new h.Graph,e=-1,f=[];if(0>=a||0>=b)return d;var g=new F((++e).toString());d.addNode(g),d.root=g,f.push(g);for(var i=0;a>i;i++){c=[];for(var j=0;j<f.length;j++)for(var k=f[j],m=0;b>m;m++){var n=new F((++e).toString());d.addLink(k,n),c.push(n)}f=c}return d},createBalancedForest:function(a,b,c){l.isUndefined(a)&&(a=3),l.isUndefined(b)&&(b=3),l.isUndefined(c)&&(c=5);var d,e=new h.Graph,f=-1,g=[];if(0>=a||0>=b||0>=c)return e;for(var i=0;c>i;i++){var j=new F((++f).toString());e.addNode(j),g=[j];for(var k=0;a>k;k++){d=[];for(var m=0;m<g.length;m++)for(var n=g[m],o=0;b>o;o++){var p=new F((++f).toString());e.addLink(n,p),d.push(p)}g=d}}return e},createRandomConnectedGraph:function(a,b,c){l.isUndefined(a)&&(a=40),l.isUndefined(b)&&(b=4),l.isUndefined(c)&&(c=!1);var d=new h.Graph,e=-1;if(0>=a)return d;var f=new F((++e).toString());if(d.addNode(f),1===a)return d;if(a>1){for(var g=1;a>g;g++){var i=d.takeRandomNode([],b);if(!i)break;var j=d.addNode(g.toString());d.addLink(i,j)}if(!c&&a>1)for(var k=l.randomInteger(1,a),m=0;k>m;m++){var n=d.takeRandomNode([],b),o=d.takeRandomNode([],b);n&&o&&!d.areConnected(n,o)&&d.addLink(n,o)}return d}},randomDiagram:function(a,b,c,d,e){var f=a.Graph.Utils.createRandomConnectedGraph(b,c,d);H.Utils.createDiagramFromGraph(a,f,!1,e)}},g.deepExtend(h,{init:function(a){g.init(a,h.ui)},Point:m,Intersect:v,Geometry:A,Rect:t,Size:u,RectAlign:w,Matrix:y,MatrixVector:z,normalVariable:e,randomId:f,Dictionary:C,HashTable:B,Queue:D,Set:E,Node:F,Link:G,Graph:H,PathDefiner:s})}(window.joy.jQuery),function(a,b){function c(a){var b=a._originWidth?a.options.width/a._originWidth:1,c=a._originHeight?a.options.height/a._originHeight:1,d=a.options.x||0,e=a.options.y||0;a._transform.translate=new v(d,e),a._transform.scale=new u(b,c),a._renderTransform()}var d=window.joy,e=d.Observable,f=d.dataviz.diagram,g=d.Class,h=d.deepExtend,i=d.dataviz,j=f.Point,k=f.Rect,l=f.RectAlign,m=f.Matrix,n=f.Utils,o=n.isUndefined,p=f.MatrixVector,q="http://www.w3.org/2000/svg",r="http://www.w3.org/1999/xlink",s={none:"none",arrowStart:"ArrowStart",filledCircle:"FilledCircle",arrowEnd:"ArrowEnd"},t=360;f.Markers=s;var u=g.extend({init:function(a,b){this.x=a,this.y=b},toMatrix:function(){return m.scaling(this.x,this.y)},toString:function(){return d.format("scale({0},{1})",this.x,this.y)},invert:function(){return new u(1/this.x,1/this.y)}}),v=g.extend({init:function(a,b){this.x=a,this.y=b},toMatrixVector:function(){return new p(0,0,0,0,this.x,this.y)},toMatrix:function(){return m.translation(this.x,this.y)},toString:function(){return d.format("translate({0},{1})",this.x,this.y)},plus:function(a){this.x+=a.x,this.y+=a.y},times:function(a){this.x*=a,this.y*=a},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){0!==this.Length&&this.times(1/this.length())},invert:function(){return new v(-this.x,-this.y)}}),w=g.extend({init:function(a,b,c){this.x=b||0,this.y=c||0,this.angle=a},toString:function(){return this.x&&this.y?d.format("rotate({0},{1},{2})",this.angle,this.x,this.y):d.format("rotate({0})",this.angle)},toMatrix:function(){return m.rotation(this.angle,this.x,this.y)},center:function(){return new j(this.x,this.y)},invert:function(){return new w(t-this.angle,this.x,this.y)}});w.create=function(a){return new w(a.angle,a.x,a.y)},w.parse=function(a){var b=a.slice(1,a.length-1).split(","),c=b[0],d=b[1],e=b[2],f=new w(c,d,e);return f};var x=g.extend({init:function(a,c,d,e,f,g){this.translate=new v(a,c),d!==b&&e!==b&&(this.scale=new u(d,e)),f!==b&&(this.rotate=g?new w(f,g.x,g.y):new w(f))},toString:function(){var a=function(a){return a?a.toString():""};return a(this.translate)+a(this.rotate)+a(this.scale)},render:function(a){a.setAttribute("transform",this.toString())},toMatrix:function(){var a=m.unit();return this.translate&&(a=a.times(this.translate.toMatrix())),this.rotate&&(a=a.times(this.rotate.toMatrix())),this.scale&&(a=a.times(this.scale.toMatrix())),a},invert:function(){var a=this.rotate?this.rotate.invert():b,c=a?a.toMatrix():m.unit(),d=this.scale?this.scale.invert():b,e=d?d.toMatrix():m.unit(),f=new j(-this.translate.x,-this.translate.y);f=c.times(e).apply(f);var g=new v(f.x,f.y),h=new x;return h.translate=g,h.rotate=a,h.scale=d,h}}),y=g.extend({init:function(a,b){var c=this;this._originSize=k.empty(),this._visible=!0,this._transform=new x,c.domElement=a,c.options=h({},c.options,b),c.redraw()},visible:function(a){return o(a)?this._visible:(this._visible=a,void this.domElement.setAttribute("visibility",a?"visible":"hidden"))},setAtr:function(a,c){o(c)||o(this.options[c])||this.options[c]!==b&&this.domElement.setAttribute(a,this.options[c])},redraw:function(a){a&&h(this.options,a),this.setAtr("id","id")},position:function(a,c){return c!==b?(this.options.x=a,this.options.y=c,this._pos=new j(a,c)):a instanceof j&&(this._pos=a,this.options.x=this._pos.x,this.options.y=this._pos.y),this._transform.translate=new v(this.options.x,this.options.y),this._renderTransform(),this._pos},rotate:function(a,c){return a!==b&&(this._transform.rotate=new w(a,c.x,c.y),this._renderTransform()),this._transform.rotate||new w(0)},_renderTransform:function(){this._transform.render(this.domElement)},_hover:function(){},_measure:function(a){var b,c=this.domElement;if(!this._measured||a)try{if(b=c.getBBox(),b.width&&b.height)return this._originSize=new k(b.left,b.right,b.width,b.height),this._originWidth=b.width,this._originHeight=b.height,this._measured=!0,this._originSize}catch(d){}}}),z=y.extend({init:function(a,b){var c=this;y.fn.init.call(c,a,b),a._joyElement=this},options:{stroke:{color:"gray",width:1,dashType:"none"}},background:function(a){a!==b&&(this.options.background=a),this._background(this.options.background)},redraw:function(a){var b=this;y.fn.redraw.call(b,a),b._setStroke(),b.setAtr("fill-opacity","fillOpacity"),b.background()},_setStroke:function(){var a=this.options.stroke||{};this.domElement.setAttribute("stroke",a.color),this.domElement.setAttribute("stroke-dasharray",this._renderDashType()),this.domElement.setAttribute("stroke-width",a.width)},_renderDashType:function(){var a=this.options.stroke||{},b=a.width||1,c=a.dashType;if(c&&"solid"!=c){var d,e=i.DASH_ARRAYS[c.toLowerCase()]||[],f=[];for(d=0;d<e.length;d++)f.push(e[d]*b);return f.join(" ")}},_hover:function(a){var b=this.options.background;a&&n.isDefined(this.options.hover.background)&&(b=this.options.hover.background),this._background(b)},_background:function(a){this.domElement.setAttribute("fill",this._getColor(a))},_getColor:function(a){var b;if("none"!=a){var c=new i.Color(a);b=c.toHex()}else b=a;return b}}),A=z.extend({init:function(a,b){var c=this;z.fn.init.call(c,a,b)},redraw:function(a){var c=this;z.fn.redraw.call(c,a),c.options.x!==b&&c.options.y!==b&&c.position(c.options.x,c.options.y),c.size()},size:function(a){return a!==b&&(this.options.width=a.width,this.options.height=a.height),this._sz={width:this.options.width,height:this.options.height},this.setAtr("width","width"),this.setAtr("height","height"),this.setAtr("background","background"),this._sz}}),B=z.extend({init:function(a){var b=this;A.fn.init.call(b,document.createElementNS(q,"text"),a),this.domElement.setAttribute("dominant-baseline","hanging")},options:{stroke:{color:"none",width:0,dashType:"none"},fontSize:15,fontVariant:"normal",fontWeight:"normal",anchor:"middle",background:"black",align:""},content:function(a){return a!==b&&(this.domElement.textContent=this.options.text=a,this._align()),this.options.text},redraw:function(a){A.fn.redraw.call(this,a),this.setAtr("font-family","fontFamily"),this.setAtr("font-variant","fontVariant"),this.setAtr("font-size","fontSize"),this.setAtr("font-weight","fontWeight"),this.setAtr("font-style","fontStyle"),this.setAtr("text-decoration","textDecoration"),this.setAtr("fill","color"),this.content(this.options.text)},size:function(){c(this)},bounds:function(){var a=this.options,b=new k(0,0,a.width,a.height);return b},align:function(a){this.options.align=a,this._align(a)},_align:function(){if(this.options.align){this._measure(!0);var a=this.options,b=this.bounds(),c=new l(b),d=c.align(this._originSize,a.align);this.position(d.topLeft()),a.width=d.width,a.height=d.height,this.size()}}}),C=e.extend({init:function(a,b){e.fn.init.call(this);var c=this;c.domElement=a||this._createEditor(),c.options=h({},c.options,b),c.redraw()},visible:function(a){return a!==b&&(this._isVisible=a,this.domElement.style.visibility=a?"visible":"hidden"),this._isVisible},position:function(c,d){return d!==b?(this.options.x=c,this.options.y=d,this._pos=new j(c,d)):c instanceof j&&(this._pos=c,this.options.x=this._pos.x,this.options.y=this._pos.y),a(this.domElement).css({left:this._pos.x+"px",top:this._pos.y+"px"}),this._pos},size:function(c,d){var e=!1;return d!==b?(this._size={width:c,height:d},e=!0):c===Object(c)&&(this._size={width:c.width,height:c.height},e=!0),e&&(h(this.options,this._size),a(this.domElement).css({width:this._size.width+"px",height:this._size.height+"px"})),this._size},focus:function(){a(this.domElement).focus()},content:function(a){return o(a)||(this.domElement.value=this.options.text=a),this.domElement.value},redraw:function(a){this.options=h(this.options,a),this.content(this.options.text)},_createEditor:function(){var b=this,c=a("<input type='text' class='textEditable' />").css({position:"absolute",zIndex:100,fontSize:"16px"}).on("mousedown mouseup click dblclick",function(a){a.stopPropagation()}).on("keydown",function(a){a.stopPropagation()}).on("keypress",function(a){a.keyCode==d.keys.ENTER&&b.trigger("finishEdit",a),a.stopPropagation()}).on("focusout",function(a){b.trigger("finishEdit",a),a.stopPropagation()});return c[0]}}),D=A.extend({init:function(a){A.fn.init.call(this,document.createElementNS(q,"rect"),a)},options:{stroke:{},background:"none"},redraw:function(a){A.fn.redraw.call(this,a),this.setAtr("rx","cornerRadius"),this.setAtr("ry","cornerRadius"),this._setStroke()}}),E=z.extend({init:function(a){var b=this;z.fn.init.call(b,document.createElementNS(q,"path"),a)},options:{autoSize:!0},data:function(a){return a?void(this.options.data=a):this.options.data},size:function(){c(this)},redraw:function(a){var b=this;z.fn.redraw.call(b,a),b.size(),b.setAtr("d","data"),this.options.startCap&&this.options.startCap!==s.none?this.domElement.setAttribute("marker-start","url(#"+this.options.startCap+")"):this.domElement.removeAttribute("marker-start"),this.options.endCap&&this.options.endCap!==s.none?this.domElement.setAttribute("marker-end","url(#"+this.options.endCap+")"):this.domElement.removeAttribute("marker-end"),this.domElement.parentNode&&-1!=navigator.appVersion.indexOf("MSIE 10")&&this.domElement.parentNode.insertBefore(this.domElement,this.domElement)}}),F=y.extend({init:function(a){var b,c=this;y.fn.init.call(c,document.createElementNS(q,"marker"),a);var d=c.options;d.path?b=new E(d.path):d.circle&&(b=new L(d.circle)),b&&this.domElement.appendChild(b.domElement)},redraw:function(a){y.fn.redraw.call(this,a);var b=this,c=b.options;c.ref&&(b.domElement.refX.baseVal.value=c.ref.x,b.domElement.refY.baseVal.value=c.ref.y),c.width&&(b.domElement.markerWidth.baseVal.value=c.width),c.height&&(b.domElement.markerHeight.baseVal.value=c.height),this.setAtr("orient","orientation"),this.setAtr("viewBox","viewBox")}}),G=y.extend({init:function(a){var b,c=this;y.fn.init.call(c,document.createElementNS(q,"mask"),a);var d=c.options;d.path?b=new E(d.path):d.circle?b=new L(d.circle):d.rectangle&&(b=new D(d.rectangle)),b&&this.domElement.appendChild(b.domElement),this.setAtr("id","id")},redraw:function(a){y.fn.redraw.call(this,a);var b=this,c=b.options;c.width&&(b.domElement.width.baseVal.value=c.width),c.height&&(b.domElement.height.baseVal.value=c.height)}}),H=z.extend({init:function(a){z.fn.init.call(this,document.createElementNS(q,"line"),a),this.options.from=this.options.from||new j,this.options.to=this.options.to||new j},redraw:function(a){z.fn.redraw.call(this,a),this.options.from&&(this.domElement.setAttribute("x1",this.options.from.x.toString()),this.domElement.setAttribute("y1",this.options.from.y.toString())),this.options.to&&(this.domElement.setAttribute("x2",this.options.to.x.toString()),this.domElement.setAttribute("y2",this.options.to.y.toString())),this.options.startCap&&this.options.startCap!==s.none?this.domElement.setAttribute("marker-start","url(#"+this.options.startCap+")"):this.domElement.removeAttribute("marker-start"),this.options.endCap&&this.options.endCap!==s.none?this.domElement.setAttribute("marker-end","url(#"+this.options.endCap+")"):this.domElement.removeAttribute("marker-end"),this.domElement.parentNode&&-1!=navigator.appVersion.indexOf("MSIE 10")&&this.domElement.parentNode.insertBefore(this.domElement,this.domElement)}}),I=z.extend({init:function(a){var b=this;z.fn.init.call(b,document.createElementNS(q,"polyline"),a),n.isDefined(a)&&null!==a.points&&this.points(b.options.points),this.background("none")},refresh:function(){if(null!==this._points&&0!==this._points.length){var a,b="";for(a=0;a<this._points.length;a++)b+=" "+this._points[a].x+","+this._points[a].y;this.domElement.setAttribute("points",b.trim()),this.domElement.setAttribute("stroke","Orange"),this.domElement.setAttribute("stroke-width","5")}},points:function(a){return o(a)?this._points:(this._points=a,void this.refresh())},redraw:function(){this.refresh()},options:{stroke:{color:"gray",width:1},backgrounds:"none",points:[]}}),J=y.extend({init:function(a){y.fn.init.call(this,document.createElementNS(q,"image"),a)},options:{autoSize:!0},redraw:function(a){y.fn.redraw.call(this,a),this.domElement.setAttributeNS(r,"href",this.options.source),this.setAtr("width","width"),this.setAtr("height","height"),this.setAtr("x","x"),this.setAtr("y","x")}}),K=y.extend({init:function(a){y.fn.init.call(this,document.createElementNS(q,"g"),a),this.width=this.options.width,this.height=this.options.height},options:{autoSize:!0},append:function(a){this.domElement.appendChild(a.domElement),a.canvas=this.canvas},remove:function(a){this.domElement.removeChild(a.domElement?a.domElement:a)},clear:function(){for(;this.domElement.lastChild;)this.domElement.removeChild(this.domElement.lastChild)},toFront:function(a){var b,c,d=this.domElement;for(c=0;c<a.length;c++)b=a[c],d.appendChild(b.domElement)},toBack:function(a){var b,c;for(c=0;c<a.length;c++)b=a[c],this.domElement.insertBefore(b.domElement,this.domElement.firstChild)},toIndex:function(a,b){var c,d,e;for(d=0;d<a.length;d++)c=a[d],e=b[d],this.domElement.insertBefore(c.domElement,this.domElement.children[e])},size:function(){c(this)},redraw:function(a){y.fn.redraw.call(this,a),this.size()}}),L=z.extend({init:function(a){var b=this;a&&a.radius&&(a.width=2*a.radius,a.height=2*a.radius),z.fn.init.call(b,document.createElementNS(q,"ellipse"),a)},redraw:function(a){a&&n.isNumber(a.width)&&n.isNumber(a.height)&&(a.center=new j(a.width/2,a.height/2)),z.fn.redraw.call(this,a);var b=this.domElement,c=this.options,d=c.width/2||c.rx,e=c.height/2||c.rx;d&&e&&(b.rx.baseVal.value=d,b.ry.baseVal.value=e),c.center?(b.cx.baseVal.value=c.center.x,b.cy.baseVal.value=c.center.y):n.isDefined(c.x)&&n.isDefined(c.y)?(b.cx.baseVal.value=c.x+d,b.cy.baseVal.value=c.y+e):(b.cx.baseVal.value=d,b.cy.baseVal.value=e)}}),M=A.extend({init:function(b,c){var d=this;A.fn.init.call(d,document.createElementNS(q,"svg"),c),this.markers=[],this.gradients=[],this.visuals=[],this.defsNode=document.createElementNS(q,"defs"),this.domElement.appendChild(this.defsNode),this.element=b.context?b.context:b,a(this.domElement).css({width:this.options.width,height:this.options.height}),this.element.appendChild(d.domElement),this.domElement.style.background=d.options.background,this.domElement.setAttribute("xmlns",q),this.domElement.setAttribute("xmlns:xlink",r),this.element.setAttribute("tabindex","0"),this._markers(),this.masks=[]},options:{width:"100%",height:"100%",background:"none",id:"SVGRoot"},bounds:function(){var a=this.domElement.getBBox();return new k(0,0,a.width,a.height)},focus:function(){this.element.focus()},size:function(){var a=this,b=A.fn.size.apply(a,arguments),c=this.viewBox();return this._styledSize(a.domElement),c.width=b.width,c.height=b.height,this.viewBox(c),b},_styledSize:function(b){var c=this._sz;a(b).css(c)},viewBox:function(a){var b=this;return o(a)?b.domElement.viewBox.baseVal?k.toRect(b.domElement.viewBox.baseVal):k.empty():(a=k.toRect(a),void(isNaN(a.width)||isNaN(a.height)||this.domElement.setAttribute("viewBox",a.toString(","))))},append:function(a){return this.domElement.appendChild(a.domElement),a.canvas=this,this.visuals.push(a),this},remove:function(a){return n.indexOf(this.visuals,a)>=0?(this.domElement.removeChild(a.domElement),a.canvas=b,n.remove(this.visuals,a),this):void 0},insertBefore:function(a,b){return this.domElement.insertBefore(a.domElement,b.domElement),a.canvas=this,this.visuals.push(a),this},addMarker:function(a){this.defsNode.appendChild(a.domElement),this.markers.push(a)},removeMarker:function(a){a&&n.contains.contains(this.markers,a)&&(this.defsNode.removeChild(a.domElement),n.remove(this.markers,a))},addMask:function(a){this.defsNode.appendChild(a.domElement),this.masks.push(a)},removeMask:function(a){a&&n.contains(this.masks,a)&&(this.defsNode.removeChild(a.domElement),n.remove(this.masks,a))},removeGradient:function(a){a&&n.contains(this.gradients,a)&&(this.defsNode.removeChild(a.domElement),n.remove(this.gradients,a))},addGradient:function(a){this.defsNode.appendChild(a.domElement),this.gradients.push(a)},clearMarkers:function(){var a;if(0!==this.markers.length){for(a=0;a<this.markers.length;a++)this.defsNode.removeChild(this.markers[a].domElement);this.markers=[]}},clear:function(){for(;this.visuals.length;)this.remove(this.visuals[0])},mask:function(a){null===a?this.domElement.removeAttribute("mask"):this.domElement.setAttribute("mask","url(#"+a.domElement.id+")")},_markers:function(){this.addMarker(new F({path:{data:"M 0 0 L 10 5 L 0 10 L 3 5 z",background:"Black"},id:s.arrowEnd,orientation:"auto",width:10,height:10,ref:new j(10,5)})),this.addMarker(new F({path:{data:"M 0 5 L 10 0 L 7 5 L 10 10 z",background:"Black"},id:s.arrowStart,orientation:"auto",width:10,height:10,ref:new j(0,5)})),this.addMarker(new F({circle:{width:6,height:6,center:new j(5,5),stroke:{width:1},background:"black"},width:10,height:10,id:s.filledCircle,ref:new j(5,5),orientation:"auto"}))},destroy:function(b){b&&a(this.element).remove()}});d.deepExtend(f,{init:function(a){d.init(a,f.ui)},Scale:u,Translation:v,Rotation:w,Circle:L,Group:K,Rectangle:D,Canvas:M,Path:E,Line:H,Marker:F,Polyline:I,CompositeTransform:x,TextBlock:B,TextBlockEditor:C,Image:J,Mask:G,Visual:A,VisualBase:z})}(window.joy.jQuery),function(a,b){function c(a,b){a.isSelected?b.ctrlKey&&a.select(!1):a.diagram.select(a,{addToSelection:b.ctrlKey})}function d(a,b){return b.charCodeAt(0)==a||b.toUpperCase().charCodeAt(0)==a}function e(a,b){var c;return-1==a.x&&-1==a.y?c=b.bottomRight():1==a.x&&1==a.y?c=b.topLeft():-1==a.x&&1==a.y?c=b.topRight():1==a.x&&-1==a.y?c=b.bottomLeft():0===a.x&&-1==a.y?c=b.bottom():0===a.x&&1==a.y?c=b.top():1==a.x&&0===a.y?c=b.left():-1==a.x&&0===a.y&&(c=b.right()),c}var f=window.joy,g=f.dataviz.diagram,h=f.Class,i=g.Group,j=g.TextBlock,k=g.Rect,l=g.Rectangle,m=g.Utils,n=m.isUndefined,o=g.Point,p=g.Circle,q=g.Path,r=g.Ticker,s=f.deepExtend,t=f.ui.Movable,u={arrow:"default",grip:"pointer",cross:"pointer",add:"pointer",move:"move",select:"pointer",south:"s-resize",east:"e-resize",west:"w-resize",north:"n-resize",rowresize:"row-resize",colresize:"col-resize"},v=10,w="Auto",x="Top",y="Right",z="Left",A="Bottom",B=[x,y,A,z,w],C="itemRotate",D="itemBoundsChange",E="zoomStart",F="zoomEnd",G=-2e4,H=2e4;g.Cursors=u;var I=f.Class.extend({init:function(a){this.layoutState=a,this.diagram=a.diagram},initState:function(){function a(a,b){var c=this.diagram.getShapeById(a);c&&(this.subjects.push(c),this.froms.push(c.bounds().topLeft()),this.tos.push(b.topLeft()))}this.froms=[],this.tos=[],this.subjects=[],this.layoutState.nodeMap.forEach(a,this)},update:function(a){if(!(this.subjects.length<=0))for(var b=0;b<this.subjects.length;b++)this.subjects[b].position(new o(this.froms[b].x+(this.tos[b].x-this.froms[b].x)*a,this.froms[b].y+(this.tos[b].y-this.froms[b].y)*a))}}),J=h.extend({init:function(a,b,c){this.animate=n(c)?!1:c,this._initialState=a,this._finalState=b,this.title="Diagram layout"},undo:function(){this.setState(this._initialState)},redo:function(){this.setState(this._finalState)},setState:function(a){var b=a.diagram;if(this.animate){a.linkMap.forEach(function(a,c){var d=b.getShapeById(a);d.visible(!1),d&&d.points(c)});var c=new r;c.addAdapter(new I(a)),c.onComplete(function(){a.linkMap.forEach(function(a){var c=b.getShapeById(a);c.visible(!0)})}),c.play()}else a.nodeMap.forEach(function(a,c){var d=b.getShapeById(a);d&&d.position(c.topLeft())}),a.linkMap.forEach(function(a,c){var d=b.getShapeById(a);d&&d.points(c)})}}),K=h.extend({init:function(a){this.units=[],this.title="Composite unit",a!==b&&this.units.push(a)},add:function(a){this.units.push(a)},undo:function(){for(var a=0;a<this.units.length;a++)this.units[a].undo()},redo:function(){for(var a=0;a<this.units.length;a++)this.units[a].redo()}}),L=h.extend({init:function(a,b,c){this.item=a,this._undoContent=b,this._redoContent=c,this.title="Content Editing",this.rebuild=this.item.options.hasOwnProperty("rebuild")?this.item.options.rebuild:null},undo:function(){this.item.content(this._undoContent),this.rebuild&&this.rebuild.call(this.item,this.item)},redo:function(){this.item.content(this._redoContent),this.rebuild&&this.rebuild.call(this.item,this.item)}}),M=h.extend({init:function(a,b,c){this.item=a,this._redoSource=b,this._redoTarget=c,this._undoSource=a.source(),this._undoTarget=a.target(),this.title="Connection Editing"},undo:function(){this._undoSource!==b&&this.item.source(this._undoSource,!1),this._undoTarget!==b&&this.item.target(this._undoTarget,!1)},redo:function(){this._redoSource!==b&&this.item.source(this._redoSource,!1),this._redoTarget!==b&&this.item.target(this._redoTarget,!1)}}),N=h.extend({init:function(a,b,c){this.item=a,this._undoSource=b,this._undoTarget=c,this._redoSource=a.source(),this._redoTarget=a.target(),this.title="Connection Editing"},undo:function(){this.item.source(this._undoSource,!1),this.item.target(this._undoTarget,!1)},redo:function(){this.item.source(this._redoSource,!1),this.item.target(this._redoTarget,!1)}}),O=h.extend({init:function(a){this.connection=a,this.diagram=a.diagram,this.targetConnector=a.targetConnector,this.title="Delete connection"},undo:function(){this.diagram.addConnection(this.connection,!1)},redo:function(){this.diagram.remove(this.connection,!1)}}),P=h.extend({init:function(a){this.shape=a,this.diagram=a.diagram,this.title="Deletion"},undo:function(){this.diagram.addShape(this.shape,{undoable:!1}),this.shape.select(!1)},redo:function(){this.shape.select(!1),this.diagram.remove(this.shape,!1)}}),Q=h.extend({init:function(a,b,c){this.shapes=a,this.undoStates=b,this.title="Transformation",this.redoStates=[],this.adorner=c;for(var d=0;d<this.shapes.length;d++){var e=this.shapes[d];this.redoStates.push(e.bounds())}},undo:function(){for(var a=0;a<this.shapes.length;a++){var b=this.shapes[a];b.bounds(this.undoStates[a]),b.hasOwnProperty("layout")&&b.layout(b,this.redoStates[a],this.undoStates[a])}this.adorner&&(this.adorner.refreshBounds(),this.adorner.refresh())},redo:function(){for(var a=0;a<this.shapes.length;a++){var b=this.shapes[a];b.bounds(this.redoStates[a]),b.hasOwnProperty("layout")&&b.layout(b,this.undoStates[a],this.redoStates[a])}this.adorner&&(this.adorner.refreshBounds(),this.adorner.refresh())}}),R=h.extend({init:function(a,b){this.connection=a,this.diagram=b,this.title="New connection"},undo:function(){this.diagram.remove(this.connection,!1)},redo:function(){this.diagram.addConnection(this.connection,!1)}}),S=h.extend({init:function(a,b){this.shape=a,this.diagram=b,this.title="New shape"},undo:function(){this.diagram.remove(this.shape,!1)},redo:function(){this.diagram.addShape(this.shape,{undoable:!1})}}),T=h.extend({init:function(a,b,c){this.initial=a,this["final"]=b,this.diagram=c,this.title="Pan Unit"},undo:function(){this.diagram.pan(this.initial)},redo:function(){this.diagram.pan(this["final"])}}),U=h.extend({init:function(a,b,c){this.shapes=b,this.undoRotates=c,this.title="Rotation",this.redoRotates=[],this.redoAngle=a._angle,this.adorner=a,this.center=a._innerBounds.center();for(var d=0;d<this.shapes.length;d++){var e=this.shapes[d];this.redoRotates.push(e.rotate().angle)}},undo:function(){var a,b;for(a=0;a<this.shapes.length;a++)b=this.shapes[a],b.rotate(this.undoRotates[a],this.center),b.hasOwnProperty("layout")&&b.layout(b);this.adorner&&(this.adorner._initialize(),this.adorner.refresh())},redo:function(){var a,b;for(a=0;a<this.shapes.length;a++)b=this.shapes[a],b.rotate(this.redoRotates[a],this.center),b.hasOwnProperty("layout")&&b.layout(b);this.adorner&&(this.adorner._initialize(),this.adorner.refresh())}}),V=h.extend({init:function(a,b,c){this.diagram=a,this.indices=c,this.items=b,this.title="Rotate Unit"},undo:function(){this.diagram._toIndex(this.items,this.indices)},redo:function(){this.diagram.toFront(this.items,!1)}}),W=h.extend({init:function(a,b,c){this.diagram=a,this.indices=c,this.items=b,this.title="Rotate Unit"},undo:function(){this.diagram._toIndex(this.items,this.indices)},redo:function(){this.diagram.toBack(this.items,!1)}}),X=h.extend({init:function(){this.stack=[],this.index=0,this.capacity=100},begin:function(){this.composite=new K},cancel:function(){this.composite=b},commit:function(){this.composite.units.length>0&&this._restart(this.composite),this.composite=b},addCompositeItem:function(a){this.composite?this.composite.add(a):this.add(a)},add:function(a,b){this._restart(a,b)},count:function(){return this.stack.length},undo:function(){this.index>0&&(this.index--,this.stack[this.index].undo())},redo:function(){this.stack.length>0&&this.index<this.stack.length&&(this.stack[this.index].redo(),this.index++)},_restart:function(a,b){this.stack.splice(this.index,this.stack.length-this.index),this.stack.push(a),n(b)||b&&b===!0?this.redo():this.index++,this.stack.length>this.capacity&&(this.stack.splice(0,this.stack.length-this.capacity),this.index=this.capacity)},clear:function(){this.stack=[],this.index=0}}),Y=h.extend({init:function(a){this.toolService=a},start:function(){},move:function(){},end:function(){},doubleClick:function(){},tryActivate:function(a,b){return!1},getCursor:function(){return u.arrow}}),Z=Y.extend({init:function(a){Y.fn.init.call(this,a)},tryActivate:function(a,c){return this.toolService.hoveredItem===b&&c.ctrlKey},start:function(a){this.toolService.isPanning=!0,this.panStart=this.toolService.diagram._pan,this.panOffset=a,this.panDelta=new o},move:function(a){var b=this.toolService.diagram;this.panDelta=a.plus(this.panDelta).minus(this.panOffset),b.pan(this.panStart.plus(this.panDelta),{delta:a.minus(this.panOffset).times(1/this.toolService.diagram.zoom())})},end:function(){var a=this.toolService.diagram;a.undoRedoService.begin(),a.undoRedoService.add(new T(this.panStart,a._pan,a)),a.undoRedoService.commit(),this.toolService.isPanning=!1},getCursor:function(){return u.move}}),$=Y.extend({init:function(b){var c=this;Y.fn.init.call(c,b);var d=c.toolService.diagram,e=d.canvas,f=d.scroller=c.scroller=a(d.scrollable).joyMobileScroller({scroll:a.proxy(c._move,c)}).data("joyMobileScroller");c.movableCanvas=new t(e.element);var g=function(a,b,c){a.makeVirtual(),a.virtualSize(b||G,c||H)};g(f.dimensions.x),g(f.dimensions.y),f.disable()},tryActivate:function(a,c){return this.toolService.hoveredItem===b&&c.ctrlKey},start:function(){var a=this.toolService.diagram,b=a.canvas,c=b.size();this.scroller.enable(),this.currentCanvasSize=c},move:function(){},_move:function(a){var b=this,c=b.toolService.diagram,d=c.canvas,e=b.currentCanvasSize||d.size(),f=new o(a.scrollLeft,a.scrollTop),g=new k(f.x,f.y,parseInt(e.width,10),parseInt(e.height,10));

c._storePan(f.times(-1)),b.movableCanvas.moveTo(f),d.viewBox(g)},end:function(){this.currentCanvasSize=b,this.scroller.disable()},getCursor:function(){return u.move}}),_=h.extend({init:function(a){this.toolService=a},tryActivate:function(a,b){return!0},start:function(a,b){var d=this.toolService.diagram,e=this.toolService.hoveredItem;e&&(c(e,b),e.adorner&&(this.adorner=e.adorner,this.handle=this.adorner._hitTest(a))),this.handle||(this.handle=d._resizingAdorner._hitTest(a),this.handle&&(this.adorner=d._resizingAdorner)),this.adorner&&this.adorner.start(a)},move:function(a){var b=this;this.adorner&&this.adorner.move(b.handle,a)},end:function(a,c){var d,e=this.toolService.diagram,f=this.toolService;this.adorner&&(d=this.adorner.stop(),d&&e.undoRedoService.add(d,!1)),f.hoveredItem&&this.toolService.triggerClick({item:f.hoveredItem,point:a,meta:c}),this.adorner=b,this.handle=b},getCursor:function(a){return this.toolService.hoveredItem?this.toolService.hoveredItem._getCursor(a):u.arrow}}),aa=h.extend({init:function(a){this.toolService=a},tryActivate:function(a,c){return this.toolService.diagram._canRectSelect()&&this.toolService.hoveredItem===b&&this.toolService.hoveredAdorner===b},start:function(a){var b=this.toolService.diagram;b.select(!1),b.selector.start(a)},move:function(a){var b=this.toolService.diagram;b.selector.move(a)},end:function(a,b){var c=this.toolService.diagram,d=this.toolService.hoveredItem,e=c.selector.bounds();d&&d.isSelected||b.ctrlKey||c.select(!1),e.isEmpty()||c.select(e),c.selector.end()},getCursor:function(){return u.arrow}}),ba=h.extend({init:function(a){this.toolService=a,this.type="ConnectionTool"},tryActivate:function(a,b){return this.toolService._hoveredConnector&&!b.ctrlKey},start:function(a,b){var d=this.toolService.diagram,e=this.toolService._hoveredConnector,f=d.connect(e._c,a);this.toolService._connectionManipulation(f,e._c.shape,!0),this.toolService._removeHover(),c(this.toolService.activeConnection,b)},move:function(a){return this.toolService.activeConnection.target(a),!0},end:function(){var a=this.toolService.activeConnection,b=this.toolService.hoveredItem,c=this.toolService._hoveredConnector;c&&c._c!=a.sourceConnector?a.target(c._c):b&&a.target(b),this.toolService._connectionManipulation()},getCursor:function(){return u.arrow}}),ca=h.extend({init:function(a){this.toolService=a,this.type="ConnectionTool"},tryActivate:function(a,b){var c=this.toolService.hoveredItem,d=c&&c.path;return d&&(this._c=c),d},start:function(a,b){c(this._c,b),this.handle=this._c.adorner._hitTest(a),this._c.adorner.start(a)},move:function(a){return this._c.adorner.move(this.handle,a),!0},end:function(a,b){this.toolService.triggerClick({item:this._c,point:a,meta:b});var c=this._c.adorner.stop(a);this.toolService.diagram.undoRedoService.add(c,!1)},getCursor:function(){return u.move}}),da=Y.extend({init:function(a){Y.fn.init.call(this,a)},doubleClick:function(){this.toolService.diagram.editor(this.toolService.hoveredItem)},tryActivate:function(a,b){return b.doubleClick&&this.toolService.hoveredItem}}),ea=h.extend({init:function(a){this.diagram=a,this.tools=[new da(this),a.options.useScroller?new $(this):new Z(this),new ca(this),new ba(this),new aa(this),new _(this)],this.activeTool=b},start:function(a,b){return b=s({},b),this._updateHoveredItem(a),this._activateTool(a,b),this.activeTool.start(a,b),this._updateCursor(a),this.diagram.focus(),this.startPoint=a,!0},move:function(a,b){b=s({},b);var c=!0;return this.activeTool&&(c=this.activeTool.move(a,b)),c&&this._updateHoveredItem(a),this._updateCursor(a),!0},end:function(a,c){return c=s({},c),this.activeTool&&this.activeTool.end(a,c),this.activeTool=b,this._updateCursor(a),!0},doubleClick:function(a,b){this._activateTool(a,s(b,{doubleClick:!0})),this.activeTool.doubleClick&&this.activeTool.doubleClick(a,b),this._updateCursor(a)},keyDown:function(a,b){var c=this.diagram;if(b=s({ctrlKey:!1,metaKey:!1,altKey:!1},b),!b.ctrlKey&&!b.metaKey||b.altKey){if(46===a||8===a)return c.remove(c.select(),!0),!0;if(27===a)return this._discardNewConnection(),c.select(!1),!0}else{if(d(a,"a"))return c.select("All"),!0;if(d(a,"z"))return c.undo(),!0;if(d(a,"y"))return c.redo(),!0;d(a,"c")?c.copy():d(a,"x")?c.cut():d(a,"v")?c.paste():d(a,"l")?c.layout():d(a,"d")&&(c.copy(),c.paste())}},wheel:function(a,b){var c=this.diagram,d=b.delta,e=c.zoom(),f=c.options.zoomRate,g={location:a,meta:b,zoom:e};return c.trigger(E,g),0>d?e*=f:e/=f,e=Math.round(10*Math.max(.7,Math.min(2,e)))/10,g.zoom=e,c.zoom(e,g),c.trigger(F,g),!0},setTool:function(a,b){a.toolService=this,this.tools[b]=a},triggerClick:function(a){this.startPoint.equals(a.point)&&this.diagram.trigger("click",a)},_discardNewConnection:function(){this.newConnection&&(this.diagram.remove(this.newConnection),this.newConnection=b)},_activateTool:function(a,b){for(var c=0;c<this.tools.length;c++){var d=this.tools[c];if(d.tryActivate(a,b)){this.activeTool=d;break}}},_updateCursor:function(b){var c=this.activeTool?this.activeTool.getCursor(b):this.hoveredAdorner?this.hoveredAdorner._getCursor(b):this.hoveredItem?this.hoveredItem._getCursor(b):u.arrow;a(this.diagram.canvas.domElement).css({cursor:c})},_connectionManipulation:function(a,c,d){this.activeConnection=a,this.disabledShape=c,this.newConnection=d?this.activeConnection:b},_updateHoveredItem:function(a){var c=this._hitTest(a);c==this.hoveredItem||this.disabledShape&&c==this.disabledShape||(this.hoveredItem&&this.hoveredItem._hover(!1),c&&c.options.enable?(this.hoveredItem=c,this.hoveredItem._hover(!0)):this.hoveredItem=b)},_removeHover:function(){this.hoveredItem&&(this.hoveredItem._hover(!1),this.hoveredItem=b)},_hitTest:function(a){var c,d,e,f=this.diagram;if(this._hoveredConnector&&(this._hoveredConnector._hover(!1),this._hoveredConnector=b),f._connectorsAdorner._visible&&(c=f._connectorsAdorner._hitTest(a)))return c;if(c=this.diagram._resizingAdorner._hitTest(a)){if(this.hoveredAdorner=f._resizingAdorner,0!==c.x&&0!==c.y)return;c=b}else this.hoveredAdorner=b;if(!this.activeTool||"ConnectionTool"!==this.activeTool.type){var h=[];for(e=0;e<f._selectedItems.length;e++)d=f._selectedItems[e],d instanceof g.Connection&&h.push(d);c=this._hitTestItems(h,a)}return c||this._hitTestItems(f.shapes,a)||this._hitTestItems(f.connections,a)},_hitTestItems:function(a,b){var c,d,e;for(c=a.length-1;c>=0;c--)if(d=a[c],e=d._hitTest(b))return e}}),fa=f.Class.extend({init:function(){}}),ga=fa.extend({init:function(a){var b=this;fa.fn.init.call(b),this.connection=a},hitTest:function(a){var b=this.getBounds().inflate(10);return b.contains(a)?g.Geometry.distanceToPolyline(a,this.connection.allPoints())<v:!1},getBounds:function(){for(var a=this.connection.allPoints(),b=a[0],c=a[a.length-1],d=Math.max(b.x,c.x),e=Math.min(b.x,c.x),f=Math.min(b.y,c.y),g=Math.max(b.y,c.y),h=1;h<a.length-1;++h)d=Math.max(d,a[h].x),e=Math.min(e,a[h].x),f=Math.min(f,a[h].y),g=Math.max(g,a[h].y);return new k(e,f,d-e,g-f)}}),ha=ga.extend({init:function(a){var b=this;ga.fn.init.call(b),this.connection=a},route:function(){}}),ia=ga.extend({init:function(a){var b=this;ga.fn.init.call(b),this.connection=a},route:function(){function a(){if(null!==k){if(k===y||k===z)return!0;if(k===x||k===A)return!1}return Math.abs(e.x-f.x)>Math.abs(e.y-f.y)}var b,c,d=this.connection,e=this.connection.sourcePoint(),f=this.connection.targetPoint(),g=[e,e,f,f],h=f.x-e.x,i=f.y-e.y,j=g.length,k=null,l=null;if(m.isDefined(d._resolvedSourceConnector)&&(k=d._resolvedSourceConnector.options.name),m.isDefined(d._resolvedTargetConnector)&&(l=d._resolvedTargetConnector.options.name),null!==k&&null!==l&&m.contains(B,k)&&m.contains(B,l))this.connection.points(k===x||k==A?l==x||l==A?[new o(e.x,e.y+i/2),new o(f.x,e.y+i/2)]:[new o(e.x,e.y+i)]:l==z||l==y?[new o(e.x+h/2,e.y),new o(e.x+h/2,e.y+i)]:[new o(f.x,e.y)]);else{this.connection.cascadeStartHorizontal=a(this.connection);for(var n=1;j-1>n;++n)d.cascadeStartHorizontal?n%2!==0?(b=h/(j/2),c=0):(b=0,c=i/((j-1)/2)):n%2!==0?(b=0,c=i/(j/2)):(b=h/((j-1)/2),c=0),g[n]=new o(g[n-1].x+b,g[n-1].y+c);n--,g[j-2]=d.cascadeStartHorizontal&&n%2!==0||!d.cascadeStartHorizontal&&n%2===0?new o(g[j-1].x,g[j-2].y):new o(g[j-2].x,g[j-1].y),this.connection.points([g[1],g[2]])}}}),ja=h.extend({init:function(a,b){var c=this;c.diagram=a,c.options=s({},c.options,b),c.visual=new i,c.diagram._adorners.push(c)},refresh:function(){}}),ka=ja.extend({init:function(a,b){var c,d=this;d.connection=a,c=d.connection.diagram,d._ts=c.toolService,ja.fn.init.call(d,c,b);var e=d.connection.sourcePoint(),f=d.connection.targetPoint();d.spVisual=new p(s(d.options.handles,{center:e})),d.epVisual=new p(s(d.options.handles,{center:f})),d.visual.append(d.spVisual),d.visual.append(d.epVisual)},options:{handles:{}},_getCursor:function(){return u.move},start:function(a){switch(this.handle=this._hitTest(a),this.startPoint=a,this._initialSource=this.connection.source(),this._initialTarget=this.connection.target(),this.handle){case-1:this.connection.targetConnector&&this._ts._connectionManipulation(this.connection,this.connection.targetConnector.shape);break;case 1:this.connection.sourceConnector&&this._ts._connectionManipulation(this.connection,this.connection.sourceConnector.shape)}},move:function(a,b){switch(a){case-1:this.connection.source(b);break;case 1:this.connection.target(b);break;default:var c=b.minus(this.startPoint);this.startPoint=b,this.connection.sourceConnector||this.connection.source(this.connection.sourcePoint().plus(c)),this.connection.targetConnector||this.connection.target(this.connection.targetPoint().plus(c))}return this.refresh(),!0},stop:function(a){var c,d=this.diagram.toolService,e=d.hoveredItem;if(c=d._hoveredConnector?d._hoveredConnector._c:e&&!e.line?e:a,this.handle!==b)switch(this.handle){case-1:this.connection.source(c);break;case 1:this.connection.target(c)}return this.handle=b,this._ts._connectionManipulation(),new N(this.connection,this._initialSource,this._initialTarget)},_hitTest:function(a){var b=this.connection.sourcePoint(),c=this.connection.targetPoint(),d=this.options.handles.width/2,e=this.options.handles.height/2,f=new k(b.x,b.y).inflate(d,e),g=new k(c.x,c.y).inflate(d,e);return f.contains(a)?-1:g.contains(a)?1:0},refresh:function(){this.spVisual.redraw({center:this.diagram.modelToLayer(this.connection.sourcePoint())}),this.epVisual.redraw({center:this.diagram.modelToLayer(this.connection.targetPoint())})}}),la=ja.extend({init:function(a,b){var c=this;ja.fn.init.call(c,a,b),c._refreshHandler=function(a){a.item==c.shape&&c.refresh()}},show:function(a){var b,c,d,e=this;for(e._visible=!0,e.shape=a,e.diagram.bind(D,e._refreshHandler),b=a.connectors.length,e.connectors=[],e.visual.clear(),c=0;b>c;c++)d=new oa(a.connectors[c]),e.connectors.push(d),e.visual.append(d.visual);e.visual.visible(!0),e.refresh()},destroy:function(){var a=this;a.diagram.unbind(D,a._refreshHandler),a.shape=b,a._visible=b,a.visual.visible(!1)},_hitTest:function(a){var b,c;for(c=0;c<this.connectors.length;c++)if(b=this.connectors[c],b._hitTest(a)){b._hover(!0),this.diagram.toolService._hoveredConnector=b;break}},refresh:function(){if(this.shape){var b=this.shape.bounds();b=this.diagram.modelToLayer(b),this.visual.position(b.topLeft()),a.each(this.connectors,function(){this.refresh()})}}}),ma=ja.extend({init:function(a,b){var c=this;ja.fn.init.call(c,a,b),c._manipulating=!1,c.map=[],c.shapes=[],c.rect=new l(b.editable.select),c.visual.append(c.rect),c._createHandles(),c.text=new j,c.visual.append(c.text),c._createThumb(),c.redraw(),c.diagram.bind("select",function(a){c._initialize(a.selected)}),c._refreshHandler=function(){c._internalChange||(c.refreshBounds(),c.refresh())},c._rotatedHandler=function(){1==c.shapes.length&&(c._angle=c.shapes[0].rotate().angle),c._refreshHandler()},c.diagram.bind(D,c._refreshHandler).bind(C,c._rotatedHandler),c.refreshBounds(),c.refresh()},options:{editable:{rotate:{thumb:{data:"M7.115,16C3.186,16,0,12.814,0,8.885C0,5.3,2.65,2.336,6.099,1.843V0l4.85,2.801l-4.85,2.8V3.758 c-2.399,0.473-4.21,2.588-4.21,5.126c0,2.886,2.34,5.226,5.226,5.226s5.226-2.34,5.226-5.226c0-1.351-0.513-2.582-1.354-3.51 l1.664-0.961c0.988,1.222,1.581,2.777,1.581,4.472C14.23,12.814,11.045,16,7.115,16L7.115,16z",y:-30}}},offset:10},_createThumb:function(){var a=this,b=a.options.editable,c=b.rotate;b&&c&&(a.rotationThumb=new q(c.thumb),a.visual.append(a.rotationThumb))},_createHandles:function(){var b,c,d,e,f=this.options.editable;if(f&&f.resize)for(b=f.resize.handles,e=-1;1>=e;e++)for(d=-1;1>=d;d++)(0!==e||0!==d)&&(c=new l(b),c.domElement._hover=a.proxy(this._hover,this),this.map.push({x:e,y:d,visual:c}),this.visual.append(c))},bounds:function(a){return a?(this._innerBounds=a.clone(),void(this._bounds=this.diagram.modelToLayer(a).inflate(this.options.offset,this.options.offset))):this._bounds},_hitTest:function(a){var b,c,d,e,f=this.diagram.modelToLayer(a),g=this.options.editable,h=this.map.length;if(this._angle&&(f=f.clone().rotate(this._bounds.center(),this._angle)),g&&g.rotate&&this._rotationThumbBounds&&this._rotationThumbBounds.contains(f))return new o(-1,-2);if(g&&g.resize)for(b=0;h>b;b++)if(e=this.map[b],c=new o(e.x,e.y),d=this._getHandleBounds(c),d.offset(this._bounds.x,this._bounds.y),d.contains(f))return c;return this._bounds.contains(f)?new o(0,0):void 0},_getHandleBounds:function(a){var b=this.options.editable;if(b&&b.resize){var c=b.resize.handles||{},d=c.width,e=c.height,f=new k(0,0,d,e);return a.x<0?f.x=-d/2:0===a.x?f.x=Math.floor(this._bounds.width/2)-d/2:a.x>0&&(f.x=this._bounds.width+1-d/2),a.y<0?f.y=-e/2:0===a.y?f.y=Math.floor(this._bounds.height/2)-e/2:a.y>0&&(f.y=this._bounds.height+1-e/2),f}},_getCursor:function(a){var b=this._hitTest(a);if(b&&b.x>=-1&&b.x<=1&&b.y>=-1&&b.y<=1&&this.options.editable&&this.options.editable.resize){var c=this._angle;if(c&&(c=360-c,b.rotate(new o(0,0),c),b=new o(Math.round(b.x),Math.round(b.y))),-1==b.x&&-1==b.y)return"nw-resize";if(1==b.x&&1==b.y)return"se-resize";if(-1==b.x&&1==b.y)return"sw-resize";if(1==b.x&&-1==b.y)return"ne-resize";if(0===b.x&&-1==b.y)return"n-resize";if(0===b.x&&1==b.y)return"s-resize";if(1==b.x&&0===b.y)return"e-resize";if(-1==b.x&&0===b.y)return"w-resize"}return this._manipulating?u.move:u.select},_initialize:function(){var a,b,c=this,d=c.diagram.select();for(c.shapes=[],a=0;a<d.length;a++)b=d[a],b instanceof g.Shape&&(c.shapes.push(b),b._rotationOffset=new o);c._angle=1==c.shapes.length?c.shapes[0].rotate().angle:0,c._startAngle=c._angle,c._rotates(),c._positions(),c.refreshBounds(),c.refresh(),c.redraw()},_rotates:function(){var a,b,c=this;for(c.initialRotates=[],a=0;a<c.shapes.length;a++)b=c.shapes[a],c.initialRotates.push(b.rotate().angle)},_positions:function(){var a,b,c=this;for(c.initialStates=[],a=0;a<c.shapes.length;a++)b=c.shapes[a],c.initialStates.push(b.bounds())},_hover:function(a,b){var c=this.options.editable;if(c&&c.resize){var d=c.resize.handles,e=d.hover,f=d.stroke,g=d.background;a&&m.isDefined(e.stroke)&&(f=s({},f,e.stroke)),a&&m.isDefined(e.background)&&(g=e.background),b.redraw({stroke:f,background:g})}},start:function(a){this._sp=a,this._cp=a,this._lp=a,this._manipulating=!0,this._internalChange=!0,this.shapeStates=[];for(var b=0;b<this.shapes.length;b++){var c=this.shapes[b];this.shapeStates.push(c.bounds())}},redraw:function(){var b,c,d=this,e=d.options.editable,f=e.resize,g=e.rotate,h=e&&f?"inline":"none",i=e&&g?"inline":"none";for(b=0;b<this.map.length;b++)c=this.map[b],a(c.visual.domElement).css("display",h);d.rotationThumb&&a(d.rotationThumb.domElement).css("display",i)},move:function(a,b){var c,d,f,g,h,i,j,l,n,p,q,r=new o,s=new o,t=0;if(-2===a.y&&-1===a.x){for(g=this._innerBounds.center(),this._angle=this._truncateAngle(m.findAngle(g,b)),i=0;i<this.shapes.length;i++)h=this.shapes[i],j=(this._angle+this.initialRotates[i]-this._startAngle)%360,h.rotate(j,g),h.hasOwnProperty("layout")&&h.layout(h),this._rotating=!0;this.refresh()}else{if(this.diagram.options.snap.enabled===!0){var u=this._truncateDistance(b.minus(this._lp));if(0===u.x&&0===u.y)return void(this._cp=b);c=u,this._lp=new o(this._lp.x+u.x,this._lp.y+u.y)}else c=b.minus(this._cp);for(0===a.x&&0===a.y?(s=r=c,d=!0):(this._angle&&c.rotate(new o(0,0),this._angle),-1==a.x?r.x=c.x:1==a.x&&(s.x=c.x),-1==a.y?r.y=c.y:1==a.y&&(s.y=c.y)),d||(n=e(a,this._innerBounds),p=(this._innerBounds.width+c.x*a.x)/this._innerBounds.width,q=(this._innerBounds.height+c.y*a.y)/this._innerBounds.height),i=0;i<this.shapes.length;i++){if(h=this.shapes[i],f=h.bounds(),d)l=this._displaceBounds(f,r,s,d);else{l=f.clone(),l.scale(p,q,n,this._innerBounds.center(),h.rotate().angle);var v=l.center();v.rotate(f.center(),-this._angle),l=new k(v.x-l.width/2,v.y-l.height/2,l.width,l.height)}if(l.width>=h.options.minWidth&&l.height>=h.options.minHeight){var w=f;h.bounds(l),h.hasOwnProperty("layout")&&h.layout(h,w,l),h.rotate(h.rotate().angle),t+=1}}t==i&&(l=this._displaceBounds(this._innerBounds,r,s,d),this.bounds(l),this.refresh()),this._positions()}this._cp=b},_truncatePositionToGuides:function(a){return this.diagram.ruler?this.diagram.ruler.truncatePositionToGuides(a):a},_truncateSizeToGuides:function(a){return this.diagram.ruler?this.diagram.ruler.truncateSizeToGuides(a):a},_truncateAngle:function(a){var b=Math.max(this.diagram.options.snap.angle,5);return this.diagram.options.snap.enabled===!0?Math.floor(a%360/b)*b:a%360},_truncateDistance:function(a){if(a instanceof g.Point)return new g.Point(this._truncateDistance(a.x),this._truncateDistance(a.y));var b=Math.max(this.diagram.options.snap.size,5);return this.diagram.options.snap.enabled===!0?Math.floor(a/b)*b:a},_displaceBounds:function(a,b,c,d){var e,f=a.topLeft().plus(b),g=a.bottomRight().plus(c),h=k.fromPoints(f,g);return d||(e=h.center(),e.rotate(a.center(),-this._angle),h=new k(e.x-h.width/2,e.y-h.height/2,h.width,h.height)),h},stop:function(){var a;if(this._cp!=this._sp)if(this._rotating)a=new U(this,this.shapes,this.initialRotates),this._rotating=!1;else{if(this.diagram.ruler)for(var c=0;c<this.shapes.length;c++){var d=this.shapes[c],e=d.bounds();e=this._truncateSizeToGuides(this._truncatePositionToGuides(e)),d.bounds(e),this.refreshBounds(),this.refresh()}a=new Q(this.shapes,this.shapeStates,this)}return this._manipulating=b,this._internalChange=b,this._rotating=b,a},refreshBounds:function(){var a=1==this.shapes.length?this.shapes[0].bounds().clone():this.diagram.boundingBox(this.shapes,!0);this.bounds(a)},refresh:function(){var b,c,d=this;if(this.shapes.length>0){c=this.bounds(),this.visual.visible(!0),this.visual.position(c.topLeft()),a.each(this.map,function(){b=d._getHandleBounds(new o(this.x,this.y)),this.visual.position(b.topLeft())}),this.visual.position(c.topLeft());var e=new o(c.width/2,c.height/2);if(this.visual.rotate(this._angle,e),this.rect.redraw({width:c.width,height:c.height}),this.rotationThumb){var f=this.options.editable.rotate.thumb;this._rotationThumbBounds=new k(c.center().x,c.y+f.y,0,0).inflate(f.width),this.rotationThumb.redraw({x:c.width/2-f.width/2})}}else this.visual.visible(!1)}}),na=h.extend({init:function(a){this.visual=new l(this.options),this.diagram=a},options:{stroke:{color:"#778899",width:1,dashType:"dash"},background:"none"},start:function(a){this._sp=this._ep=a,this.refresh(),this.diagram._adorn(this,!0)},end:function(){this._sp=this._ep=b,this.diagram._adorn(this,!1)},bounds:function(a){return a&&(this._bounds=a),this._bounds},move:function(a){this._ep=a,this.refresh()},refresh:function(){if(this._sp){var a=k.fromPoints(this.diagram.modelToLayer(this._sp),this.diagram.modelToLayer(this._ep));this.bounds(k.fromPoints(this._sp,this._ep)),this.visual.position(a.topLeft()),this.visual.redraw({height:a.height+1,width:a.width+1})}}}),oa=h.extend({init:function(a){this.options=s({},a.options),this._c=a,this.visual=new p(this.options),this.refresh()},_hover:function(a){var b=this.options,c=b.hover,d=b.stroke,e=b.background;a&&m.isDefined(c.stroke)&&(d=s({},d,c.stroke)),a&&m.isDefined(c.background)&&(e=c.background),this.visual.redraw({stroke:d,background:e})},refresh:function(){var a=this._c.shape.diagram.modelToView(this._c.position()),b=a.minus(this._c.shape.bounds("transformed").topLeft()),c=new k(a.x,a.y,0,0);c.inflate(this.options.width/2,this.options.height/2),this._visualBounds=c,this.visual.redraw({center:new o(b.x,b.y)})},_hitTest:function(a){var b=this._c.shape.diagram.modelToView(a);return this._visualBounds.contains(b)}});s(g,{CompositeUnit:K,TransformUnit:Q,PanUndoUnit:T,AddShapeUnit:S,AddConnectionUnit:R,DeleteShapeUnit:P,DeleteConnectionUnit:O,ContentChangedUndoUnit:L,ConnectionEditAdorner:ka,UndoRedoService:X,ResizingAdorner:ma,Selector:na,ToolService:ea,ConnectorsAdorner:la,LayoutUndoUnit:J,ConnectionEditUnit:M,ToFrontUnit:V,ToBackUnit:W,ConnectionRouterBase:fa,PolylineRouter:ha,CascadingRouter:ia,SelectionTool:aa})}(window.joy.jQuery),function(a,b){var c=window.joy,d=c.dataviz.diagram,e=d.Graph,f=d.Node,g=d.Link,h=c.deepExtend,i=d.Size,j=d.Rect,k=d.Dictionary,l=d.Set,m=d.Graph,n=d.Utils,o=d.Point,p=1e-6,q=Math.PI/180,r=n.contains,s=a.grep,t=c.Class.extend({defaultOptions:{type:"Tree",subtype:"Down",roots:null,animate:!1,limitToView:!1,friction:.9,nodeDistance:50,iterations:300,horizontalSeparation:90,verticalSeparation:50,underneathVerticalTopOffset:15,underneathHorizontalOffset:15,underneathVerticalSeparation:15,grid:{width:1500,offsetX:50,offsetY:50,componentSpacingX:20,componentSpacingY:20},layerSeparation:50,layeredIterations:2,startRadialAngle:0,endRadialAngle:360,radialSeparation:150,radialFirstLevelSeparation:200,keepComponentsInOneRadialLayout:!1,ignoreContainers:!0,layoutContainerChildren:!1,ignoreInvisible:!0,animateTransitions:!1},init:function(){},gridLayoutComponents:function(a){if(!a)throw"No components supplied.";n.forEach(a,function(a){a.calcBounds()}),a.sort(function(a,b){return b.bounds.width-a.bounds.width});for(var b,c=this.options.grid.width,d=this.options.grid.componentSpacingX,e=this.options.grid.componentSpacingY,f=0,g=this.options.grid.offsetX,h=this.options.grid.offsetY,i=g,j=h,k=[],l=[];a.length>0;){i>=c&&(i=g,j+=f+e,f=0);var m=a.pop();for(this.moveToOffset(m,new o(i,j)),b=0;b<m.nodes.length;b++)l.push(m.nodes[b]);for(b=0;b<m.links.length;b++)k.push(m.links[b]);var p=m.bounds,q=p.height;(0>=q||isNaN(q))&&(q=0);var r=p.width;(0>=r||isNaN(r))&&(r=0),q>=f&&(f=q),i+=r+d}return{nodes:l,links:k}},moveToOffset:function(a,b){var c,d,e=a.bounds,f=b.x-e.x,g=b.y-e.y;for(c=0;c<a.nodes.length;c++){var h=a.nodes[c],i=h.bounds();0===i.width&&0===i.height&&0===i.x&&0===i.y&&(i=new j(0,0,0,0)),i.x+=f,i.y+=g,h.bounds(i)}for(c=0;c<a.links.length;c++){var k=a.links[c];if(k.points){var l=[],m=k.points;for(d=0;d<m.length;d++){var n=m[d];n.x+=f,n.y+=g,l.push(n)}k.points=l}}return this.currentHorizontalOffset+=e.width+this.options.grid.offsetX,new o(f,g)},transferOptions:function(a){this.options=c.deepExtend({},this.defaultOptions),n.isUndefined(a)||(this.options=c.deepExtend(this.options,a||{}))}}),u=c.Class.extend({init:function(a){this.nodeMap=new k,this.shapeMap=new k,this.nodes=[],this.edges=[],this.edgeMap=new k,this.finalNodes=[],this.finalLinks=[],this.ignoredConnections=[],this.ignoredShapes=[],this.hyperMap=new k,this.hyperTree=new e,this.finalGraph=null,this.diagram=a},convert:function(a){if(n.isUndefined(this.diagram))throw"No diagram to convert.";return this.options=c.deepExtend({ignoreInvisible:!0,ignoreContainers:!0,layoutContainerChildren:!1},a||{}),this.clear(),this._renormalizeShapes(),this._renormalizeConnections(),this.finalNodes=new k(this.nodes),this.finalLinks=new k(this.edges),this.finalGraph=new e,this.finalNodes.forEach(function(a){this.finalGraph.addNode(a)},this),this.finalLinks.forEach(function(a){this.finalGraph.addExistingLink(a)},this),this.finalGraph},mapConnection:function(a){return this.edgeMap.first(function(b){return r(this.edgeMap.get(b),a)})},mapShape:function(a){for(var b=this.nodeMap.keys(),c=0,d=b.length;d>c;c++){var e=b[c];if(r(this.nodeMap.get(e),a))return e}},getEdge:function(a,b){return n.first(a.links,function(c){return c.getComplement(a)===b})},clear:function(){this.finalGraph=null,this.hyperTree=!this.options.ignoreContainers&&this.options.layoutContainerChildren?new m:null,this.hyperMap=!this.options.ignoreContainers&&this.options.layoutContainerChildren?new k:null,this.nodeMap=new k,this.shapeMap=new k,this.nodes=[],this.edges=[],this.edgeMap=new k,this.ignoredConnections=[],this.ignoredShapes=[],this.finalNodes=[],this.finalLinks=[]},listToRoot:function(a){var b=[],c=a.container;if(!c)return b;for(b.push(c);c.parentContainer;)c=c.parentContainer,b.push(c);return b.reverse(),b},firstNonIgnorableContainer:function(a){return a.isContainer&&!this._isIgnorableItem(a)?a:a.parentContainer?this.firstNonIgnorableContainer(a.parentContainer):null},isContainerConnection:function(a,b){return a.isContainer&&this.isDescendantOf(a,b)?!0:b.isContainer&&this.isDescendantOf(b,a)},isDescendantOf:function(a,b){if(!a.isContainer)throw"Expecting a container.";if(a===b)return!1;if(r(a.children,b))return!0;for(var c=[],d=0,e=a.children.length;e>d;d++){var f=a.children[d];f.isContainer&&this.isDescendantOf(f,b)&&c.push(f)}return c.length>0},isIgnorableItem:function(a){return this.options.ignoreInvisible?a.isCollapsed&&this._isVisible(a)?!1:!a.isCollapsed&&this._isVisible(a)?!1:!0:a.isCollapsed&&!this._isTop(a)},isShapeMapped:function(a){return a.isCollapsed&&!this._isVisible(a)&&!this._isTop(a)},leastCommonAncestor:function(a,b){if(!a)throw"Parameter should not be null.";if(!b)throw"Parameter should not be null.";if(!this.hyperTree)throw"No hypertree available.";var c=this.listToRoot(a),d=this.listToRoot(b),e=null;if(n.isEmpty(c)||n.isEmpty(d))return this.hyperTree.root.data;for(var f=c[0],g=d[0],h=0;f===g&&(e=c[h],h++,!(h>=c.length||h>=d.length));)f=c[h],g=d[h];return e?s(this.hyperTree.nodes,function(a){return a.data.container===e}):this.hyperTree.root.data},_isTop:function(a){return!a.parentContainer},_isVisible:function(a){return a.visible()?a.parentContainer?this._isVisible(a.parentContainer):a.visible():!1},_isCollapsed:function(a){return a.isContainer&&a.isCollapsed?!0:a.parentContainer&&this._isCollapsed(a.parentContainer)},_renormalizeShapes:function(){if(!this.options.ignoreContainers)throw"Containers are not supported yet, but stay tuned.";for(var a=0,b=this.diagram.shapes.length;b>a;a++){var c=this.diagram.shapes[a];if(this.options.ignoreInvisible&&!this._isVisible(c)||c.isContainer)this.ignoredShapes.push(c);else{var d=new f(c.id,c);d.isVirtual=!1,this.nodeMap.add(d,[c]),this.nodes.push(d)}}},_renormalizeConnections:function(){if(0!==this.diagram.connections.length)for(var a=0,b=this.diagram.connections.length;b>a;a++){var c=this.diagram.connections[a];if(this.isIgnorableItem(c))this.ignoredConnections.push(c);else{var d=c.sourceConnector?c.sourceConnector.shape:null,e=c.targetConnector?c.targetConnector.shape:null;if(d&&e)if(!r(this.ignoredShapes,d)||this.shapeMap.containsKey(d))if(!r(this.ignoredShapes,e)||this.shapeMap.containsKey(e)){this.shapeMap.containsKey(d)&&(d=this.shapeMap[d]),this.shapeMap.containsKey(e)&&(e=this.shapeMap[e]);var f=this.mapShape(d),h=this.mapShape(e);if(f===h||this.areConnectedAlready(f,h))this.ignoredConnections.push(c);else{if(null===f||null===h)throw"A shape was not mapped to a node.";if(!this.options.ignoreContainers)throw"Containers are not supported yet, but stay tuned.";if(f.isVirtual||h.isVirtual)this.ignoredConnections.push(c);else{var i=new g(f,h,c.id,c);this.edgeMap.add(i,[c]),this.edges.push(i)}}}else this.ignoredConnections.push(c);else this.ignoredConnections.push(c);else this.ignoredConnections.push(c)}}},areConnectedAlready:function(a,b){return n.any(this.edges,function(c){return c.source===a&&c.target===b||c.source===b&&c.target===a})}}),v=t.extend({init:function(a){var b=this;if(t.fn.init.call(b),n.isUndefined(a))throw"Diagram is not specified.";this.diagram=a},layout:function(a){this.transferOptions(a);var b=new u(this.diagram),c=b.convert(a);if(!c.isEmpty()){var e=c.getConnectedComponents();if(!n.isEmpty(e)){for(var f=0;f<e.length;f++){var g=e[f];this.layoutGraph(g,a)}var h=this.gridLayoutComponents(e);return new d.LayoutState(this.diagram,h)}}},layoutGraph:function(a,b){n.isDefined(b)&&this.transferOptions(b),this.graph=a;var c=9*this.options.nodeDistance;this.temperature=c;var d=this._expectedBounds();this.width=d.width,this.height=d.height;for(var e=0;e<this.options.iterations;e++)this.refineStage=e>=5*this.options.iterations/6,this.tick(),this.temperature=this.refineStage?c/30:c*(1-e/(2*this.options.iterations))},tick:function(){var a;for(a=0;a<this.graph.nodes.length;a++)this._repulsion(this.graph.nodes[a]);for(a=0;a<this.graph.links.length;a++)this._attraction(this.graph.links[a]);for(a=0;a<this.graph.nodes.length;a++){var b=this.graph.nodes[a],c=Math.sqrt(b.dx*b.dx+b.dy*b.dy);if(0===c)return;b.x+=Math.min(c,this.temperature)*b.dx/c,b.y+=Math.min(c,this.temperature)*b.dy/c,this.options.limitToView&&(b.x=Math.min(this.width,Math.max(b.width/2,b.x)),b.y=Math.min(this.height,Math.max(b.height/2,b.y)))}},_shake:function(a){var b=Math.random()*this.options.nodeDistance/4,c=2*Math.random()*Math.PI;a.x+=b*Math.cos(c),a.y-=b*Math.sin(c)},_InverseSquareForce:function(a,b,c){var d;if(this.refineStage){var e=b.x-c.x,f=b.y-c.y,g=b.width/2,h=b.height/2,i=c.width/2,j=c.height/2;d=Math.pow(e,2)/Math.pow(g+i+this.options.nodeDistance,2)+Math.pow(f,2)/Math.pow(h+j+this.options.nodeDistance,2)}else d=Math.pow(a,2)/Math.pow(this.options.nodeDistance,2);return 4*d/3},_SquareForce:function(a,b,c){return 1/this._InverseSquareForce(a,b,c)},_repulsion:function(a){a.dx=0,a.dy=0,n.forEach(this.graph.nodes,function(b){if(b!==a){for(;a.x===b.x&&a.y===b.y;)this._shake(b);var c=a.x-b.x,d=a.y-b.y,e=Math.sqrt(c*c+d*d),f=2*this._SquareForce(e,a,b);a.dx+=c/e*f,a.dy+=d/e*f}},this)},_attraction:function(a){var b=a.target,c=a.source;if(c!==b){for(;c.x===b.x&&c.y===b.y;)this._shake(b);var d=c.x-b.x,e=c.y-b.y,f=Math.sqrt(d*d+e*e),g=5*this._InverseSquareForce(f,c,b),h=d/f*g,i=e/f*g;b.dx+=h,b.dy+=i,c.dx-=h,c.dy-=i}},_expectedBounds:function(){var a,b=this.graph.nodes.length,c=1.5,d=4;if(0===b)return a;a=n.fold(this.graph.nodes,function(a,b){var c=b.width*b.height;return c>0?a+=Math.sqrt(c):0},0,this);var e=a/b,f=e*Math.ceil(Math.sqrt(b)),g=f*Math.sqrt(c),h=f/Math.sqrt(c);return{width:g*d,height:h*d}}}),w=c.Class.extend({init:function(a){this.center=null,this.options=a},layout:function(a,b){if(this.graph=a,this.graph.nodes&&0!==this.graph.nodes.length){if(!r(this.graph.nodes,b))throw"The given root is not in the graph.";this.center=b,this.graph.cacheRelationships(),this.layoutSwitch()}},layoutLeft:function(a){this.setChildrenDirection(this.center,"Left",!1),this.setChildrenLayout(this.center,"Default",!1);var b,c,d,e=0,f=0;for(c=0;c<a.length;c++){d=a[c],d.TreeDirection="Left";var g=this.measure(d,i.Empty);f=Math.max(f,g.Width),e+=g.height+this.options.verticalSeparation}e-=this.options.verticalSeparation;var h=this.center.x-this.options.horizontalSeparation;for(b=this.center.y+(this.center.height-e)/2,c=0;c<a.length;c++){d=a[c];var j=new o(h-d.Size.width,b);this.arrange(d,j),b+=d.Size.height+this.options.verticalSeparation}},layoutRight:function(a){this.setChildrenDirection(this.center,"Right",!1),this.setChildrenLayout(this.center,"Default",!1);var b,c,d,e=0,f=0;for(c=0;c<a.length;c++){d=a[c],d.TreeDirection="Right";var g=this.measure(d,i.Empty);f=Math.max(f,g.Width),e+=g.height+this.options.verticalSeparation}e-=this.options.verticalSeparation;var h=this.center.x+this.options.horizontalSeparation+this.center.width;for(b=this.center.y+(this.center.height-e)/2,c=0;c<a.length;c++){d=a[c];var j=new o(h,b);this.arrange(d,j),b+=d.Size.height+this.options.verticalSeparation}},layoutUp:function(a){this.setChildrenDirection(this.center,"Up",!1),this.setChildrenLayout(this.center,"Default",!1);var b,c,d,e=0;for(d=0;d<a.length;d++){c=a[d],c.TreeDirection="Up";var f=this.measure(c,i.Empty);e+=f.width+this.options.horizontalSeparation}e-=this.options.horizontalSeparation;

var g=this.center.x+this.center.width/2-e/2;for(d=0;d<a.length;d++){c=a[d],b=this.center.y-this.options.verticalSeparation-c.Size.height;var h=new o(g,b);this.arrange(c,h),g+=c.Size.width+this.options.horizontalSeparation}},layoutDown:function(a){var b,c;this.setChildrenDirection(this.center,"Down",!1),this.setChildrenLayout(this.center,"Default",!1);var d,e=0;for(c=0;c<a.length;c++){b=a[c],b.treeDirection="Down";var f=this.measure(b,i.Empty);e+=f.width+this.options.horizontalSeparation}e-=this.options.horizontalSeparation;var g=this.center.x+this.center.width/2-e/2;for(d=this.center.y+this.options.verticalSeparation+this.center.height,c=0;c<a.length;c++){b=a[c];var h=new o(g,d);this.arrange(b,h),g+=b.Size.width+this.options.horizontalSeparation}},layoutRadialTree:function(){this.setChildrenDirection(this.center,"Radial",!1),this.setChildrenLayout(this.center,"Default",!1),this.previousRoot=null;var a=this.options.startRadialAngle*q,b=this.options.endRadialAngle*q;if(a>=b)throw"Final angle should not be less than the start angle.";this.maxDepth=0,this.origin=new o(this.center.x,this.center.y),this.calculateAngularWidth(this.center,0),this.maxDepth>0&&this.radialLayout(this.center,this.options.radialFirstLevelSeparation,a,b),this.center.Angle=b-a},tipOverTree:function(a,b){n.isUndefined(b)&&(b=0),this.setChildrenDirection(this.center,"Down",!1),this.setChildrenLayout(this.center,"Default",!1),this.setChildrenLayout(this.center,"Underneath",!1,b);var c,d,e,f=0;for(e=0;e<a.length;e++){d=a[e],d.TreeDirection="Down";var g=this.measure(d,i.Empty);f+=g.width+this.options.horizontalSeparation}f-=this.options.horizontalSeparation,f-=a[a.length-1].width,f+=a[a.length-1].associatedShape.bounds().width;var h=this.center.x+this.center.width/2-f/2;for(c=this.center.y+this.options.verticalSeparation+this.center.height,e=0;e<a.length;e++){d=a[e];var j=new o(h,c);this.arrange(d,j),h+=d.Size.width+this.options.horizontalSeparation}},calculateAngularWidth:function(a,b){b>this.maxDepth&&(this.maxDepth=b);var c=0,d=1e3,e=1e3,f=0===b?0:Math.sqrt(d*d+e*e)/b;if(a.children.length>0){for(var g=0,h=a.children.length;h>g;g++){var i=a.children[g];c+=this.calculateAngularWidth(i,b+1)}c=Math.max(f,c)}else c=f;return a.sectorAngle=c,c},sortChildren:function(a){var b,c=0;if(a.parents.length>1)throw"Node is not part of a tree.";var d=a.parents[0];if(d){var e=new o(d.x,d.y),f=new o(a.x,a.y);c=this.normalizeAngle(Math.atan2(e.y-f.y,e.x-f.x))}var g=a.children.length;if(0===g)return null;var h=[],i=[];for(b=0;g>b;++b){var j=a.children[b],k=new o(j.x,j.y);i[b]=b,h[b]=this.normalizeAngle(-c+Math.atan2(k.y-k.y,k.x-k.x))}n.bisort(h,i);var l=[],m=a.children;for(b=0;g>b;++b)l.push(m[i[b]]);return l},normalizeAngle:function(a){for(;a>2*Math.PI;)a-=2*Math.PI;for(;0>a;)a+=2*Math.PI;return a},radialLayout:function(a,b,c,d){for(var e=d-c,f=e/2,g=a.sectorAngle,h=0,i=this.sortChildren(a),j=0,k=i.length;k>j;j++){var l=i[j],m=l,n=m.sectorAngle/g;l.children.length>0&&this.radialLayout(l,b+this.options.radialSeparation,c+h*e,c+(h+n)*e),this.setPolarLocation(l,b,c+h*e+n*f),m.angle=n*e,h+=n}},setPolarLocation:function(a,b,c){a.x=this.origin.x+b*Math.cos(c),a.y=this.origin.y+b*Math.sin(c),a.BoundingRectangle=new j(a.x,a.y,a.width,a.height)},setChildrenDirection:function(a,b,c){var d=a.treeDirection;this.graph.depthFirstTraversal(a,function(a){a.treeDirection=b}),c||(a.treeDirection=d)},setChildrenLayout:function(a,b,c,d){n.isUndefined(d)&&(d=0);var e=a.childrenLayout;d>0?(this.graph.assignLevels(a),this.graph.depthFirstTraversal(a,function(a){a.level>=d+1&&(a.childrenLayout=b)})):(this.graph.depthFirstTraversal(a,function(a){a.childrenLayout=b}),c||(a.childrenLayout=e))},measure:function(a,b){var c,d=0,e=0,f=new i(0,0);if(!a)throw"";var g=a.associatedShape.bounds(),h=g.width,j=g.height;if(1!==a.parents.length)throw"Node not in a spanning tree.";var k=a.parents[0];if("Undefined"===a.treeDirection&&(a.treeDirection=k.treeDirection),n.isEmpty(a.children))f=new i(Math.abs(h)<p?50:h,Math.abs(j)<p?25:j);else if(1===a.children.length){switch(a.treeDirection){case"Radial":c=this.measure(a.children[0],b),d=h+this.options.radialSeparation*Math.cos(a.AngleToParent)+c.width,e=j+Math.abs(this.options.radialSeparation*Math.sin(a.AngleToParent))+c.height;break;case"Left":case"Right":switch(a.childrenLayout){case"TopAlignedWithParent":break;case"BottomAlignedWithParent":break;case"Underneath":c=this.measure(a.children[0],b),d=h+c.width+this.options.underneathHorizontalOffset,e=j+this.options.underneathVerticalTopOffset+c.height;break;case"Default":c=this.measure(a.children[0],b),d=h+this.options.horizontalSeparation+c.width,e=Math.max(j,c.height);break;default:throw"Unhandled TreeDirection in the Radial layout measuring."}break;case"Up":case"Down":switch(a.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":c=this.measure(a.children[0],b),d=Math.max(h,c.width+this.options.underneathHorizontalOffset),e=j+this.options.underneathVerticalTopOffset+c.height;break;case"Default":c=this.measure(a.children[0],b),e=j+this.options.verticalSeparation+c.height,d=Math.max(h,c.width);break;default:throw"Unhandled TreeDirection in the Down layout measuring."}break;default:throw"Unhandled TreeDirection in the layout measuring."}f=new i(d,e)}else{var l,m;switch(a.treeDirection){case"Left":case"Right":switch(a.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(d=h,e=j+this.options.underneathVerticalTopOffset,l=0;l<a.children.length;l++)m=a.children[l],c=this.measure(m,b),d=Math.max(d,c.width+this.options.underneathHorizontalOffset),e+=c.height+this.options.underneathVerticalSeparation;e-=this.options.underneathVerticalSeparation;break;case"Default":for(d=h,e=0,l=0;l<a.children.length;l++)m=a.children[l],c=this.measure(m,b),d=Math.max(d,h+this.options.horizontalSeparation+c.width),e+=c.height+this.options.verticalSeparation;e-=this.options.verticalSeparation;break;default:throw"Unhandled TreeDirection in the Right layout measuring."}break;case"Up":case"Down":switch(a.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(d=h,e=j+this.options.underneathVerticalTopOffset,l=0;l<a.children.length;l++)m=a.children[l],c=this.measure(m,b),d=Math.max(d,c.width+this.options.underneathHorizontalOffset),e+=c.height+this.options.underneathVerticalSeparation;e-=this.options.underneathVerticalSeparation;break;case"Default":for(d=0,e=0,l=0;l<a.children.length;l++)m=a.children[l],c=this.measure(m,b),d+=c.width+this.options.horizontalSeparation,e=Math.max(e,c.height+this.options.verticalSeparation+j);d-=this.options.horizontalSeparation;break;default:throw"Unhandled TreeDirection in the Down layout measuring."}break;default:throw"Unhandled TreeDirection in the layout measuring."}f=new i(d,e)}return a.SectorAngle=Math.sqrt(d*d/4+e*e/4),a.Size=f,f},arrange:function(a,b){var c,d,e,f,g,h=a.associatedShape.bounds(),i=h.width,k=h.height;if(n.isEmpty(a.children))a.x=b.x,a.y=b.y,a.BoundingRectangle=new j(b.x,b.y,i,k);else{var l,m,q;switch(a.treeDirection){case"Left":switch(a.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(q=b,a.x=q.x,a.y=q.y,a.BoundingRectangle=new j(a.x,a.y,a.width,a.height),m=b.y+k+this.options.underneathVerticalTopOffset,c=0;c<f.children.length;c++)f=f.children[c],l=q.x-f.associatedShape.width-this.options.underneathHorizontalOffset,d=new o(l,m),this.arrange(f,d),m+=f.Size.height+this.options.underneathVerticalSeparation;break;case"Default":for(q=new o(b.x+a.Size.width-i,b.y+(a.Size.height-k)/2),a.x=q.x,a.y=q.y,a.BoundingRectangle=new j(a.x,a.y,a.width,a.height),l=q.x-this.options.horizontalSeparation,m=b.y,c=0;c<a.children.length;c++)f=a.children[c],d=new o(l-f.Size.width,m),this.arrange(f,d),m+=f.Size.height+this.options.verticalSeparation;break;default:throw"Unsupported TreeDirection"}break;case"Right":switch(a.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(q=b,a.x=q.x,a.y=q.y,a.BoundingRectangle=new j(a.x,a.y,a.width,a.height),l=b.x+i+this.options.underneathHorizontalOffset,m=b.y+k+this.options.underneathVerticalTopOffset,c=0;c<a.children.length;c++)f=a.children[c],d=new o(l,m),this.arrange(f,d),m+=f.Size.height+this.options.underneathVerticalSeparation;break;case"Default":for(q=new o(b.x,b.y+(a.Size.height-k)/2),a.x=q.x,a.y=q.y,a.BoundingRectangle=new j(a.x,a.y,a.width,a.height),l=b.x+i+this.options.horizontalSeparation,m=b.y,c=0;c<a.children.length;c++)f=a.children[c],d=new o(l,m),this.arrange(f,d),m+=f.Size.height+this.options.verticalSeparation;break;default:throw"Unsupported TreeDirection"}break;case"Up":if(q=new o(b.x+(a.Size.width-i)/2,b.y+a.Size.height-k),a.x=q.x,a.y=q.y,a.BoundingRectangle=new j(a.x,a.y,a.width,a.height),Math.abs(q.x-b.x)<p){for(g=0,c=0;c<a.children.length;c++)e=a.children[c],g+=e.Size.width+this.options.horizontalSeparation;g-=this.options.horizontalSeparation,l=b.x+(i-g)/2}else l=b.x;for(c=0;c<a.children.length;c++)f=a.children[c],m=q.y-this.options.verticalSeparation-f.Size.height,d=new o(l,m),this.arrange(f,d),l+=f.Size.width+this.options.horizontalSeparation;break;case"Down":switch(a.childrenLayout){case"TopAlignedWithParent":case"BottomAlignedWithParent":break;case"Underneath":for(q=b,a.x=q.x,a.y=q.y,a.BoundingRectangle=new j(a.x,a.y,a.width,a.height),l=b.x+this.options.underneathHorizontalOffset,m=b.y+k+this.options.underneathVerticalTopOffset,c=0;c<a.children.length;c++)f=a.children[c],d=new o(l,m),this.arrange(f,d),m+=f.Size.height+this.options.underneathVerticalSeparation;break;case"Default":if(q=new o(b.x+(a.Size.width-i)/2,b.y),a.x=q.x,a.y=q.y,a.BoundingRectangle=new j(a.x,a.y,a.width,a.height),Math.abs(q.x-b.x)<p){for(g=0,c=0;c<a.children.length;c++)e=a.children[c],g+=e.Size.width+this.options.horizontalSeparation;g-=this.options.horizontalSeparation,l=b.x+(i-g)/2}else l=b.x;for(c=0;c<a.children.length;c++)f=a.children[c],m=q.y+this.options.verticalSeparation+k,d=new o(l,m),this.arrange(f,d),l+=f.Size.width+this.options.horizontalSeparation;break;default:throw"Unsupported TreeDirection"}break;case"None":break;default:throw"Unsupported TreeDirection"}}},layoutSwitch:function(){if(this.center&&!n.isEmpty(this.center.children)){var a=this.options.subtype;n.isUndefined(a)&&(a="Down");var b,c,d,e,f=this.center.children;switch(a.toLowerCase()){case"radial":case"radialtree":this.layoutRadialTree();break;case"mindmaphorizontal":case"mindmap":b=this.center.children,1===this.center.children.length?this.layoutRight(b):(e=f.length/2,c=s(this.center.children,function(a){return n.indexOf(f,a)<e}),d=s(this.center.children,function(a){return n.indexOf(f,a)>=e}),this.layoutLeft(c),this.layoutRight(d));break;case"mindmapvertical":b=this.center.children,1===this.center.children.length?this.layoutDown(b):(e=f.length/2,c=s(this.center.children,function(a){return n.indexOf(f,a)<e}),d=s(this.center.children,function(a){return n.indexOf(f,a)>=e}),this.layoutUp(c),this.layoutDown(d));break;case"right":this.layoutRight(this.center.children);break;case"left":this.layoutLeft(this.center.children);break;case"up":case"bottom":this.layoutUp(this.center.children);break;case"down":case"top":this.layoutDown(this.center.children);break;case"tipover":case"tipovertree":if(this.options.tipOverTreeStartLevel<0)throw"The tip-over level should be a positive integer.";this.tipOverTree(this.center.children,this.options.tipOverTreeStartLevel);break;case"undefined":case"none":}}}}),x=t.extend({init:function(a){var b=this;if(t.fn.init.call(b),n.isUndefined(a))throw"No diagram specified.";this.diagram=a},layout:function(a){this.transferOptions(a);var b=new u(this.diagram);this.graph=b.convert();var c=this.layoutComponents();return new d.LayoutState(this.diagram,c)},layoutComponents:function(){if(!this.graph.isEmpty()){var a=this.graph.getConnectedComponents();if(!n.isEmpty(a)){for(var b=new w(this.options),c=[],d=0;d<a.length;d++){var e=a[d],f=this.getTree(e);if(!f)throw"Failed to find a spanning tree for the component.";var g=f.root,h=f.tree;b.layout(h,g),c.push(h)}return this.gridLayoutComponents(c)}}},getTree:function(a){var b=null;if(this.options.roots&&this.options.roots.length>0)for(var c=0,d=a.nodes.length;d>c;c++)for(var e=a.nodes[c],f=0;f<this.options.roots.length;f++){var g=this.options.roots[f];if(g===e.associatedShape){b=e;break}}if(!b&&(b=a.root(),!b))throw"Unable to find a root for the tree.";return this.getTreeForRoot(a,b)},getTreeForRoot:function(a,b){var c=a.getSpanningTree(b);return n.isUndefined(c)||c.isEmpty()?null:{tree:c,root:c.root}}}),y=t.extend({init:function(a){var b=this;if(t.fn.init.call(b),n.isUndefined(a))throw"Diagram is not specified.";this.diagram=a},layout:function(a){this.transferOptions(a);var b=new u(this.diagram),c=b.convert(a);if(!c.isEmpty()){var e=c.getConnectedComponents();if(!n.isEmpty(e)){for(var f=0;f<e.length;f++){var g=e[f];this.layoutGraph(g,a)}var h=this.gridLayoutComponents(e);return new d.LayoutState(this.diagram,h)}}},_initRuntimeProperties:function(){for(var a=0;a<this.graph.nodes.length;a++){var b=this.graph.nodes[a];b.layer=-1,b.downstreamLinkCount=0,b.upstreamLinkCount=0,b.isVirtual=!1,b.uBaryCenter=0,b.dBaryCenter=0,b.upstreamPriority=0,b.downstreamPriority=0,b.gridPosition=0}},_prepare:function(a){var b,c,d,e=[];for(c=0;c<a.links.length;c++)a.links[c].depthOfDumminess=0;var f=new k;for(n.forEach(a.nodes,function(a){0===a.incoming.length&&(f.set(a,0),e.push(a))});e.length>0;){var g=e.shift();for(b=0;b<g.outgoing.length;b++){d=g.outgoing[b];var h=d.target;f.containsKey(h)?f.set(h,Math.max(f.get(g)+1,f.get(h))):f.set(h,f.get(g)+1),r(e,h)||e.push(h)}}var i=0;f.forEachValue(function(a){i=Math.max(i,a)});var j=[];n.addRange(j,f.keys()),j.sort(function(a,b){var c=f.get(a),d=f.get(b);return n.sign(d-c)});for(var l=0;l<j.length;++l){var m=j[l],o=Number.MAX_VALUE;if(0!==m.outgoing.length){for(c=0;c<m.outgoing.length;++c)d=m.outgoing[c],o=Math.min(o,f.get(d.target));o>1&&f.set(m,o-1)}}for(this.layers=[],b=0;i+1>b;b++)this.layers.push([]);for(f.forEach(function(a,b){a.layer=b,this.layers[b].push(a)},this),c=0;c<this.layers.length;c++){var p=this.layers[c];for(b=0;b<p.length;b++)p[b].gridPosition=b}},layoutGraph:function(a,b){if(n.isUndefined(a))throw"No graph given or graph analysis of the diagram failed.";n.isDefined(b)&&this.transferOptions(b),this.graph=a,a.setItemIndices();var c=a.makeAcyclic();this._initRuntimeProperties(),this._prepare(a,b),this._dummify(),this._optimizeCrossings(),this._swapPairs(),this.arrangeNodes(),this._moveThingsAround(),this._dedummify(),n.forEach(c,function(a){a.points&&a.points.reverse()})},setMinDist:function(a,b,c){var d=a.layer,e=a.layerIndex;this.minDistances[d][e]=c},getMinDist:function(a,b){for(var c=0,d=a.layerIndex,e=b.layerIndex,f=a.layer,g=Math.min(d,e),h=Math.max(d,e),i=g;h>i;++i)c+=this.minDistances[f][i];return c},placeLeftToRight:function(a){for(var b,c,d=new k,e=0;e<this.layers.length;++e){var f=a[e];if(f){for(b=0;b<f.length;b++)c=f[b],d.containsKey(c)||this.placeLeft(c,d,e);var g=Number.POSITIVE_INFINITY;for(b=0;b<f.length;b++){c=f[b];var h=this.rightSibling(c);h&&this.nodeLeftClass.get(h)!==e&&(g=Math.min(g,d.get(h)-d.get(c)-this.getMinDist(c,h)))}if(g===Number.POSITIVE_INFINITY){var i=[];for(b=0;b<f.length;b++){c=f[b];var j=[];n.addRange(j,this.upNodes.get(c)),n.addRange(j,this.downNodes.get(c));for(var l=0;l<j.length;l++){var m=j[l];this.nodeLeftClass.get(m)<e&&i.push(d.get(m)-d.get(c))}}i.sort(),g=0===i.length?0:i.length%2===1?i[this.intDiv(i.length,2)]:(i[this.intDiv(i.length,2)-1]+i[this.intDiv(i.length,2)])/2}for(b=0;b<f.length;b++)c=f[b],d.set(c,d.get(c)+g)}}return d},placeRightToLeft:function(a){for(var b,c,d=new k,e=0;e<this.layers.length;++e){var f=a[e];if(f){for(b=0;b<f.length;b++)c=f[b],d.containsKey(c)||this.placeRight(c,d,e);var g=Number.NEGATIVE_INFINITY;for(b=0;b<f.length;b++){c=f[b];var h=this.leftSibling(c);h&&this.nodeRightClass.get(h)!==e&&(g=Math.max(g,d.get(h)-d.get(c)+this.getMinDist(h,c)))}if(g===Number.NEGATIVE_INFINITY){var i=[];for(b=0;b<f.length;b++){c=f[b];var j=[];n.addRange(j,this.upNodes.get(c)),n.addRange(j,this.downNodes.get(c));for(var l=0;l<j.length;l++){var m=j[l];this.nodeRightClass.get(m)<e&&i.push(d.get(c)-d.get(m))}}i.sort(),g=0===i.length?0:i.length%2===1?i[this.intDiv(i.length,2)]:(i[this.intDiv(i.length,2)-1]+i[this.intDiv(i.length,2)])/2}for(b=0;b<f.length;b++)c=f[b],d.set(c,d.get(c)+g)}}return d},_getLeftWing:function(){var a={value:null},b=this.computeClasses(a,1);return this.nodeLeftClass=a.value,b},_getRightWing:function(){var a={value:null},b=this.computeClasses(a,-1);return this.nodeRightClass=a.value,b},computeClasses:function(a,b){for(var c=0,d=a.value=new k,e=0;e<this.layers.length;++e){c=e;for(var f=this.layers[e],g=1===b?0:f.length-1;g>=0&&g<f.length;g+=b){var h=f[g];if(d.containsKey(h))c=d.get(h);else if(d.set(h,c),h.isVirtual)for(var i=this._nodesInLink(h),j=0;j<i.length;j++){var l=i[j];d.set(l,c)}}}for(var m=[],n=0;n<this.layers.length;n++)m.push(null);return d.forEach(function(a,b){null===m[b]&&(m[b]=[]),m[b].push(a)}),m},_isVerticalLayout:function(){return"up"===this.options.subtype.toLowerCase()||"down"===this.options.subtype.toLowerCase()||"vertical"===this.options.subtype.toLowerCase()},_isHorizontalLayout:function(){return"right"===this.options.subtype.toLowerCase()||"left"===this.options.subtype.toLowerCase()||"horizontal"===this.options.subtype.toLowerCase()},_isIncreasingLayout:function(){return"right"===this.options.subtype.toLowerCase()||"down"===this.options.subtype.toLowerCase()},_moveThingsAround:function(){function a(a,b){for(var c=Number.MIN_VALUE,d=0;d<a.length;++d){var e=a[d];c=b._isVerticalLayout()?Math.max(c,e.height):Math.max(c,e.width)}return c}var b,c,d,e,f,g;for(c=0;c<this.layers.length;++c)e=this.layers[c],e.sort(this._gridPositionComparer);for(this.minDistances=[],c=0;c<this.layers.length;++c)for(e=this.layers[c],this.minDistances[c]=[],f=0;f<e.length;++f)d=e[f],d.layerIndex=f,this.minDistances[c][f]=this.options.nodeDistance,f<e.length-1&&(this.minDistances[c][f]+=this._isVerticalLayout()?(d.width+e[f+1].width)/2:(d.height+e[f+1].height)/2);for(this.downNodes=new k,this.upNodes=new k,n.forEach(this.graph.nodes,function(a){this.downNodes.set(a,[]),this.upNodes.set(a,[])},this),n.forEach(this.graph.links,function(a){var b=a.source,c=a.target,d=null,e=null;b.layer>c.layer?(d=a.source,e=a.target):(e=a.source,d=a.target),this.downNodes.get(e).push(d),this.upNodes.get(d).push(e)},this),this.downNodes.forEachValue(function(a){a.sort(this._gridPositionComparer)}),this.upNodes.forEachValue(function(a){a.sort(this._gridPositionComparer)}),c=0;c<this.layers.length-1;++c)for(e=this.layers[c],g=0;g<e.length-1;g++){var h=e[g];if(h.isVirtual){var i=this.downNodes.get(h)[0];if(i.isVirtual)for(f=g+1;f<e.length;++f)if(d=e[f],d.isVirtual){var j=this.downNodes.get(d)[0];if(j.isVirtual&&i.gridPosition>j.gridPosition){var l=i.gridPosition;i.gridPosition=j.gridPosition,j.gridPosition=l;var m=i.layerIndex,o=j.layerIndex;this.layers[c+1][m]=j,this.layers[c+1][o]=i,i.layerIndex=o,j.layerIndex=m}}}}var p=this._getLeftWing(),q=this._getRightWing(),r=this.placeLeftToRight(p),s=this.placeRightToLeft(q),t=new k;n.forEach(this.graph.nodes,function(a){t.set(a,(r.get(a)+s.get(a))/2)});var u=new k,v=new k;for(c=0;c<this.layers.length;++c){e=this.layers[c];var w=-1,x=-1;for(f=0;f<e.length;++f)d=e[f],u.set(d,0),v.set(d,!1),d.isVirtual&&(-1===w?w=f:w===f-1?w=f:(x=f,u.set(e[w],0),t.get(d)-t.get(e[w])===this.getMinDist(e[w],d)?v.set(e[w],!0):v.set(e[w],!1),w=f))}var y=[1,-1];n.forEach(y,function(a){for(var c=1===a?0:this.layers.length-1,d=c;d>=0&&d<this.layers.length;d+=a){var e=this.layers[d],f=this._firstVirtualNode(e),g=null,h=null;if(-1!==f)for(g=e[f],h=[],b=0;f>b;b++)h.push(e[b]);else g=null,h=e;if(h.length>0){for(this._sequencer(t,null,g,a,h),b=0;b<h.length-1;++b)this.setMinDist(h[b],h[b+1],t.get(h[b+1])-t.get(h[b]));g&&this.setMinDist(h[h.length-1],g,t.get(g)-t.get(h[h.length-1]))}for(;g;){var i=this.nextVirtualNode(e,g);if(i){if(u.get(g)===a){f=g.layerIndex;var j=i.layerIndex;for(h=[],b=f+1;j>b;b++)h.push(e[b]);h.length>0&&this._sequencer(t,g,i,a,h),v.set(g,!0)}}else{for(f=g.layerIndex,h=[],b=f+1;b<e.length;b++)h.push(e[b]);if(h.length>0){for(this._sequencer(t,g,null,a,h),b=0;b<h.length-1;++b)this.setMinDist(h[b],h[b+1],t.get(h[b+1])-t.get(h[b]));this.setMinDist(g,h[0],t.get(h[0])-t.get(g))}}g=i}this.adjustDirections(d,a,u,v)}},this);var z=this._isIncreasingLayout()?0:this.layers.length-1,A=function(a,b){return b._isIncreasingLayout()?a<b.layers.length:a>=0},B=this._isIncreasingLayout()?1:-1,C=0;for(b=z;A(b,this);b+=B){e=this.layers[b];var D=a(e,this);for(f=0;f<e.length;++f)d=e[f],this._isVerticalLayout()?(d.x=t.get(d),d.y=C+D/2):(d.x=C+D/2,d.y=t.get(d));C+=this.options.layerSeparation+D}},adjustDirections:function(a,b,c,d){if(!(0>a+b||a+b>=this.layers.length))for(var e=null,f=null,g=this.layers[a+b],h=0;h<g.length;++h){var i=g[h];if(i.isVirtual){var j=this.getNeighborOnLayer(i,a);if(j.isVirtual){if(e){for(var k=d.get(f),l=this.layers[a],m=f.layerIndex,n=j.layerIndex,o=m+1;n>o;++o)l[o].isVirtual&&(k=k&&d.get(l[o]));if(k){c.set(e,b);for(var p=e.layerIndex,q=i.layerIndex,r=p+1;q>r;++r)g[r].isVirtual&&c.set(g[r],b)}}e=i,f=j}}}},getNeighborOnLayer:function(a,b){var c=this.upNodes.get(a)[0];return c.layer===b?c:(c=this.downNodes.get(a)[0],c.layer===b?c:null)},_sequencer:function(a,b,c,d,e){if(1===e.length&&this._sequenceSingle(a,b,c,d,e[0]),e.length>1){var f=e.length,g=this.intDiv(f,2);this._sequencer(a,b,c,d,e.slice(0,g)),this._sequencer(a,b,c,d,e.slice(g)),this.combineSequences(a,b,c,d,e)}},_sequenceSingle:function(a,b,c,d,e){var f=-1===d?this.downNodes.get(e):this.upNodes.get(e),g=f.length;0!==g&&(g%2===1?a.set(e,a.get(f[this.intDiv(g,2)])):a.set(e,(a.get(f[this.intDiv(g,2)-1])+a.get(f[this.intDiv(g,2)]))/2),b&&a.set(e,Math.max(a.get(e),a.get(b)+this.getMinDist(b,e))),c&&a.set(e,Math.min(a.get(e),a.get(c)-this.getMinDist(e,c))))},combineSequences:function(a,b,c,d,e){var f,g,h,i,j,k,l=e.length,m=this.intDiv(l,2),n=[];for(f=0;m>f;++f){for(g=0,i=-1===d?this.downNodes.get(e[f]):this.upNodes.get(e[f]),h=0;h<i.length;++h)j=i[h],a.get(j)>=a.get(e[f])?g++:(g--,n.push({k:a.get(j)+this.getMinDist(e[f],e[m-1]),v:2}));n.push({k:a.get(e[f])+this.getMinDist(e[f],e[m-1]),v:g})}b&&n.push({k:a.get(b)+this.getMinDist(b,e[m-1]),v:Number.MAX_VALUE}),n.sort(this._positionDescendingComparer);var o=[];for(f=m;l>f;++f){for(g=0,i=-1===d?this.downNodes.get(e[f]):this.upNodes.get(e[f]),h=0;h<i.length;++h)j=i[h],a.get(j)<=a.get(e[f])?g++:(g--,o.push({k:a.get(j)-this.getMinDist(e[f],e[m]),v:2}));o.push({k:a.get(e[f])-this.getMinDist(e[f],e[m]),v:g})}c&&o.push({k:a.get(c)-this.getMinDist(c,e[m]),v:Number.MAX_VALUE}),o.sort(this._positionAscendingComparer);for(var p=0,q=0,r=this.getMinDist(e[m-1],e[m]);a.get(e[m])-a.get(e[m-1])<r;)if(q>p){if(0===n.length){a.set(e[m-1],a.get(e[m])-r);break}k=n.shift(),p+=k.v,a.set(e[m-1],k.k),a.set(e[m-1],Math.max(a.get(e[m-1]),a.get(e[m])-r))}else{if(0===o.length){a.set(e[m],a.get(e[m-1])+r);break}k=o.shift(),q+=k.v,a.set(e[m],k.k),a.set(e[m],Math.min(a.get(e[m]),a.get(e[m-1])+r))}for(f=m-2;f>=0;f--)a.set(e[f],Math.min(a.get(e[f]),a.get(e[m-1])-this.getMinDist(e[f],e[m-1])));for(f=m+1;l>f;f++)a.set(e[f],Math.max(a.get(e[f]),a.get(e[m])+this.getMinDist(e[f],e[m])))},placeLeft:function(a,b,c){var d=Number.NEGATIVE_INFINITY;n.forEach(this._getComposite(a),function(a){var e=this.leftSibling(a);e&&this.nodeLeftClass.get(e)===this.nodeLeftClass.get(a)&&(b.containsKey(e)||this.placeLeft(e,b,c),d=Math.max(d,b.get(e)+this.getMinDist(e,a)))},this),d===Number.NEGATIVE_INFINITY&&(d=0),n.forEach(this._getComposite(a),function(a){b.set(a,d)})},placeRight:function(a,b,c){var d=Number.POSITIVE_INFINITY;n.forEach(this._getComposite(a),function(a){var e=this.rightSibling(a);e&&this.nodeRightClass.get(e)===this.nodeRightClass.get(a)&&(b.containsKey(e)||this.placeRight(e,b,c),d=Math.min(d,b.get(e)-this.getMinDist(a,e)))},this),d===Number.POSITIVE_INFINITY&&(d=0),n.forEach(this._getComposite(a),function(a){b.set(a,d)})},leftSibling:function(a){var b=this.layers[a.layer],c=a.layerIndex;return 0===c?null:b[c-1]},rightSibling:function(a){var b=this.layers[a.layer],c=a.layerIndex;return c===b.length-1?null:b[c+1]},_getComposite:function(a){return a.isVirtual?this._nodesInLink(a):[a]},arrangeNodes:function(){var a,b,c,d,e;for(b=0;b<this.layers.length;b++)for(d=this.layers[b],c=0;c<d.length;c++)e=d[c],e.upstreamPriority=e.upstreamLinkCount,e.downstreamPriority=e.downstreamLinkCount;for(var f=2,g=0;f>g;g++){for(a=this.layers.length-1;a>=1;a--)this.layoutLayer(!1,a);for(a=0;a<this.layers.length-1;a++)this.layoutLayer(!0,a)}var h=Number.MAX_VALUE;for(b=0;b<this.layers.length;b++)for(d=this.layers[b],c=0;c<d.length;c++)e=d[c],h=Math.min(h,e.gridPosition);if(0>h)for(b=0;b<this.layers.length;b++)for(d=this.layers[b],c=0;c<d.length;c++)e=d[c],e.gridPosition=e.gridPosition-h},layoutLayer:function(a,b){var c,d;d=a?this.layers[c=b+1]:this.layers[c=b-1];for(var e=[],f=0;f<d.length;f++)e.push(d[f]);e.sort(function(a,b){var c=(a.upstreamPriority+a.downstreamPriority)/2,d=(b.upstreamPriority+b.downstreamPriority)/2;return Math.abs(c-d)<1e-4?0:d>c?1:-1}),n.forEach(e,function(a){var b=a.gridPosition,c=this.calcBaryCenter(a),e=(a.upstreamPriority+a.downstreamPriority)/2;if(!(Math.abs(b-c)<1e-4||Math.abs(b-c)<.2501))if(c>b)for(;c>b&&this.moveRight(a,d,e);)b=a.gridPosition;else for(;b>c&&this.moveLeft(a,d,e);)b=a.gridPosition},this),c>0&&this.calcDownData(c-1),c<this.layers.length-1&&this.calcUpData(c+1)},moveRight:function(a,b,c){var d=n.indexOf(b,a);if(d===b.length-1)return a.gridPosition=a.gridPosition+.5,!0;var e=b[d+1],f=(e.upstreamPriority+e.downstreamPriority)/2;return e.gridPosition>a.gridPosition+1?(a.gridPosition=a.gridPosition+.5,!0):f>c||Math.abs(f-c)<1e-4?!1:this.moveRight(e,b,c)?(a.gridPosition=a.gridPosition+.5,!0):!1},moveLeft:function(a,b,c){var d=n.indexOf(b,a);if(0===d)return a.gridPosition=a.gridPosition-.5,!0;var e=b[d-1],f=(e.upstreamPriority+e.downstreamPriority)/2;return e.gridPosition<a.gridPosition-1?(a.gridPosition=a.gridPosition-.5,!0):f>c||Math.abs(f-c)<1e-4?!1:this.moveLeft(e,b,c)?(a.gridPosition=a.gridPosition-.5,!0):!1},mapVirtualNode:function(a,b){this.nodeToLinkMap.set(a,b),this.linkToNodeMap.containsKey(b)||this.linkToNodeMap.set(b,[]),this.linkToNodeMap.get(b).push(a)},_nodesInLink:function(a){return this.linkToNodeMap.get(this.nodeToLinkMap.get(a))},_dummify:function(){this.linkToNodeMap=new k,this.nodeToLinkMap=new k;var a,b,c,d,e,h,i,j,l=this.graph.links.slice(0);for(j=0;j<l.length;j++){var m=l[j],o=m.source,p=m.target,q=o.layer,r=p.layer,s=o.gridPosition,t=p.gridPosition,u=(t-s)/Math.abs(r-q),v=o;if(q-r>1){for(i=q-1;i>r;i--){for(c=new f,c.x=o.x,c.y=o.y,c.width=o.width/100,c.height=o.height/100,a=this.layers[i],b=(i-r)*u+s,b>a.length&&(b=a.length),s>=this.layers[q].length-1&&t>=this.layers[r].length-1?b=a.length:0===s&&0===t&&(b=0),c.layer=i,c.uBaryCenter=0,c.dBaryCenter=0,c.upstreamLinkCount=0,c.downstreamLinkCount=0,c.gridPosition=b,c.isVirtual=!0,n.insert(a,c,b),e=b+1;e<a.length;e++)d=a[e],d.gridPosition=d.gridPosition+1;h=new g(v,c),h.depthOfDumminess=0,v=c,this.graph.nodes.push(c),this.graph.addLink(h),c.index=this.graph.nodes.length-1,this.mapVirtualNode(c,m)}m.changeSource(v),m.depthOfDumminess=q-r-1}if(-1>q-r){for(i=q+1;r>i;i++){for(c=new f,c.x=o.x,c.y=o.y,c.width=o.width/100,c.height=o.height/100,a=this.layers[i],b=(i-q)*u+s,b>a.length&&(b=a.length),s>=this.layers[q].length-1&&t>=this.layers[r].length-1?b=a.length:0===s&&0===t&&(b=0),c.layer=i,c.uBaryCenter=0,c.dBaryCenter=0,c.upstreamLinkCount=0,c.downstreamLinkCount=0,c.gridPosition=b,c.isVirtual=!0,b&=b,n.insert(a,c,b),e=b+1;e<a.length;e++)d=a[e],d.gridPosition=d.gridPosition+1;h=new g(v,c),h.depthOfDumminess=0,v=c,this.graph.nodes.push(c),this.graph.addLink(h),c.index=this.graph.nodes.length-1,this.mapVirtualNode(c,m)}m.changeSource(v),m.depthOfDumminess=r-q-1}}},_dedummify:function(){for(var a=!0;a;){a=!1;for(var b=0;b<this.graph.links.length;b++){var c=this.graph.links[b];if(0!==c.depthOfDumminess){var d=[];d.unshift({x:c.target.x,y:c.target.y}),d.unshift({x:c.source.x,y:c.source.y});for(var e=c,f=c.depthOfDumminess,g=0;f>g;g++){var h=e.source,i=h.incoming[0];d.unshift({x:i.source.x,y:i.source.y}),e=i}c.changeSource(e.source),c.depthOfDumminess=0,d.length>2?(d.splice(0,1),d.splice(d.length-1),c.points=d):c.points=[],a=!0;break}}}},_optimizeCrossings:function(){for(var a,b=-1,c=3,d=0;0!==b&&!(d++>c);){for(b=0,a=this.layers.length-1;a>=1;a--)b+=this.optimizeLayerCrossings(!1,a);for(a=0;a<this.layers.length-1;a++)b+=this.optimizeLayerCrossings(!0,a)}},calcUpData:function(a){if(0!==a){var b,c,d,e=this.layers[a],f=new l,g=this.layers[a-1];for(b=0;b<g.length;b++)f.add(g[b]);for(b=0;b<e.length;b++){var h=e[b],i=0,j=0;for(c=0;c<h.incoming.length;c++)d=h.incoming[c],f.contains(d.source)&&(j++,i+=d.source.gridPosition);for(c=0;c<h.outgoing.length;c++)d=h.outgoing[c],f.contains(d.target)&&(j++,i+=d.target.gridPosition);j>0?(h.uBaryCenter=i/j,h.upstreamLinkCount=j):(h.uBaryCenter=b,h.upstreamLinkCount=0)}}},calcDownData:function(a){if(a!==this.layers.length-1){var b,c,d,e=this.layers[a],f=new l,g=this.layers[a+1];for(b=0;b<g.length;b++)f.add(g[b]);for(b=0;b<e.length;b++){var h=e[b],i=0,j=0;for(c=0;c<h.incoming.length;c++)d=h.incoming[c],f.contains(d.source)&&(j++,i+=d.source.gridPosition);for(c=0;c<h.outgoing.length;c++)d=h.outgoing[c],f.contains(d.target)&&(j++,i+=d.target.gridPosition);j>0?(h.dBaryCenter=i/j,h.downstreamLinkCount=j):(h.dBaryCenter=b,h.downstreamLinkCount=0)}}},optimizeLayerCrossings:function(a,b){var c,d;d=a?this.layers[c=b+1]:this.layers[c=b-1];var e=d.slice(0);a?this.calcUpData(c):this.calcDownData(c);var f=this;d.sort(function(a,b){var c=f.calcBaryCenter(a),d=f.calcBaryCenter(b);if(Math.abs(c-d)<1e-4)return a.degree()===b.degree()?f.compareByIndex(a,b):a.degree()<b.degree()?1:-1;var e=1e3*(d-c);return e>0?-1:0>e?1:f.compareByIndex(a,b)});var g,h=0;for(g=0;g<d.length;g++)d[g]!==e[g]&&h++;if(h>0){var i=0;for(g=0;g<d.length;g++){var j=d[g];j.gridPosition=i++}}return h},_swapPairs:function(){for(var a=this.options.layeredIterations,b=0;;){if(b++>a)break;for(var c=1>=b%4,d=b%4===1,e=c?0:this.layers.length-1;c?e<=this.layers.length-1:e>=0;e+=c?1:-1){for(var f=this.layers[e],g=!1,h=!0,i=0,j=0;j<f.length-1;j++){var k=0,l=0,m=0;if(h?(0!==e&&(k=this.countLinksCrossingBetweenTwoLayers(e-1,e)),e!==this.layers.length-1&&(l=this.countLinksCrossingBetweenTwoLayers(e,e+1)),c?k*=2:l*=2,m=k+l):m=i,0!==m){var n=f[j],o=f[j+1],p=n.gridPosition,q=o.gridPosition;f[j]=o,f[j+1]=n,n.gridPosition=q,o.gridPosition=p,k=0,0!==e&&(k=this.countLinksCrossingBetweenTwoLayers(e-1,e)),l=0,e!==this.layers.length-1&&(l=this.countLinksCrossingBetweenTwoLayers(e,e+1)),c?k*=2:l*=2;var r=k+l,s=!1;s=d?r>=m:r>m,s?(n=f[j],o=f[j+1],p=n.gridPosition,q=o.gridPosition,f[j]=o,f[j+1]=n,n.gridPosition=q,o.gridPosition=p,i=m,h=!1):(g=!0,h=!0)}}g&&(e!==this.layers.length-1&&this.calcUpData(e+1),0!==e&&this.calcDownData(e-1))}}},countLinksCrossingBetweenTwoLayers:function(a,b){var c,d=0,e=new l,f=this.layers[a];for(c=0;c<f.length;c++)e.add(f[c]);var g=new l,h=this.layers[b];for(c=0;c<h.length;c++)g.add(h[c]);var i=new l,j=[],k=[];e.forEach(function(a){n.addRange(k,a.incoming),n.addRange(k,a.outgoing)});for(var m=0;m<k.length;m++){var o=k[m];e.contains(o.source)&&g.contains(o.target)?(i.add(o),j.push(o)):g.contains(o.source)&&e.contains(o.target)&&j.push(o)}for(var p=0;p<j.length;p++)for(var q=j[p],r=0;r<j.length;r++)if(p!==r){var s,t,u,v,w=j[r];i.contains(q)?(s=q.source,t=q.target):(s=q.target,t=q.source),i.contains(w)?(u=w.source,v=w.target):(u=w.target,v=w.source);var x=s.gridPosition,y=t.gridPosition,z=u.gridPosition,A=v.gridPosition;0>(x-z)*(y-A)&&d++}return d/2},calcBaryCenter:function(a){var b=a.upstreamLinkCount,c=a.downstreamLinkCount,d=a.uBaryCenter,e=a.dBaryCenter;return b>0&&c>0?(d+e)/2:b>0?d:c>0?e:0;

},_gridPositionComparer:function(a,b){return a.gridPosition<b.gridPosition?-1:a.gridPosition>b.gridPosition?1:0},_positionAscendingComparer:function(a,b){return a.k<b.k?-1:a.k>b.k?1:0},_positionDescendingComparer:function(a,b){return a.k<b.k?1:a.k>b.k?-1:0},_firstVirtualNode:function(a){for(var b=0;b<a.length;b++)if(a[b].isVirtual)return b;return-1},compareByIndex:function(a,b){var c=a.index,d=b.index;return d>c?1:c>d?-1:0},intDiv:function(a,b){return(a-a%b)/b},nextVirtualNode:function(a,b){for(var c=b.layerIndex,d=c+1;d<a.length;++d)if(a[d].isVirtual)return a[d];return null}}),z=c.Class.extend({init:function(a,b){if(n.isUndefined(a))throw"No diagram given";this.diagram=a,this.nodeMap=new k,this.linkMap=new k,this.capture(b?b:a)},capture:function(a){var b,c,e,f,g,h,i;if(a instanceof d.Graph){for(f=0;f<a.nodes.length;f++)b=a.nodes[f],e=b.associatedShape,this.nodeMap.set(e.visual.domElement.id,new j(b.x,b.y,b.width,b.height));for(f=0;f<a.links.length;f++)h=a.links[f],g=h.associatedConnection,this.linkMap.set(g.visual.domElement.id,h.points())}else if(a instanceof Array)for(c=a,f=0;f<c.length;f++)b=c[f],e=b.associatedShape,e&&this.nodeMap.set(e.visual.domElement.id,new j(b.x,b.y,b.width,b.height));else if(a.hasOwnProperty("links")&&a.hasOwnProperty("nodes")){for(c=a.nodes,i=a.links,f=0;f<c.length;f++)b=c[f],e=b.associatedShape,e&&this.nodeMap.set(e.visual.domElement.id,new j(b.x,b.y,b.width,b.height));for(f=0;f<i.length;f++)h=i[f],g=h.associatedConnection,g&&this.linkMap.set(g.visual.domElement.id,h.points)}else{var k=this.diagram.shapes,l=this.diagram.connections;for(f=0;f<k.length;f++)e=k[f],this.nodeMap.set(e.visual.domElement.id,e.bounds());for(f=0;f<l.length;f++)g=l[f],this.linkMap.set(g.visual.domElement.id,g.points())}}});h(d,{init:function(a){c.init(a,d.ui)},SpringLayout:v,TreeLayout:x,GraphAdapter:u,LayeredLayout:y,LayoutBase:t,LayoutState:z})}(window.joy.jQuery),function(a,b){function c(a){return a.options.name.toLowerCase()===ba.toLowerCase()}function d(a){var b,d,f,g,h,i,j=ga,k=a.source(),l=a.target(),m=[0,2,3,1,4];if(k instanceof A?b=k:k instanceof Ca&&(c(k)?f=k.shape:(a._resolvedSourceConnector=k,b=k.position())),l instanceof A?d=l:l instanceof Ca&&(c(l)?g=l.shape:(a._resolvedTargetConnector=l,d=l.position())),b)g&&(a._resolvedTargetConnector=e(b,g));else if(f)if(d)a._resolvedSourceConnector=e(d,f);else if(g)for(var n=0;n<f.connectors.length;n++)if(i=5==f.connectors.length?m[n]:n,h=f.connectors[i],!c(h)){var o=h.position(),p=e(o,g),q=Math.round(p.position().distanceTo(o));j>q&&(j=q,a._resolvedSourceConnector=h,a._resolvedTargetConnector=p)}}function e(a,b){for(var d,e=ga,f=b.connectors,g=0;g<f.length;g++){var h=f[g];if(!c(h)){var i=a.distanceTo(h.position());e>i&&(e=i,d=h)}}return d}function f(a,b){var c,d,e=[];for(c=0;c<b.length;c++){d=b[c];for(var f=0;f<a.children.length;f++){var g=a.children[f];if(g==d.domElement){e.push(f);break}}}return e}var g=joy.dataviz,h=g.diagram,i=g.ui,j=joy.ui.Widget,k=joy.Class,l=a.proxy,m=joy.deepExtend,n=joy.data.HierarchicalDataSource,o=h.Canvas,p=h.Group,q=h.Visual,r=h.Rectangle,s=h.Circle,t=h.CompositeTransform,u=h.Rect,v=h.Path,w=h.DeleteShapeUnit,x=h.DeleteConnectionUnit,y=h.TextBlock,z=h.Image,A=h.Point,B=h.Intersect,C=h.ConnectionEditAdorner,D=h.UndoRedoService,E=h.ToolService,F=h.Selector,G=h.ResizingAdorner,H=h.ConnectorsAdorner,I=h.Cursors,J=h.Utils,K=joy.Observable,L=h.Ticker,M=h.ToBackUnit,N=h.ToFrontUnit,O=h.Dictionary,P=h.PolylineRouter,Q=h.CascadingRouter,R=J.isUndefined,S=J.isDefined,T=a.isArray,U=joy.isFunction,V=J.isString,W=".joyDiagram",X="Cascading",Y="Polyline",Z="itemBoundsChange",$="change",_="click",aa="error",ba="Auto",ca="Top",da="Right",ea="Left",fa="Bottom",ga=9007199254740992,ha="select",ia="itemRotate",ja="pan",ka="zoomStart",la="zoomEnd",ma="single",na="none",oa="multiple",pa="rectangle",qa=100,ra=100,sa=20,ta=20,ua=0,va="Yellow",wa="all",xa="absolute",ya="transformed",za="rotated";h.DefaultConnectors=[{name:ca,description:"Top Connector"},{name:da,description:"Right Connector"},{name:fa,description:"Bottom Connector"},{name:ea,Description:"Left Connector"},{name:ba,Description:"Auto Connector",position:function(a){return a.getPosition("center")}}],h.shapeDefaults=function(a){var b={type:pa,path:"",visual:null,x:ua,y:ua,minWidth:sa,minHeight:ta,width:qa,height:ra,hover:{},connectors:h.DefaultConnectors,rotation:{angle:0}};return J.simpleExtend(b,a),b};var Aa=joy.Class.extend({init:function(a){this.pan=a.pan,this.diagram=a.diagram},initState:function(){this.from=this.diagram.pan(),this.to=this.pan},update:function(a){var b=this.diagram;b._storePan(new A(this.from.x+(this.to.x-this.from.x)*a,this.from.y+(this.to.y-this.from.y)*a)),b._transformMainLayer()}}),Ba=K.extend({init:function(a,b){var c=this;K.fn.init.call(c),c.options=m({id:h.randomId()},c.options,a),c.isSelected=!1,c.model=b,c.visual=new p({id:c.options.id}),c._template()},options:{background:"Green",hover:{},cursor:I.grip,content:{align:"center middle",text:""},selectable:!0,serializable:!0,enable:!0},_getCursor:function(a){return this.adorner?this.adorner._getCursor(a):this.options.cursor},visible:function(a){return R(a)?this.visual.visible():void this.visual.visible(a)},bounds:function(){},refresh:function(){this.visual.redraw()},position:function(a){this.options.x=a.x,this.options.y=a.y,this.visual.position(a)},toString:function(){return this.options.id},serialize:function(){var a=m({},{options:this.options});return this.model&&(a.model=this.model.toString()),a},content:function(a){if(a!==b){var c=this.bounds(),d=m({text:"",width:c.width,height:c.height},this.options.content);h.Utils.isString(a)?(this.options.content.text=a,d.text=a):this.options.content=d,this.shapeVisual instanceof y&&(this._contentVisual=this.shapeVisual),!this._contentVisual&&this.options.content.text&&(this._contentVisual=new y,this.visual.append(this._contentVisual)),this._contentVisual&&this._contentVisual.redraw(d)}return this.options.content.text},_hitTest:function(a){var b=this.bounds();return this.visible()&&b.contains(a)&&this.options.enable},_template:function(){var a=this;if(a.options.content.template){var b=a.model||{},c=joy.template(a.options.content.template,{paramName:"item"});a.options.content.text=c(b)}},_canSelect:function(){return this.options.selectable&&this.diagram.options.selectable.type!==na}}),Ca=k.extend({init:function(a,b){this.options=m({},this.options,b),this.connections=[],this.shape=a},options:{width:7,height:7,background:va,hover:{}},position:function(){return this.options.position?this.options.position(this.shape):this.shape.getPosition(this.options.name)},toString:function(){return{shapeId:this.shape.toString(),connector:this.options.name}}});Ca.parse=function(a,b){for(var c=b.split(":"),d=c[0],e=c[1]||ba,f=0;f<a.shapes.length;f++){var g=a.shapes[f];if(g.options.id==d)return g.getConnector(e.trim())}};var Da=Ba.extend({init:function(a,c){var d=this,e=a.diagram;delete a.diagram,Ba.fn.init.call(d,a,c),d.options.diagram=e,a=d.options,d.connectors=[],d.type=a.type,d.shapeVisual=Da.createShapeVisual(d.options),d.visual.append(this.shapeVisual),d.bounds(new u(a.x,a.y,Math.floor(a.width),Math.floor(a.height))),d._createConnectors(),d.parentContainer=null,d.isContainer=!1,d.isCollapsed=!1,d.id=d.visual.domElement.id,d.content(d.content()),d._rotate(),a.hasOwnProperty("layout")&&a.layout!==b&&(d.layout=a.layout.bind(a))},options:h.shapeDefaults(),_createConnectors:function(){var a,b,c=this.options,d=c.connectors.length,e=c.connectorDefaults;for(b=0;d>b;b++)a=new Ca(this,m({},e,c.connectors[b])),this.connectors.push(a)},bounds:function(a){var b,c,d,e;if(e=this.options,a)if(V(a))switch(a){case ya:d=this._transformedBounds();break;case xa:d=this._transformedBounds();var f=this.diagram._pan;d.x+=f.x,d.y+=f.y;break;case za:d=this._rotatedBounds();break;default:d=this._bounds}else b=a.topLeft(),e.x=b.x,e.y=b.y,e.width=Math.max(a.width,e.minWidth),e.height=Math.max(a.height,e.minHeight),this._bounds=new u(e.x,e.y,e.width,e.height),this.visual.position(b),this.redraw({width:e.width,height:e.height}),this.refreshConnections(),this._triggerBoundsChange();else d=this._bounds;return this.shapeVisual._measured||(c=this.shapeVisual._measure(),c&&(this.shapeVisual.options.autoSize?this.bounds(new u(e.x,e.y,c.width,c.height)):this.shapeVisual.redraw())),d},position:function(a){return a?void this.bounds(new u(a.x,a.y,this._bounds.width,this._bounds.height)):this._bounds.topLeft()},clone:function(){var a=this.serialize();a.options.id=h.randomId();var b=new Da(a.options);return b.diagram=this.diagram,b},select:function(a){var b,c,d,e=this.diagram;return R(a)&&(a=!0),this._canSelect()&&this.isSelected!=a?(d=this.diagram.options.selectable.type,b=[],c=[],this.isSelected=a,this.isSelected?(d===ma&&this.diagram.select(!1),e._selectedItems.push(this),b.push(this)):(J.remove(e._selectedItems,this),c.push(this)),e._internalSelection||e._selectionChanged(b,c),!0):void 0},rotate:function(a,c){var d=this.visual.rotate();if(a!==b){var e,f,g=this.bounds(),h=new A(g.width/2,g.height/2);c&&(e=a-d.angle,f=g.center().rotate(c,360-e).minus(h),this._rotationOffset=this._rotationOffset.plus(f.minus(g.topLeft())),this.position(f)),this.visual.rotate(a,h),this.options.rotation.angle=a,this.diagram&&this.diagram._connectorsAdorner&&this.diagram._connectorsAdorner.refresh(),this.refreshConnections(),this.diagram&&this.diagram.trigger(ia,{item:this})}return d},connections:function(a){var b,c,d,e,f,g=[];for(b=0;b<this.connectors.length;b++)for(f=this.connectors[b],e=f.connections,c=0,e;c<e.length;c++)if(d=e[c],"out"==a){var h=d.source();h.shape&&h.shape==this&&g.push(d)}else if("in"==a){var i=d.target();i.shape&&i.shape==this&&g.push(d)}else g.push(d);return g},refreshConnections:function(){a.each(this.connections(),function(){this.refresh()})},getConnector:function(a){var b,c;if(!V(a))return a instanceof A?e(a,this):this.connectors.length?this.connectors[0]:null;for(a=a.toLocaleLowerCase(),b=0;b<this.connectors.length;b++)if(c=this.connectors[b],c.options.name.toLocaleLowerCase()==a)return c},getPosition:function(a){var b=this.bounds(),c=a[0].toLowerCase()+a.slice(1);return U(b[c])?this._transformPoint(b[c]()):b.center()},redraw:function(a){a&&(this.options=m({},this.options,a)),this._contentVisual&&this._contentVisual.redraw({width:this.options.width,height:this.options.height}),this.shapeVisual.redraw(a),a&&a.content&&this.content(a.content)},_triggerBoundsChange:function(){this.diagram&&this.diagram.trigger(Z,{item:this,bounds:this._bounds.clone()})},_transformPoint:function(a){var b=this.rotate(),c=this.bounds(),d=c.topLeft();return b.angle&&a.rotate(b.center().plus(d),360-b.angle),a},_transformedBounds:function(){var a=this.bounds(),b=a.topLeft(),c=a.bottomRight();return u.fromPoints(this.diagram.modelToView(b),this.diagram.modelToView(c))},_rotatedBounds:function(){var a=this.bounds().rotatedBounds(this.rotate().angle),b=a.topLeft(),c=a.bottomRight();return u.fromPoints(b,c)},_rotate:function(){var a=this.options.rotation;a&&a.angle&&this.rotate(a.angle),this._rotationOffset=new A},_hover:function(a){var b=this.options,c=b.hover,d=b.stroke,e=b.background;a&&S(c.stroke)&&(d=m({},d,c.stroke)),a&&S(c.background)&&(e=c.background),this.shapeVisual.redraw({stroke:d,background:e}),this.diagram._showConnectors(this,a)},_hitTest:function(a){if(this.visible()){var b,c=this.bounds(),d=this.rotate().angle;if(a.isEmpty&&!a.isEmpty())return B.rects(a,c,d?d:0);if(b=a.clone().rotate(c.center(),d),c.contains(b))return this}}});Da.createShapeVisual=function(a){function b(a,b,c){if(g.libraries&&g.libraries.length>0)for(var d=0;d<g.libraries.length;d++)for(var e=g.libraries[d],f=0;f<e.length;f++){var h=e[f];if(h.options.name===a&&"external"===h.options.serializationSource)return b.layout=h.options.layout,b.visual=h.options.visual,b.rebuild=h.options.rebuild,h.options.visual(c)}}function c(a,b){switch(a.toLocaleLowerCase()){case"rectangle":return new r(b);case"circle":return new s(b);case"text":return new y(b);case"image":return new z(b);case"svg":return f(b.definition);default:var c=new v(b);return c}}function d(a,b){return b.data=a,new v(b)}function e(a,b,c){return a.call(b,c)}function f(a){var b='<svg xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg">'+a+"</svg>",c=h(b),d=document.importNode(c.childNodes[0].childNodes[0],!0),e=new p;return e.append(new q(d)),e}var g=a.diagram;delete a.diagram;var h,i=m({},a,{x:0,y:0}),j=i.visual,k=i.type;if("undefined"!=typeof window.DOMParser)h=function(a){return(new window.DOMParser).parseFromString(a,"image/svg+xml")};else{if("undefined"==typeof window.ActiveXObject||!new window.ActiveXObject("Microsoft.XMLDOM"))throw new Error("No XML parser found");h=function(a){var b=new window.ActiveXObject("Microsoft.XMLDOM");return b.async="false",b.loadXML(a),b}}return joy.isFunction(j)||"external"!==i.serializationSource?i.path?d(i.path,i):U(j)?e(j,this,i):V(k)?c(i.type.toLocaleLowerCase(),i):new r(i):b(i.name,a,i)};var Ea=Ba.extend({init:function(a,b,c,d){var e=this;Ba.fn.init.call(e,c,d),e._router=new P(this),e.path=new v(e.options),e.path.background(na),e.visual.append(e.path),e._sourcePoint=e._targetPoint=new A,e.source(a),e.target(b),e.content(e.options.content.text),e.definers=[],S(c)&&c.points&&e.points(c.points),e.refresh()},options:{hover:{stroke:{}},startCap:na,endCap:na,points:[],selectable:!0},sourcePoint:function(){return this._resolvedSourceConnector?this._resolvedSourceConnector.position():this._sourcePoint},source:function(a,c){return S(a)&&(c&&this.diagram?this.diagram.undoRedoService.addCompositeItem(new h.ConnectionEditUnit(this,a)):(a!==b&&(this.from=a),null===a?this.sourceConnector&&(this._sourcePoint=this._resolvedSourceConnector.position(),this._clearSourceConnector()):a instanceof Ca?(this.sourceConnector=a,this.sourceConnector.connections.push(this),this.refresh()):a instanceof A?(this._sourcePoint=a,this.sourceConnector&&this._clearSourceConnector(),this.refresh()):a instanceof Da&&(this.sourceConnector=a.getConnector(ba),this.sourceConnector.connections.push(this),this.refresh()))),this.sourceConnector?this.sourceConnector:this._sourcePoint},sourceDefiner:function(a){if(!a)return this._sourceDefiner||(this._sourceDefiner=new h.PathDefiner(this.sourcePoint(),null,null)),this._sourceDefiner;if(!(a instanceof h.PathDefiner))throw"The sourceDefiner needs to be a PathDefiner.";a.left=null,this._sourceDefiner=a,this.source(a.point)},targetPoint:function(){return this._resolvedTargetConnector?this._resolvedTargetConnector.position():this._targetPoint},target:function(a,c){return S(a)&&(c&&this.diagram?this.diagram.undoRedoService.addCompositeItem(new h.ConnectionEditUnit(this,a)):(a!==b&&(this.to=a),null===a?this.targetConnector&&(this._targetPoint=this._resolvedTargetConnector.position(),this._clearTargetConnector()):a instanceof Ca?(this.targetConnector=a,this.targetConnector.connections.push(this),this.refresh()):a instanceof A?(this._targetPoint=a,this.targetConnector&&this._clearTargetConnector(),this.refresh()):a instanceof Da&&(this.targetConnector=a.getConnector(ba),this.targetConnector&&(this.targetConnector.connections.push(this),this.refresh())))),this.targetConnector?this.targetConnector:this._targetPoint},targetDefiner:function(a){if(!a)return this._targetDefiner||(this._targetDefiner=new h.PathDefiner(this.targetPoint(),null,null)),this._targetDefiner;if(!(a instanceof h.PathDefiner))throw"The sourceDefiner needs to be a PathDefiner.";a.right=null,this._targetDefiner=a,this.target(a.point)},content:function(a){var b=Ba.fn.content.call(this,a);return this.refresh(),b},select:function(a){var c,d,e,f=this.diagram;return this._canSelect()&&this.isSelected!==a?(this.isSelected=a,c=[],d=[],e=this.diagram.options.selectable.type,this.isSelected?(e===ma&&this.diagram.select(!1),this.adorner=new C(this,this.options.select),f._adorn(this.adorner,!0),f._selectedItems.push(this),c.push(this)):this.adorner&&(f._adorn(this.adorner,!1),J.remove(f._selectedItems,this),this.adorner=b,d.push(this)),this.refresh(),f._internalSelection||f._selectionChanged(c,d),!0):void 0},bounds:function(a){return!a||V(a)?this._bounds:void(this._bounds=a)},type:function(a){if(!a)return this._type;if(a!==this._type){switch(this._type=a,a.toLowerCase()){case X.toLowerCase():this._router=new Q(this);break;case Y.toLowerCase():this._router=new P(this);break;default:throw"Unsupported connection type."}this.refresh()}},points:function(a){if(!a){var b=[];if(S(this.definers))for(var c=0;c<this.definers.length;c++)b.push(this.definers[c].point);return b}this.definers=[];for(var d=0;d<a.length;d++){var e=a[d];if(e instanceof h.Point)this.definers.push(new h.PathDefiner(e));else{if(!e.hasOwnProperty("x")||!e.hasOwnProperty("y"))throw"A Connection point needs to be a Point or an object with x and y properties.";this.definers.push(new h.PathDefiner(new A(e.x,e.y)))}}},allPoints:function(){var a=[this.sourcePoint()];if(this.definers)for(var b=0;b<this.definers.length;b++)a.push(this.definers[b].point);return a.push(this.targetPoint()),a},refresh:function(){d(this);var a,b,c,e,f=this.sourcePoint(),g=this.targetPoint();this._refreshPath(),a=this._bounds.topLeft(),b=f.minus(a),c=g.minus(a),this._contentVisual&&(e=A.fn.middleOf(b,c),this._contentVisual.position(new A(e.x+a.x,e.y+a.y))),this.adorner&&this.adorner.refresh()},redraw:function(a){this.options=m({},this.options,a),this.content(this.options.content.text),S(this.options.points)&&this.options.points.length>0&&(this.points(this.options.points),this._refreshPath()),this.path.redraw(a)},clone:function(){var a=this.serialize(),b=new Ea(this.from,this.to,a.options);return b.diagram=this.diagram,b},serialize:function(){var a=m({},{options:this.options,from:this.from.toString(),to:this.to.toString()});return this.model&&(a.model=this.model.toString()),a.options.points=this.points(),a},_hitTest:function(a){if(this.visible()){var b=new A(a.x,a.y),c=this.sourcePoint(),d=this.targetPoint();if(a.isEmpty&&!a.isEmpty()&&a.contains(c)&&a.contains(d))return this;if(this._router.hitTest(b))return this}},_hover:function(a){var b=(this.options.stroke||{}).color;a&&S(this.options.hover.stroke.color)&&(b=this.options.hover.stroke.color),this.path.redraw({stroke:{color:b}})},_calcPathData:function(){function a(a){return a.x+" "+a.y}this._router&&this._router.route();for(var b=this.sourcePoint(),c=this.targetPoint(),d="M"+a(b),e=this.points(),f=0;f<e.length;f++){var g=e[f];d+=" L"+a(g)}return d+" L"+a(c)},_refreshPath:function(){R(this.path)||(this._drawPath(this._calcPathData()),this.bounds(this._router.getBounds()))},_drawPath:function(a){this.path.redraw({data:a})},_clearSourceConnector:function(){J.remove(this.sourceConnector.connections,this),this.sourceConnector=b,this._resolvedSourceConnector=b},_clearTargetConnector:function(){J.remove(this.targetConnector.connections,this),this.targetConnector=b,this._resolvedTargetConnector=b}}),Fa=j.extend({init:function(b,c){var d=this;joy.destroy(b),j.fn.init.call(d,b,c),b=d.element,b.empty(),d._initTheme(),d._extendLayoutOptions(d.options),d.element.addClass("k-widget k-diagram").attr("role","diagram");var e=a("<div class='k-canvas-container'></div>").appendTo(b)[0];d.canvas=new o(e),d.options.useScroller&&(d.scrollable=a("<div />").appendTo(d.element).append(d.canvas.element)),this.mainLayer=new p({id:"main-layer"}),this.canvas.append(this.mainLayer),this.adornerLayer=new p({id:"adorner-layer"}),this.canvas.append(this.adornerLayer),this.libraries=[],this.toolService=new E(this),this._attachEvents(),d._initialize(),d._fetchFreshData(),this._resizingAdorner=new G(this,{editable:this.options.editable}),this._connectorsAdorner=new H(this),this._adorn(this._resizingAdorner,!0),this._adorn(this._connectorsAdorner,!0),d.element.on("mousemove"+W,l(d._mouseMove,d)).on("mouseup"+W,l(d._mouseUp,d)).on("dblclick"+W,l(d._doubleClick,d)).on("mousedown"+W,l(d._mouseDown,d)).mousewheel(l(d._wheel,d),{ns:W}).on("keydown"+W,l(d._keydown,d)).on("mouseover"+W,l(d._mouseover,d)).on("mouseout"+W,l(d._mouseout,d)),d.selector=new F(d),d._clipboard=[],d._drop(),d._initEditor(),d._autosizeCanvas(),d.options.layout&&d.layout(d.options.layout),this.pauseMouseHandlers=!1,d._createShapes(),d._createConnections()},options:{name:"Diagram",zoomRate:1.1,dataSource:{},draggable:!0,template:"",autoBind:!0,editable:{rotate:{},resize:{},text:!0},useScroller:!0,tooltip:{enabled:!0,format:"{0}"},copy:{enabled:!0,offsetX:20,offsetY:20},editor:{height:20,margin:10,fontSize:15},selectable:{type:oa,inclusive:!0},snap:{enabled:!0,size:10,angle:10},shapeDefaults:h.shapeDefaults({undoable:!0}),connectionDefaults:{},shapes:[],connections:[]},events:[la,ka,ja,ha,ia,Z,$,_],_mouseover:function(a){a.target._hover&&a.target._hover(!0,a.target._joyElement)},_mouseout:function(a){a.target._hover&&a.target._hover(!1,a.target._joyElement)},_initTheme:function(){var a=this,b=i.themes||{},c=((a.options||{}).theme||"").toLowerCase(),d=(b[c]||{}).diagram;a.options=m({},d,a.options)},_createShapes:function(){var a,b,c=this,d=c.options,e=d.shapes;for(b=0;b<e.length;b++)a=e[b],c.addShape(a)},_createConnections:function(){var a,b,c,d,e=this,f=e.options,g=f.connectionDefaults,h=f.connections;for(d=0;d<h.length;d++)a=h[d],b=e._findConnectionShape(a.from),c=e._findConnectionShape(a.to),e.connect(b,c,m({},g,a))},_findConnectionShape:function(a){var b=this,c=b.getShapeById(a.shapeId);return c.getConnector(a.connector||ba)},destroy:function(){var a=this;j.fn.destroy.call(a),a.clear(),a.element.off(W),a.canvas.destroy(!0),a.canvas=b,a.destroyScroller(),a.options.draggable&&i.DropTarget&&a.element.joyDropTarget("destroy")},destroyScroller:function(){var a=this.scroller;a&&(a.destroy(),a.element.remove(),this.scroller=null)},save:function(){var a,b={};for(b.shapes=[],b.connections=[],a=0;a<this.shapes.length;a++){var c=this.shapes[a];c.options.serializable&&b.shapes.push(c.options)}for(a=0;a<this.connections.length;a++){var d=this.connections[a],e=m({},{from:d.from.toString(),to:d.to.toString()},d.options);b.connections.push(e)}return b},focus:function(){var a=window.scrollX,b=window.scrollY;this.canvas.focus(),window.scrollTo(a,b)},load:function(a){this.clear(),this.setOptions(a),this._createShapes(),this._createConnections()},clear:function(){var a=this;a.dataSource&&a._unbindDataSource(),a.select(!1),a.mainLayer.clear(),a._initialize()},connect:function(a,b,c){var d=m({},this.options.connectionDefaults,c),e=new Ea(a,b,d);return this.addConnection(e)},connected:function(a,b){for(var c=0;c<this.connections.length;c++){var d=this.connections[c];if(d.from==a&&d.to==b)return!0}return!1},addConnection:function(a,c){if(c===b&&(c=!0),c){var d=new h.AddConnectionUnit(a,this);this.undoRedoService.add(d)}else a.diagram=this,this.mainLayer.append(a.visual),this.connections.push(a);return a},addShape:function(a,b){var c,d=this.options.shapeDefaults;return a instanceof Da?(d=m({},d,b),a.redraw(b),c=a):(d=m({},d,a),c=new Da(d)),d.undoable?this.undoRedoService.add(new h.AddShapeUnit(c,this)):(this.shapes.push(c),c.diagram=this,this.mainLayer.append(c.visual)),this.trigger($,{added:[c],removed:[]}),c.redraw(),c.hasOwnProperty("layout")&&c.layout(c),c},remove:function(a,b){var c=T(a);if(R(b)&&(b=!0),b&&this.undoRedoService.begin(),c){a=a.slice(0);for(var d=0;d<a.length;d++)this._removeItem(a[d],b)}else(a instanceof Da||a instanceof Ea)&&this._removeItem(a,b);b&&this.undoRedoService.commit(),this.trigger($,{added:[],removed:c?a:[a]})},undo:function(){this.undoRedoService.undo()},redo:function(){this.undoRedoService.redo()},select:function(a,c){var d,e,f,g,h,i,j;c=m({addToSelection:!1},c);var k=c.addToSelection;if(a===b)return this._selectedItems;if(this._internalSelection=!0,i=[],h=[],!k)for(;this._selectedItems.length>0;)e=this._selectedItems[0],e.select(!1)&&i.push(e);if(J.isBoolean(a))a!==!1&&this.select(wa);else if(a instanceof u)for(g=a,f=this.shapes.concat(this.connections),d=0;d<f.length;d++)e=f[d],g&&!e._hitTest(g)||!e.options.enable||e.select(!0)&&h.push(e);else if(a instanceof Array)for(d=0;d<a.length;d++)e=a[d],e instanceof Ba&&e.select(!0)&&h.push(e);else if(a instanceof Ba)a.select(!0)&&h.push(a);else if(j=a.toString().toLowerCase(),j===na)this.select(!1);else if(j===wa)for(f=this.shapes.concat(this.connections),d=0;d<f.length;d++)e=f[d],e.select(!0)&&h.push(e);(h.length>0||i.length>0)&&this._selectionChanged(h,i),this._internalSelection=!1},toFront:function(a,b){a||(a=this._selectedItems.slice());var c,d=this._getDiagramItems(a);if(R(b)||b){c=f(this.mainLayer.domElement,d.visuals);var e=new N(this,a,c);this.undoRedoService.add(e)}else this.mainLayer.toFront(d.visuals),this._fixOrdering(d,!0)},toBack:function(a,b){a||(a=this._selectedItems.slice());var c,d=this._getDiagramItems(a);if(R(b)||b){c=f(this.mainLayer.domElement,d.visuals);var e=new M(this,a,c);this.undoRedoService.add(e)}else this.mainLayer.toBack(d.visuals),this._fixOrdering(d,!1)},bringIntoView:function(a,b){var c,d=this.viewport();if(b=m({animate:!1,align:"center middle"},b),a instanceof Ba?c=a.bounds(ya):T(a)?c=this.boundingBox(a):a instanceof u&&(c=a.clone()),"none"!==b.align||!d.contains(c.center())){"none"===b.align&&(b.align="center middle");var e=c.clone(),f=new h.RectAlign(d);f.align(c,b.align);var g=c.topLeft().minus(e.topLeft());this.options.useScroller||(g=this.pan().plus(g)),this.pan(g,b.animate)}},alignShapes:function(a){R(a)&&(a="Left");var b,c,d,e=this.select();if(0!==e.length){switch(a.toLowerCase()){case"left":case"top":b=Number.MAX_VALUE;break;case"right":case"bottom":b=Number.MIN_VALUE}for(d=0;d<e.length;d++)if(c=e[d],c instanceof Da)switch(a.toLowerCase()){case"left":b=Math.min(b,c.options.x);break;case"top":b=Math.min(b,c.options.y);break;case"right":b=Math.max(b,c.options.x);break;case"bottom":b=Math.max(b,c.options.y)}var f=[],g=[];for(d=0;d<e.length;d++)if(c=e[d],c instanceof Da)switch(g.push(c),f.push(c.bounds()),a.toLowerCase()){case"left":case"right":c.position(new A(b,c.options.y));break;case"top":case"bottom":c.position(new A(c.options.x,b))}var i=new h.TransformUnit(g,f);this.undoRedoService.add(i,!1)}},zoom:function(a,b){if(a){var c=b?b.location:new h.Point(0,0);if(a=this._zoom=this._getValidZoom(a),!R(c)){c=new h.Point(Math.round(c.x),Math.round(c.y));var d=c.times(a),e=this.modelToView(c),f=e.minus(d);this._storePan(new h.Point(Math.round(f.x),Math.round(f.y)))}b&&(b.zoom=a),this._panTransform(),this._autosizeCanvas(),this._updateAdorners()}return this._zoom},pan:function(a,b){b=b||{animated:!1};var c=b.animated;return a instanceof A&&!a.equals(this._pan)&&(this._animatePan(a,!c),this._storePan(a),this.trigger(ja,{total:a,delta:b.delta}),this._autosizeCanvas(),this._updateAdorners()),this._pan},viewport:function(){var a=this.element;return new u(0,0,a.width(),a.height())},copy:function(){if(this.options.copy.enabled){this._clipboard=[],this._copyOffset=1;for(var a=0;a<this._selectedItems.length;a++){var b=this._selectedItems[a];this._clipboard.push(b)}}},cut:function(){if(this.options.copy.enabled){this._clipboard=[],this._copyOffset=0;for(var a=0;a<this._selectedItems.length;a++){var b=this._selectedItems[a];this._clipboard.push(b)}this.remove(this._clipboard)}},paste:function(){var a,b,c,d,e,f,g;if(this._clipboard.length>0){var h=new O;for(a=this._copyOffset*this.options.copy.offsetX,b=this._copyOffset*this.options.copy.offsetY,this.select(!1),g=0;g<this._clipboard.length;g++)c=this._clipboard[g],c instanceof Ea||(d=c.clone(),h.set(c.id,d.id),this._addItem(d),d.position(new A(c.options.x+a,c.options.y+b)),d.select(!0));for(g=0;g<this._clipboard.length;g++)c=this._clipboard[g],c instanceof Da||(d=c.clone(),c.source()instanceof Ca&&(e=c.source(),h.containsKey(e.shape.id)?(f=this.getShapeById(h.get(e.shape.id)),d.source(f.getConnector(e.options.name))):d.source(new A(c.sourcePoint().x+a,c.sourcePoint().y+b))),c.target()instanceof Ca&&(e=c.target(),h.containsKey(e.shape.id)?(f=this.getShapeById(h.get(e.shape.id)),d.target(f.getConnector(e.options.name))):d.target(new A(c.targetPoint().x+a,c.targetPoint().y+b))),this._addItem(d),d.position(new A(c.options.x+a,c.options.y+b)),d.select(!0));this._copyOffset+=1}},boundingBox:function(a,b){var c,d=u.empty(),e=S(a)?this._getDiagramItems(a):{shapes:this.shapes};if(e.shapes.length>0){var f=e.shapes[0];b===!0&&(d.x-=f._rotationOffset.x,d.y-=f._rotationOffset.y),d=f.bounds(za);for(var g=1;g<e.shapes.length;g++)f=e.shapes[g],c=f.bounds(za),b===!0&&(c.x-=f._rotationOffset.x,c.y-=f._rotationOffset.y),d=d.union(c)}return d},documentToView:function(b){var c=a(this.canvas.element).offset();return new A(b.x-c.left,b.y-c.top)},viewToDocument:function(b){var c=a(this.canvas.element).offset();return new A(b.x+c.left,b.y+c.top)},viewToModel:function(a){return this._transformWithMatrix(a,this._matrixInvert)},modelToView:function(a){return this._transformWithMatrix(a,this._matrix)},modelToLayer:function(a){return this._transformWithMatrix(a,this._layerMatrix)},layerToModel:function(a){return this._transformWithMatrix(a,this._layerMatrixInvert)},documentToModel:function(a){return this.viewToModel(this.documentToView(a))},modelToDocument:function(a){return this.viewToDocument(this.modelToView(a))},_transformWithMatrix:function(a,b){var c=a;if(a instanceof A)b&&(c=b.apply(a));else{var d=this._transformWithMatrix(a.topLeft(),b),e=this._transformWithMatrix(a.bottomRight(),b);c=u.fromPoints(d,e)}return c},setDataSource:function(a){this.options.dataSource=a,this._dataSource(),this.options.autoBind&&this.dataSource.fetch()},layout:function(a){this.isLayouting=!0;var b;R(a)&&(a=this.options.layout),b=R(a)||R(a.type)?"Tree":a.type;var c;switch(b.toLowerCase()){case"tree":c=new h.TreeLayout(this);break;case"layered":c=new h.LayeredLayout(this);break;case"forcedirected":case"force":case"spring":case"springembedder":c=new h.SpringLayout(this);break;default:throw"Layout algorithm '"+b+"' is not supported."}var d=new h.LayoutState(this),e=c.layout(a);if(e){var f=new h.LayoutUndoUnit(d,e,a?a.animate:null);this.undoRedoService.add(f)}this.isLayouting=!1},getShapeById:function(a){var b;return(b=J.first(this.shapes,function(b){return b.visual.domElement.id===a}))?b:b=J.first(this.connections,function(b){return b.visual.domElement.id===a})},editor:function(a,b){var c=this._editor;if(R(a.options.editable)||a.options.editable.text){c.options=m(this.options.editor,b),this._editItem=a,this._showEditor();var d=a.content();c._originalContent=d,c.content(d),c.focus()}return c},_initEditor:function(){this._editor=new h.TextBlockEditor,this._editor.bind("finishEdit",a.proxy(this._finishEditShape,this))},_showEditor:function(){var a=this._editor;a.visible(!0),this.element.context.appendChild(a.domElement),this._positionEditor()},_positionEditor:function(){var b=this._editor,c=b.options,d=a(b.domElement),e=this.modelToView(this._editItem.bounds()),f=function(a){return parseInt(d.css(a),10)},g=new A(f("borderLeftWidth")+f("paddingLeft"),f("borderTopWidth")+f("paddingTop")),h=new A(c.margin,e.height/2-c.height/2).minus(g);b.size(e.width-2*c.margin,c.height),b.position(e.topLeft().plus(h)),d.css({fontSize:c.fontSize})},_extendLayoutOptions:function(a){a.layout&&(a.layout=m(h.LayoutBase.fn.defaultOptions||{},a.layout))},_finishEditShape:function(){var a=this._editor,b=this._editItem;if(b){var c=new h.ContentChangedUndoUnit(b,a._originalContent,a.content());this.undoRedoService.add(c),a.visible(!1)}},_selectionChanged:function(a,b){this.trigger(ha,{selected:a,deselected:b})},_getValidZoom:function(a){return Math.min(Math.max(a,.55),2)},_panTransform:function(a){var b=this,c=a||b._pan;this.scroller?(b.scroller.scrollTo(c.x,c.y),b._zoomMainLayer()):(b._pan=c,b._transformMainLayer())},_animatePan:function(a,b){var c=this;if(b)this._panTransform(a);else if(c.scroller)c.scroller.animatedScrollTo(a.x,a.y),c._zoomMainLayer();else{var d=new L;d.addAdapter(new Aa({pan:a,diagram:this})),d.onStep=function(){c._finishPan()},d.play()}},_finishPan:function(){this.trigger(ja,{total:this._pan,
delta:Number.NaN})},_storePan:function(a){this._pan=a,this._storeViewMatrix()},_zoomMainLayer:function(){var a=this._zoom,b=new t(0,0,a,a);b.render(this.mainLayer.domElement),this._storeLayerMatrix(b),this._storeViewMatrix()},_transformMainLayer:function(){var a=this._pan,b=this._zoom,c=new t(a.x,a.y,b,b);c.render(this.mainLayer.domElement),this._storeLayerMatrix(c),this._storeViewMatrix()},_storeLayerMatrix:function(a){this._layerMatrix=a.toMatrix(),this._layerMatrixInvert=a.invert().toMatrix()},_storeViewMatrix:function(){var a=this._pan,b=this._zoom,c=new t(a.x,a.y,b,b);this._matrix=c.toMatrix(),this._matrixInvert=c.invert().toMatrix()},_toIndex:function(a,b){var c=this._getDiagramItems(a);this.mainLayer.toIndex(c.visuals,b),this._fixOrdering(c,!1)},_drop:function(){var a=this,b=a.options;b.draggable&&i.DropTarget&&this.element.joyDropTarget({drop:function(b){var c,d;if(b.draggable&&b.draggable.hint){c=b.draggable.hint.data("data"),d=b.draggable.hintOffset,d=new A(d.left,d.top);var e=a.documentToModel(d);c.x=e.x,c.y=e.y,a.addShape(c)}}})},_fixOrdering:function(a,b){var c,d,e=b?this.shapes.length-1:0,f=b?this.connections.length-1:0;for(c=0;c<a.shapes.length;c++)d=a.shapes[c],J.remove(this.shapes,d),J.insert(this.shapes,d,e);for(c=0;c<a.cons.length;c++)d=a.cons[c],J.remove(this.connections,d),J.insert(this.connections,d,f)},_getDiagramItems:function(a){var b,c={},d=a;for(c.visuals=[],c.shapes=[],c.cons=[],a?T(a)||(d=[a]):d=this._selectedItems.slice(),b=0;b<d.length;b++){var e=d[b];e instanceof Da?(c.shapes.push(e),c.visuals.push(e.visual)):e instanceof Ea&&(c.cons.push(e),c.visuals.push(e.visual))}return c},_removeItem:function(a,b){a.select(!1),a instanceof Da?this._removeShape(a,b):a instanceof Ea&&this._removeConnection(a,b),b||this.mainLayer.remove(a.visual)},_removeShape:function(a,b){var c,d,e,f=[],g=[];for(this.toolService._removeHover(),b?this.undoRedoService.addCompositeItem(new w(a)):J.remove(this.shapes,a),c=0;c<a.connectors.length;c++){e=a.connectors[c];for(var h=0;h<e.connections.length;h++)d=e.connections[h],d.sourceConnector==e?f.push(d):d.targetConnector==e&&g.push(d)}for(c=0;c<f.length;c++)f[c].source(null,b);for(c=0;c<g.length;c++)g[c].target(null,b)},_removeConnection:function(a,b){a.sourceConnector&&J.remove(a.sourceConnector.connections,a),a.targetConnector&&J.remove(a.targetConnector.connections,a),b?this.undoRedoService.addCompositeItem(new x(a)):J.remove(this.connections,a)},_canRectSelect:function(){var a=this.options.selectable.type;return a===oa},_refreshSource:function(a){function b(a){if(!R(a)){var b=J.first(e._dataMap,function(b){return b.uid===a.uid});if(b)return b.shape;var c=m({},e.options.shapeDefaults,{dataItem:a});return b=new Da(c,a),e.addShape(b),e._dataMap.push({uid:a.uid,shape:b}),b}}function c(a,c){for(var d=0;d<c.length;d++){var f=c[d],g=b(f),h=b(a);if(h&&!e.connected(h,g)){var i=e.connect(h,g);i.type(X)}}}{var d,e=this,f=a.node,g=a.action,h=a.items;e.options}if(!a.field){if("add"===g)c(f,h);else if("remove"===g);else if("itemchange"===g)if(f)h.length&&c(f,h);else for(d=0;d<h.length;d++)b(h[d]);for(d=0;d<h.length;d++)h[d].load()}e.options.layout&&e.layout(e.options.layout)},_mouseDown:function(a){if(!this.pauseMouseHandlers){var b=this._calculatePosition(a);0===a.button&&this.toolService.start(b,this._meta(a))&&a.preventDefault()}},_addItem:function(a){a instanceof Da?this.addShape(a):a instanceof Ea&&this.addConnection(a)},_mouseUp:function(a){if(!this.pauseMouseHandlers){var b=this._calculatePosition(a);0===a.button&&this.toolService.end(b,this._meta(a))&&a.preventDefault()}},_mouseMove:function(a){if(!this.pauseMouseHandlers){var b=this._calculatePosition(a);0===a.button&&this.toolService.move(b,this._meta(a))&&a.preventDefault()}},_doubleClick:function(a){var b=this._calculatePosition(a);0===a.button&&this.toolService.doubleClick(b,this._meta(a))&&a.preventDefault()},_keydown:function(a){this.toolService.keyDown(a.keyCode,this._meta(a))&&a.preventDefault()},_wheel:function(a){var b=this._calculatePosition(a),c=m(this._meta(a),{delta:a.data.delta});this.toolService.wheel(b,c)&&a.preventDefault()},_meta:function(a){return{ctrlKey:a.ctrlKey,metaKey:a.metaKey,altKey:a.altKey}},_calculatePosition:function(a){var c=a.pageX===b?a.originalEvent:a,d=new A(c.pageX,c.pageY),e=this.documentToModel(d);return e},_normalizePointZoom:function(a){return a.times(1/this.zoom())},_initialize:function(){this._zoom=1,this._pan=new A,this.shapes=[],this._selectedItems=[],this.connections=[],this._adorners=[],this._dataMap=[],this.undoRedoService=new D,this.id=h.randomId()},_attachEvents:function(){var b=this;b.scroller&&(b.bind(Z,a.proxy(this._autosizeCanvas,this)),b.bind($,a.proxy(this._autosizeCanvas,this)),b.bind(la,a.proxy(this._autosizeCanvas,this)))},_fetchFreshData:function(){this._dataSource(),this.options.autoBind&&this.dataSource.fetch()},_dataSource:function(){var a=this,b=a.options,c=b.dataSource;c=T(c)?{data:c}:c,c.fields||(c.fields=[{field:"text"},{field:"url"},{field:"spriteCssClass"},{field:"imageUrl"}]),a.dataSource&&a._refreshHandler&&a._unbindDataSource(),a._refreshHandler=l(a._refreshSource,a),a._errorHandler=l(a._error,a),a.dataSource=n.create(c).bind($,a._refreshHandler).bind(aa,a._errorHandler)},_unbindDataSource:function(){var a=this;a.dataSource.unbind($,a._refreshHandler).unbind(aa,a._errorHandler)},_error:function(){},_adorn:function(a,c){c!==b&&a&&(c?(this._adorners.push(a),this.adornerLayer.append(a.visual)):(J.remove(this._adorners,a),this.adornerLayer.remove(a.visual)))},_showConnectors:function(a,b){b?this._connectorsAdorner.show(a):this._connectorsAdorner.destroy()},_autosizeCanvas:function(a){if(this.scroller){var b=(a||{}).sender||this,c=this._editor,d=b.zoom(),e=b.element,f=new u(0,0,e.width(),e.height()),g=b.boundingBox(b.shapes);g.width=(g.width+g.x)*d,g.height=(g.height+g.y)*d,g=g.union(f),b.canvas.size(g),c&&c.visible()&&this._positionEditor()}},_updateAdorners:function(){for(var a=this._adorners,b=0;b<a.length;b++){var c=a[b];c.refreshBounds&&c.refreshBounds(),c.refresh()}},_refresh:function(){var a;for(a=0;a<this.connections.length;a++)this.connections[a].refresh()}});i.plugin(Fa),joy.deepExtend(h,{Shape:Da,Connection:Ea,Connector:Ca})}(window.joy.jQuery);